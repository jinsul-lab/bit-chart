<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>비트 연령별 통계</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg:#f6f6f7; --card:#ffffff; --text:#111827; --muted:#6b7280;
      --border:#e5e7eb; --thead:#f3f4f6; --hover:#f9fafb; --group:#cbd5e1;
    }
    *{box-sizing:border-box}
    body{ margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,'Apple SD Gothic Neo','Noto Sans KR',Arial,sans-serif;}
    header{padding:24px 16px 0; text-align:center;}
    
    /* 로고 색상을 정확히 회색으로 고정 */
    .logo{
      width:170px;
      max-width:70vw;
      height:auto;
      display:block;
      margin:0 auto 10px;
      filter: grayscale(100%) brightness(0.9);
    }

    h1{margin:0 0 6px; font-size:24px; font-weight:800; color:#0f172a}
    p.sub{margin:0; color:var(--muted); font-size:12px}
    .wrap{padding:16px; max-width:1200px; margin:0 auto}
    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px;
      box-shadow:0 2px 6px rgba(0,0,0,.05); margin-top:12px}
    .card-title{margin:0 0 8px; font-weight:700; color:#111827}
    .grid{display:grid; gap:10px; grid-template-columns:1fr 1fr auto}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input[type=file], input[type=text]{
      width:100%; padding:10px; border-radius:10px; border:1px dashed var(--border); background:#fff; color:var(--text);
    }
    .btnrow{display:flex; gap:8px; justify-content:flex-end; align-items:end; flex-wrap:wrap}
    button{
      height:38px; border-radius:10px; border:1px solid var(--border);
      background:radial-gradient(120% 120% at 0% 0%,rgba(34,211,238,.25),rgba(34,211,238,.1));
      color:#0f172a; font-weight:700; cursor:pointer; padding:0 12px;
    }
    button.secondary{background:#fff}
    button:disabled{opacity:.5; cursor:not-allowed}
    .warn{color:#b91c1c; font-weight:700; margin-top:10px}

    table{ width:100%; border-collapse:collapse; table-layout:fixed; font-size:13px; margin-top:10px; border-radius:8px; overflow:hidden; border:1px solid var(--border) }
    th, td{ padding:10px; border:1px solid var(--border); text-align:center; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    th{ background:var(--thead); font-weight:700; color:var(--muted); font-size:11px; text-transform:uppercase; letter-spacing:0.5px; }
    tr:hover{ background:var(--hover) }
    .group-row{ background:var(--group); font-weight:800; text-align:left; padding-left:12px; color:#1e293b }
    .total-row{ background:#e2e8f0; font-weight:800; color:#0f172a }
    .highlight{ background:#fffbeb; font-weight:700; color:#92400e }
    .blue-text{ color:#0ea5e9; font-weight:700 }

    .modal-overlay{ position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); 
      display:none; align-items:center; justify-content:center; z-index:1000; backdrop-filter:blur(2px); }
    .modal-content{ background:#fff; width:95%; max-width:1100px; max-height:90vh; border-radius:16px; 
      padding:20px; display:flex; flex-direction:column; position:relative; box-shadow:0 10px 25px rgba(0,0,0,0.2); }
    .modal-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
    .modal-body{ overflow:auto; flex:1; border:1px solid var(--border); border-radius:8px; }
    .close-btn{ background:none; border:none; font-size:24px; cursor:pointer; color:var(--muted); }
    .filter-tabs{ display:flex; gap:10px; margin-bottom:15px; }
    .tab{ padding:8px 16px; border-radius:8px; cursor:pointer; border:1px solid var(--border); background:#f9fafb; font-size:13px; font-weight:600; }
    .tab.active{ background:#0f172a; color:#fff; border-color:#0f172a; }

    @media print {
      body{ background:#fff }
      .wrap{ padding:0; max-width:100% }
      .card, header, .btnrow, .grid, .modal-overlay{ display:none !important }
      .print-only{ display:block !important }
      table{ font-size:10px; border:1px solid #000 }
      th, td{ border:1px solid #000; padding:4px }
    }
    .print-only{ display:none }
  </style>
</head>
<body>
  <header>
    <img src="jinsul-logo.png" alt="JINSUL" class="logo" />
    <h1>비트 연령별 통계 자동 계산기</h1>
    <p class="sub">진료실별 연령 통계 및 주사·내원 현황 자동 계산 + “주사 1회” 상세 분석</p>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="grid">
        <div>
          <label>접수메모 키워드(선택)</label>
          <label>PT만, 충격파, 주사경과, 독감, 드레싱 등</label>
          <input type="text" id="keywordInput" placeholder="예: PT만" />
        </div>
        <div>
          <label>외래진료실➡️외래환자➡️기간설정➡️검색➡️Excel내려받기</label>
          <label>※ CSV / XLSX / XLS 모두 지원 (CSV는 UTF-8·EUC-KR 자동 인식)</label>
          <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" />
        </div>
        <div class="btnrow">
          <button id="pickBtn" onclick="document.getElementById('fileInput').click()">파일 선택</button>
          <button id="oneshotBtn" class="secondary" disabled>주사 1회자 보기</button>
          <button id="oneshotDlBtn" class="secondary" disabled>1회자 다운로드</button>
          <button id="printBtn" class="secondary" onclick="window.print()">화면 인쇄</button>
        </div>
      </div>
      <div style="margin-top:12px">
        <label>내원경로 파일(선택): 통계 현황 ➡️ 환자별 내원 경로 ➡️ 엑셀</label>
        <input type="file" id="routeInput" accept=".csv,.xlsx,.xls" />
      </div>
      <div id="warning" class="warn"></div>
    </div>

    <div id="resultArea"></div>
  </div>

  <div class="modal-overlay" id="modalOverlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle" style="margin:0; font-size:18px">주사 1회자 리스트</h2>
        <div style="display:flex; gap:8px">
          <button id="modalDlBtn" class="secondary">Excel 다운로드</button>
          <button class="close-btn" id="closeModal">&times;</button>
        </div>
      </div>
      <div class="filter-tabs">
        <div class="tab active" id="modeAllBtn">전체 1회자</div>
        <div class="tab" id="modeNewBtn">신환(90일 내 초진 포함)</div>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <script>
    /* 로직 상태 관리 */
    const state = {
      mainRows: [],
      routeMap: null, // {성명+차트번호: 내원경로}
      oneshotRows: [],
      oneshotNewRows: [],
      oneshotMode: 'all' // 'all' or 'new'
    };

    /* 파일 읽기 (Excel/CSV 지원) */
    async function readExcel(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const sheetName = workbook.SheetNames[0];
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], {defval: ""});
            resolve(json);
          } catch(err) { reject(err); }
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
    }

    /* 날짜 유틸: 오늘 기준 90일 전인지 확인 */
    function isWithin90Days(dateStr) {
      if(!dateStr) return false;
      const firstDate = new Date(dateStr);
      if(isNaN(firstDate)) return false;
      const now = new Date();
      const diff = (now - firstDate) / (1000*60*60*24);
      return diff <= 90;
    }

    /* 메인 파일 처리 */
    document.getElementById('fileInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if(!file) return;
      const warning = document.getElementById('warning');
      warning.innerText = "파일 분석 중...";
      
      try {
        const rawData = await readExcel(file);
        state.mainRows = rawData;
        processData();
        warning.innerText = "";
      } catch(err) {
        console.error(err);
        warning.innerText = "❗ 파일을 읽는 중 오류가 발생했습니다. 올바른 엑셀/CSV 파일인지 확인하세요.";
      }
    });

    /* 내원경로 파일 처리 */
    document.getElementById('routeInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if(!file) return;
      const btn = e.target;
      try {
        const data = await readExcel(file);
        const map = {};
        data.forEach(r => {
          const name = (r['성명'] || r['환자명'] || "").toString().trim();
          const chart = (r['차트번호'] || r['차트'] || "").toString().trim();
          const route = (r['내원경로'] || r['경로'] || "").toString().trim();
          if(name && chart) map[name + chart] = route;
        });
        state.routeMap = map;
        alert('내원경로 매칭 완료! 다시 파일을 선택하거나 결과창을 확인하세요.');
        if(state.mainRows.length > 0) processData();
      } catch(err) {
        console.error(err);
        state.routeMap = null;
        document.getElementById('warning').innerText = '❗ 내원경로 파일 오류';
      }
    });

    function processData() {
      const rows = state.mainRows;
      const keyword = document.getElementById('keywordInput').value.trim();

      // 진료실별 그룹화
      const rooms = {};
      const oneshotRows = [];

      rows.forEach(r => {
        const roomName = r['진료실'] || '미지정';
        const age = parseInt(r['연령']) || 0;
        const memo = (r['접수메모'] || "").toString();
        const injectionCount = parseInt(r['주사']) || 0;
        const visitCount = parseInt(r['내원']) || 0;
        const firstVisit = r['초진일'] || r['최초내원일'] || "";

        // 키워드 필터링 (있을 경우만)
        if(keyword && !memo.includes(keyword)) return;

        if(!rooms[roomName]) {
          rooms[roomName] = {
            name: roomName,
            total: 0,
            ageGroups: { '10대이하':0, '20대':0, '30대':0, '40대':0, '50대':0, '60대':0, '70대이상':0 },
            injectionTotal: 0,
            visitTotal: 0
          };
        }

        const room = rooms[roomName];
        room.total++;
        room.injectionTotal += injectionCount;
        room.visitTotal += visitCount;

        if(age < 20) room.ageGroups['10대이하']++;
        else if(age < 30) room.ageGroups['20대']++;
        else if(age < 40) room.ageGroups['30대']++;
        else if(age < 50) room.ageGroups['40대']++;
        else if(age < 60) room.ageGroups['50대']++;
        else if(age < 70) room.ageGroups['60대']++;
        else room.ageGroups['70대이상']++;

        // 주사 1회자 추출 (주사가 딱 1인 경우)
        if(injectionCount === 1) {
          oneshotRows.push(r);
        }
      });

      state.oneshotRows = oneshotRows;
      state.oneshotNewRows = oneshotRows.filter(r => isWithin90Days(r['초진일'] || r['최초내원일']));

      renderTable(rooms);

      const osBtn = document.getElementById('oneshotBtn');
      const osDlBtn = document.getElementById('oneshotDlBtn');
      if(oneshotRows.length > 0) {
        osBtn.disabled = false;
        osBtn.innerText = `주사 1회자 보기 (${oneshotRows.length}명)`;
        osDlBtn.disabled = false;
      } else {
        osBtn.disabled = true;
        osDlBtn.disabled = true;
      }
    }

    function renderTable(rooms) {
      const area = document.getElementById('resultArea');
      area.innerHTML = "";

      let html = `<div class="card"><h2 class="card-title">진료실별 통계 현황</h2><table>
        <thead>
          <tr>
            <th>진료실</th><th>총인원</th><th>10↓</th><th>20대</th><th>30대</th><th>40대</th><th>50대</th><th>60대</th><th>70↑</th>
            <th class="highlight">주사합</th><th class="highlight">내원합</th>
          </tr>
        </thead><tbody>`;

      let grand = { total:0, age:{'10대이하':0,'20대':0,'30대':0,'40대':0,'50대':0,'60대':0,'70대이상':0}, inj:0, vis:0 };

      Object.values(rooms).forEach(rm => {
        html += `<tr>
          <td class="group-row">${rm.name}</td>
          <td>${rm.total}</td>
          <td>${rm.ageGroups['10대이하']}</td>
          <td>${rm.ageGroups['20대']}</td>
          <td>${rm.ageGroups['30대']}</td>
          <td>${rm.ageGroups['40대']}</td>
          <td>${rm.ageGroups['50대']}</td>
          <td>${rm.ageGroups['60대']}</td>
          <td>${rm.ageGroups['70대이상']}</td>
          <td class="highlight">${rm.injectionTotal}</td>
          <td class="highlight">${rm.visitTotal}</td>
        </tr>`;
        grand.total += rm.total;
        grand.inj += rm.injectionTotal;
        grand.vis += rm.visitTotal;
        Object.keys(rm.ageGroups).forEach(k => grand.age[k] += rm.ageGroups[k]);
      });

      html += `<tr class="total-row">
          <td>전체합계</td>
          <td>${grand.total}</td>
          <td>${grand.age['10대이하']}</td>
          <td>${grand.age['20대']}</td>
          <td>${grand.age['30대']}</td>
          <td>${grand.age['40대']}</td>
          <td>${grand.age['50대']}</td>
          <td>${grand.age['60대']}</td>
          <td>${grand.age['70대이상']}</td>
          <td class="highlight">${grand.inj}</td>
          <td class="highlight">${grand.vis}</td>
        </tr></tbody></table></div>`;
      
      area.innerHTML = html;
    }

    /* 상세 리스트 모달용 가공 (내원경로/전화번호 포함) */
    function withPhone(list) {
      return list.map(r => {
        const name = (r['성명'] || "").toString().trim();
        const chart = (r['차트번호'] || "").toString().trim();
        const route = state.routeMap ? (state.routeMap[name + chart] || "-") : "파일미등록";
        return { ...r, '내원경로': route };
      });
    }

    function showOneshotModal(list, titleSub) {
      const modal = document.getElementById('modalOverlay');
      const body = document.getElementById('modalBody');
      const title = document.getElementById('modalTitle');
      
      title.innerText = `주사 1회자 리스트 (${titleSub} : ${list.length}명)`;
      
      let html = `<table><thead><tr>
        <th>성명</th><th>차트</th><th>연령</th><th>주사</th><th>내원</th><th>초진일</th><th>최종내원</th><th>접수메모</th><th>내원경로</th><th>전화번호</th>
      </tr></thead><tbody>`;
      
      list.forEach(r => {
        html += `<tr>
          <td>${r['성명']||''}</td>
          <td>${r['차트번호']||''}</td>
          <td>${r['연령']||''}</td>
          <td class="blue-text">${r['주사']||''}</td>
          <td>${r['내원']||''}</td>
          <td>${r['초진일']||r['최초내원일']||''}</td>
          <td>${r['최종내원일']||''}</td>
          <td style="text-align:left; font-size:11px">${r['접수메모']||''}</td>
          <td style="color:#059669; font-weight:700">${r['내원경로']||''}</td>
          <td>${r['휴대폰']||r['전화번호']||''}</td>
        </tr>`;
      });
      html += `</tbody></table>`;
      body.innerHTML = html;
      modal.style.display = 'flex';
    }

    function downloadOneshotXLSX(list, mode) {
      if(list.length === 0) return;
      const ws = XLSX.utils.json_to_sheet(list);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "OneshotList");
      const filename = `주사1회자_${mode === 'new' ? '신환' : '전체'}_${new Date().toISOString().slice(0,10)}.xlsx`;
      XLSX.writeFile(wb, filename);
    }

    /* 모달 및 탭 이벤트 */
    document.getElementById('closeModal').onclick = () => document.getElementById('modalOverlay').style.display='none';
    document.getElementById('oneshotBtn').onclick = () => {
      state.oneshotMode = 'all';
      document.getElementById('modeAllBtn').classList.add('active');
      document.getElementById('modeNewBtn').classList.remove('active');
      showOneshotModal(withPhone(state.oneshotRows), '전체');
    };
    document.getElementById('modeAllBtn').onclick = () => {
      state.oneshotMode = 'all';
      document.getElementById('modeAllBtn').classList.add('active');
      document.getElementById('modeNewBtn').classList.remove('active');
      showOneshotModal(withPhone(state.oneshotRows), '전체');
    };
    document.getElementById('modeNewBtn').onclick = () => {
      state.oneshotMode = 'new';
      document.getElementById('modeNewBtn').classList.add('active');
      document.getElementById('modeAllBtn').classList.remove('active');
      showOneshotModal(withPhone(state.oneshotNewRows), '신환(90일)');
    };
    document.getElementById('oneshotDlBtn').onclick = () => {
      const target = state.oneshotMode === 'new' ? state.oneshotNewRows : state.oneshotRows;
      downloadOneshotXLSX(withPhone(target), state.oneshotMode);
    };
    document.getElementById('modalDlBtn').onclick = () => {
      const target = state.oneshotMode === 'new' ? state.oneshotNewRows : state.oneshotRows;
      downloadOneshotXLSX(withPhone(target), state.oneshotMode);
    };

    // 모달 바깥 클릭시 닫기
    window.onclick = (e) => {
      if(e.target == document.getElementById('modalOverlay')) document.getElementById('modalOverlay').style.display='none';
    }
  </script>
</body>
</html>
