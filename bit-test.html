<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>비트 연령별 통계 + 1회자 상세</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg:#f6f6f7; --card:#ffffff; --text:#111827; --muted:#6b7280;
      --border:#e5e7eb; --thead:#f3f4f6; --hover:#f9fafb; --group:#cbd5e1;
    }
    *{box-sizing:border-box}
    body{ margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,'Apple SD Gothic Neo','Noto Sans KR',Arial,sans-serif;}
    
    /* 상단 헤더 로고 스타일 */
    header{padding:24px 16px 0; text-align:center;}
    header .logo{
      width:170px; max-width:70vw; height:auto; display:block; margin:0 auto 10px;
      filter: grayscale(1) saturate(0) brightness(.45) contrast(1.15);
    }

    /* 배경 워터마크 로고 설정 */
    .wm {
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      pointer-events:none; z-index:0;
    }
    .wm img {
      width: min(760px, 78vw); /* 워터마크 크기 */
      opacity: .075; /* 워터마크 투명도 */
      user-select:none;
      filter: grayscale(1) saturate(0) brightness(.65) contrast(1.05);
    }
    
    /* 컨텐츠 레이어를 워터마크 위로 설정 */
    body > *{ position:relative; z-index:1; }

    h1{margin:0 0 6px; font-size:24px; font-weight:800; color:#0f172a}
    p.sub{margin:0; color:var(--muted); font-size:12px}
    .wrap{padding:16px; max-width:1200px; margin:0 auto}
    
    /* 메인 카드 및 표 투명화 (워터마크 비침 효과) */
    .card {
      background: rgba(255,255,255, 0.15) !important; 
      backdrop-filter: blur(5px); /* 배경을 살짝 흐리게 하여 가독성 확보 */
      border: 1px solid var(--border); border-radius:14px; padding:14px;
      box-shadow: 0 2px 6px rgba(0,0,0,.05); margin-top:12px;
    }
    
    .card-title{margin:0 0 8px; font-weight:700; color:#111827}
    .grid{display:grid; gap:10px; grid-template-columns:1fr 1fr auto}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input[type=file], input[type=text]{
      width:100%; padding:10px; border-radius:10px; border:1px dashed var(--border); background: rgba(255,255,255, 0.5); color:var(--text);
    }
    
    .btnrow{display:flex; gap:8px; justify-content:flex-end; align-items:end; flex-wrap:wrap}
    button{
      height:38px; border-radius:10px; border:1px solid var(--border);
      background:radial-gradient(120% 120% at 0% 0%,rgba(34,211,238,.25),rgba(34,211,238,.1));
      color:#0f172a; font-weight:700; cursor:pointer; padding:0 12px;
    }
    button.secondary{background:#fff}
    button:disabled{opacity:.3; cursor:not-allowed}
    .warn{color:#b91c1c; font-weight:700; margin-top:10px}

    table{ 
      width:100%; border-collapse:collapse; table-layout:fixed;
      background: rgba(255,255,255, 0.1) !important; 
      border:1px solid var(--border); border-radius:12px; overflow:hidden;
    }
    th, td{
      padding:10px 8px; text-align:center; word-break:keep-all; white-space:normal;
      border-bottom:1px solid var(--border); font-size:12px;
    }
    th{position:sticky; top:0; z-index:1; background:var(--thead); color:#0f172a}
    tbody tr:hover td{background: rgba(14,165,233, 0.05);}
    
    /* modal (팝업창은 가독성을 위해 완전 불투명 처리) */
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; padding:16px; z-index:50}
    .modal{
      background: #ffffff !important; /* 팝업창 배경은 흰색 고정 */
      opacity: 1 !important;         /* 투명도 없음 */
      border:1px solid var(--border); border-radius:14px; width:min(1100px, 100%); max-height:85vh; overflow:auto; box-shadow:0 10px 40px rgba(0,0,0,.2); 
    }
    .modal table { background: #fff !important; } /* 팝업 내 표도 불투명 */
    .modal th, .modal td { opacity: 1 !important; color: #111827 !important; }

    .modal-header{display:flex; justify-content:space-between; align-items:center; padding:14px 14px 10px; border-bottom:1px solid var(--border)}
    .modal-title{font-weight:800}
    .modal-body{padding:12px 14px 14px}
    .modal-actions{display:flex; gap:8px; flex-wrap:wrap}
    .pill{display:inline-block; font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); color:var(--muted)}
    .mode-active{border-color:#0ea5e9; box-shadow:0 0 0 2px rgba(14,165,233,.15) inset}

    @media (max-width:899px){
      .grid{grid-template-columns:1fr}
      th,td{font-size:11px}
      .btnrow{justify-content:flex-start}
    }
  </style>
</head>
<body>
  <div class="wm" aria-hidden="true"><img src="jinsul-logo.png" alt=""></div>

  <header>
    <img src="jinsul-logo.png" alt="JINSUL" class="logo" />
    <h1>비트 연령별 통계 자동 계산기</h1>
    <p class="sub">진료실별 연령 통계 및 주사·내원 현황 자동 계산 + “주사 1회” 상세 분석</p>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="grid">
        <div>
          <label>접수메모 키워드(선택)</label>
          <label>PT만, 충격파, 주사경과, 독감, 드레싱 등</label>
          <input type="text" id="keywordInput" placeholder="예: PT만" />
        </div>
        <div>
          <label>외래진료실➡️외래환자➡️기간설정➡️검색➡️Excel내려받기</label>
          <label>※ CSV / XLSX / XLS 모두 지원</label>
          <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" />
        </div>
        <div class="btnrow">
          <button id="pickBtn" onclick="document.getElementById('fileInput').click()">파일 선택</button>
          <button id="oneshotBtn" class="secondary" disabled>주사 1회자 보기</button>
          <button id="oneshotDlBtn" class="secondary" disabled>1회자 다운로드</button>
          <button id="printBtn" class="secondary" onclick="window.print()">인쇄</button>
        </div>
      </div>

      <div style="margin-top:10px; display:grid; gap:10px; grid-template-columns: 1fr 1fr auto;">
        <div style="grid-column: 1 / span 2;">
          <label>통계➡️인원통계➡️내원경로통계➡️집계➡️파일로 내려받기</label>
          <label>※ 내원경로 파일 업로드 (환자 휴대폰 번호 매칭용)</label>
          <input type="file" id="routeFileInput" accept=".xls,.xlsx,.csv" />
        </div>
        <div class="btnrow" style="justify-content:flex-end">
          <button id="routeStatusBtn" class="secondary" disabled>내원경로: 미업로드</button>
        </div>
      </div>
      <p style="color:var(--muted);font-size:12px;margin:8px 0 0">⚠️ 모든 데이터는 브라우저 내에서만 처리됩니다.</p>
    </div>

    <div class="card table-card">
      <h3 class="card-title">요약 통계 (전체 / 각 진료실)</h3>
      <div id="summaryOutput"></div>
    </div>

    <div class="card table-card">
      <h3 class="card-title">연령대별 통계 (진료실별)</h3>
      <div id="output"></div>
      <div id="warning" class="warn"></div>
    </div>
  </div>

  <div id="oneshotModal" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modal-header">
        <div>
          <div class="modal-title">주사 1회자 목록</div>
          <div class="pill">기준: 기간 내 “마취(주사) 칸에 ●”가 정확히 1번인 차트</div>
        </div>
        <div class="modal-actions">
          <button class="secondary" id="modeAllBtn">전체 1회</button>
          <button class="secondary" id="modeNewBtn">신환 1회</button>
          <button class="secondary" id="modalDlBtn">다운로드(xlsx)</button>
          <button class="secondary" id="modalCloseBtn">닫기</button>
        </div>
      </div>
      <div class="modal-body">
        <div id="oneshotMeta" style="margin-bottom:10px;color:var(--muted);font-size:12px"></div>
        <div id="oneshotTable"></div>
      </div>
    </div>
  </div>

<script>
  /* [이하 로직은 기존과 동일하되 가독성을 위해 핵심 유지] */
  const AGE_ORDER = ["0~10대","20대","30대","40대","50대","60대","70대이상","전체"];
  const state = { df:null, col:null, oneshotRows:[], oneshotNewRows:[], oneshotMode:'all', routeMap:null };

  function pad2(n){ return String(n).padStart(2,'0'); }
  function normalizeVisitDate(v){
    if(v==null) return "";
    if(Object.prototype.toString.call(v)==='[object Date]' && !isNaN(v)){
      return `${v.getFullYear()}-${pad2(v.getMonth()+1)}-${pad2(v.getDate())}`;
    }
    if(typeof v === 'number' && isFinite(v)){
      const epoch = new Date(Date.UTC(1899,11,30));
      const d = new Date(epoch.getTime() + Math.round(v)*24*60*60*1000);
      return `${d.getUTCFullYear()}-${pad2(d.getUTCMonth()+1)}-${pad2(d.getUTCDate())}`;
    }
    let s = String(v).trim();
    let m = s.match(/^(\d{4})(\d{2})(\d{2})/);
    if(m) return `${m[1]}-${m[2]}-${m[3]}`;
    let m2 = s.match(/^(\d{4})[.\/-](\d{1,2})[.\/-](\d{1,2})/);
    if(m2) return `${m2[1]}-${pad2(m2[2])}-${pad2(m2[3])}`;
    return s;
  }

  function normHeader(h){ return String(h||"").replace(/[\s\u00A0\u200B-\u200D\uFEFF]/g,'').toLowerCase(); }
  function formatCell(v){
      if(v===null||v===undefined) return "-";
      const s=String(v).trim();
      if(s===""||s==="0"||s==="0.0"||s==="0%"||/^nan/i.test(s)) return "-";
      return s;
  }

  function toSexAge(ageStr){
      const t = String(ageStr||"").trim();
      let m = t.match(/^([MF])\s*\/\s*(\d+)\s*세/i);
      if(!m) m = t.match(/^([MF])\/(\d+)\s*세/i);
      if(m) return `${(m[1].toUpperCase()==="M") ? "남" : "여"} ${m[2]}세`;
      return t;
  }

  function extractInjOnceList(df, col){
      if(!col || !col['차트'] || !col['마취']) return [];
      const cnt = {}; const nameBy = {}; const sexAgeBy = {}; const roomBy = {};
      const injDateBy = {}; const injMemoBy = {}; const firstDateBy = {};
      const lastDateBy = {}; const lastMemoBy = {}; const visitDatesBy = {};
  
      const nameCol = col['이름'] || col['수진자명'] || col['환자명'] || col['성명'] || null;
      const memoCol = col['메모'] || null;
      const ageCol = col['연령'] || null;
      const deptCol = col['과'] || null;
      const dateCol = col['내원일'] || null;
  
      const esc = (s)=>String(s??'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
  
      df.forEach(r=>{
        const id = (r[col['차트']] ?? '').toString().trim();
        if(!id) return;
        const inj = (r[col['마취']]||'').toString().includes('●');
        if(inj) cnt[id] = (cnt[id]||0) + 1;
        if(nameCol && !nameBy[id]) nameBy[id]=(r[nameCol]||'').toString().trim();
        if(ageCol && !sexAgeBy[id]) sexAgeBy[id]=toSexAge((r[ageCol]||'').toString().trim());
        if(deptCol && !roomBy[id]) roomBy[id]=(r[deptCol]||'').toString().trim();
        const dv = dateCol ? normalizeVisitDate(r[dateCol]) : "";
        if(dv){
          if(!firstDateBy[id] || dv < firstDateBy[id]) firstDateBy[id]=dv;
          if(!lastDateBy[id] || dv > lastDateBy[id]) lastDateBy[id]=dv;
          if(!visitDatesBy[id]) visitDatesBy[id] = new Set();
          visitDatesBy[id].add(dv);
          if(memoCol && dv === lastDateBy[id]) lastMemoBy[id]=(r[memoCol]||'').toString().trim();
          if(inj){
            injDateBy[id]=dv;
            if(memoCol) injMemoBy[id]=(r[memoCol]||'').toString().trim();
          }
        }
      });
  
      const out=[];
      Object.keys(cnt).forEach(id=>{
        if(cnt[id]===1){
          const vcount = visitDatesBy[id] ? visitDatesBy[id].size : 0;
          out.push({
            "차트번호": id, "환자명": nameBy[id] || "", "진료실": roomBy[id] || "", "성별/나이": sexAgeBy[id] || "",
            "최초 내원": firstDateBy[id] || "", "주사 내원": injDateBy[id] || "", "최종 내원": lastDateBy[id] || "",
            "내원 횟수": vcount, "주사일 메모": esc(injMemoBy[id]), "최종 내원 메모": esc(lastMemoBy[id]), "휴대폰": ""
          });
        }
      });
      return out.sort((a,b)=>a.차트번호.localeCompare(b.차트번호));
  }

  function parseData(data, keyword){
    const headerIdx = data.findIndex(row => row.some(c => /초\s*\/?\s*재|차트|진료/.test(String(c))));
    if(headerIdx===-1) return alert('헤더를 찾을 수 없습니다.');
    const headers=data[headerIdx].map(h=>String(h).trim());
    const df=data.slice(headerIdx+1).filter(r=>r.length>1).map(row=>Object.fromEntries(headers.map((h,i)=>[h, row[i] ?? ""])));
    const col={};
    headers.forEach(h=>{
      const l = normHeader(h);
      if(l.includes("초") && l.includes("재")) col['초재']=h;
      else if(l.includes("차트") || l.includes("id")) col['차트']=h;
      else if(l.includes("과") || l.includes("진료실")) col['과']=h;
      else if(l.includes("마취")) col['마취']=h;
      else if(l.includes("메모")) col['메모']=h;
      else if(l.includes("성명") || l.includes("환자")) col['이름']=h;
      else if(l.includes("연령") || l.includes("나이")) col['연령']=h;
      else if(l.includes("내원일")) col['내원일']=h;
    });

    const stats = [];
    const makeStat = (rows, label, ageGroup) => {
        const firsts = rows.filter(r=>["신환","90일초진"].includes(r[col['초재']]));
        const firstIds = [...new Set(firsts.map(r=>r[col['차트']]))];
        const injs = firsts.filter(r=>(r[col['마취']]||'').includes('●'));
        stats.push({ "구분": label, "연령대": ageGroup, "초진": firstIds.length, "초진주사": injs.length, "초진 주사처방률": `${firstIds.length ? Math.round((injs.length/firstIds.length)*100) : 0}%` });
    };

    makeStat(df, "전체", "전체");
    renderSummaryTable(stats);
    
    state.df=df; state.col=col; 
    state.oneshotRows=extractInjOnceList(df, col);
    state.oneshotNewRows=state.oneshotRows.filter(r=>{
        const row = df.find(d=>d[col['차트']]==r.차트번호 && ["신환","90일초진"].includes(d[col['초재']]));
        return !!row;
    });
    document.getElementById('oneshotBtn').disabled=false;
    document.getElementById('oneshotDlBtn').disabled=false;
  }

  function renderSummaryTable(rows){
    const cols=["구분","연령대","초진","초진주사","초진 주사처방률"];
    let html='<table><thead><tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'</tr></thead><tbody>';
    rows.forEach(r=> html+='<tr>'+cols.map(c=>`<td>${r[c]}</td>`).join('')+'</tr>');
    document.getElementById('summaryOutput').innerHTML=html+'</tbody></table>';
  }

  /* [파일 이벤트 및 기타] */
  document.getElementById('fileInput').addEventListener('change', async (e)=>{
    const file=e.target.files[0]; if(!file) return;
    const buf=await file.arrayBuffer();
    const wb=XLSX.read(buf,{type:'array'});
    const data=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1});
    parseData(data, document.getElementById('keywordInput').value);
  });

  document.getElementById('oneshotBtn').onclick=()=> showOneshotModal(state.oneshotRows, '전체');
  document.getElementById('modalCloseBtn').onclick=()=> document.getElementById('oneshotModal').style.display='none';

  function showOneshotModal(list, label){
    const box=document.getElementById('oneshotTable');
    const cols=["차트번호","환자명","최초 내원","주사 내원","내원 횟수","진료실","주사일 메모"];
    let html='<table><thead><tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'</tr></thead><tbody>';
    list.forEach(r=> html+='<tr>'+cols.map(c=>`<td>${formatCell(r[c])}</td>`).join('')+'</tr>');
    box.innerHTML=html+'</tbody></table>';
    document.getElementById('oneshotModal').style.display='flex';
  }
</script>
</body>
</html>
