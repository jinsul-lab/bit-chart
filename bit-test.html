<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>비트 연령별 통계</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  :root{
    --bg:#f6f6f7;        /* 밝은 회색 배경 */
    --card:#ffffff;      /* 카드/테이블 배경 */
    --text:#111827;      /* 본문 텍스트 */
    --muted:#6b7280;     /* 설명/보조 텍스트 */
    --border:#e5e7eb;    /* 표 기본 테두리 */
    --thead:#f3f4f6;     /* 테이블 헤더 배경 */
    --hover:#f9fafb;     /* 행 호버 배경 */
    --group:#cbd5e1;     /* 그룹(진료실) 구분선 */
  }

  *{box-sizing:border-box}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,'Apple SD Gothic Neo','Noto Sans KR',Arial,sans-serif;
    padding:20px; max-width:1200px; margin-inline:auto;
  }

  h1{margin:6px 0 14px; color:#0f172a; font-size:22px}
  .input-section{margin:16px 0 12px}
  .input-section label{color:var(--muted); font-size:13px}

  /* 입력 */
  input[type="text"]{
    width:200px; margin-top:6px; padding:8px 10px;
    border:1px solid var(--border); border-radius:10px; background:#fff; color:var(--text);
  }
  input[type="file"]{
    margin-top:8px; padding:10px; width:100%;
    border:1px dashed var(--border); border-radius:10px; background:#fff; color:var(--text);
  }

  /* 카드 느낌의 컨테이너(선택) */
  .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; box-shadow:0 2px 6px rgba(0,0,0,.05); margin-top:12px}

  /* 표 */
  table{
    width:100%; border-collapse:collapse; table-layout:fixed;
    margin-top:18px; background:var(--card); border:1px solid var(--border);
    border-radius:12px; overflow:hidden;
  }
  th, td{
    padding:10px 8px; text-align:center; word-break:keep-all; white-space:normal;
    border-bottom:1px solid var(--border);
    font-size:12px;
  }
  th{
    position:sticky; top:0; z-index:1;
    background:var(--thead); color:#0f172a;
  }
  tbody tr:hover td{background:var(--hover)}

  /* ✅ 진료실별 색상 제거 (기존 room1~room5, whole 클래스 무력화) */
  tbody tr.whole,
  tbody tr.room1,
  tbody tr.room2,
  tbody tr.room3,
  tbody tr.room4,
  tbody tr.room5{
    background:transparent !important;
  }

  /* ✅ 룸(진료실) 바뀔 때 그룹 구분선 넣기 (rowspan 셀을 가진 첫 행이 그룹 시작) */
  /* 대부분 브라우저에서 동작하는 안전한 방식 */
  tbody td[rowspan]{
    border-top:3px solid var(--group) !important;  /* 그룹 시작 구분선 */
  }
  /* 첫 그룹의 맨 위만 너무 두껍지 않도록 조정(선택 사항) */
  tbody tr:first-child td[rowspan]{
    border-top:1px solid var(--border) !important;
  }

  /* 최신 브라우저에서는 :has로 전체 행에 구분선 적용(선택/보강) */
  @supports(selector(tbody tr:has(td[rowspan]))){
    tbody tr:has(td[rowspan]) td{
      border-top:3px solid var(--group) !important;
    }
    tbody tr:first-child:has(td[rowspan]) td{
      border-top:1px solid var(--border) !important;
    }
  }

  /* 경고문 */
  .warn{color:#b91c1c; font-weight:700; margin-top:10px}

  /* 반응형 */
  @media (max-width:899px){
    th,td{font-size:11px}
  }
</style>


</head>
<body>
  <h1>비트 연령별 통계 자동 계산기</h1>
  <div class="input-section">
    <label>✔️ 특정 키워드(예: PT만)를 입력하세요:</label><br>
    <input type="text" id="keywordInput" placeholder="예: PT만" style="width: 200px; margin-top: 5px;" />
  </div>
  <input type="file" id="fileInput" accept=".xlsx,.csv" />
  <div id="output"></div>
  <div id="warning" class="warn"></div>

  <script>
    const AGE_ORDER = ["0~10대", "20대", "30대", "40대", "50대~64세", "65세이상", "전체"];

    function getAgeGroup(raw) {
      if (!raw || typeof raw !== 'string') return "전체";
      const match = raw.match(/(\d{1,3})세/);
      const age = match ? parseInt(match[1]) : NaN;
      if (isNaN(age)) return "전체";
      if (age <= 19) return "0~10대";
      if (age <= 29) return "20대";
      if (age <= 39) return "30대";
      if (age <= 49) return "40대";
      if (age <= 64) return "50대~64세";
      return "65세이상";
    }

    function sortResult(a, b) {
      if (a["구분"] !== b["구분"]) return a["구분"].localeCompare(b["구분"]);
      return AGE_ORDER.indexOf(a["연령대"]) - AGE_ORDER.indexOf(b["연령대"]);
    }


    function formatCell(v) {
  if (v === null || v === undefined) return "-";
  const s = String(v).trim();
  if (s === "" || s === "0" || s === "0.0" || s === "0%") return "-";
  if (/^nan/i.test(s) || /^nan%$/i.test(s)) return "-";
  // 숫자형 0도 하이픈
  if (!isNaN(Number(s)) && Number(s) === 0) return "-";
  return s;
}

    
    function renderTable(result) {
      result.sort(sortResult);
      const keys = Object.keys(result[0] || {}).filter(k => k !== '구분' && k !== '연령대');
      if (keys.length === 0) {
        document.getElementById('warning').innerText = '❗ 통계 데이터를 생성할 수 없습니다. 열 이름을 확인하세요.';
        return;
      }

      let html = '<table><thead><tr><th>구분</th><th>연령대</th>' + keys.map(k => `<th>${k}</th>`).join('') + '</tr></thead><tbody>';
      let prevGroup = null;
      let groupRows = {};
      result.forEach(row => {
        groupRows[row["구분"]] = (groupRows[row["구분"]] || 0) + 1;
      });

      result.forEach(row => {
        const className = row["구분"].includes("전체") ? "whole" :
                          row["구분"].includes("1진료실") ? "room1" :
                          row["구분"].includes("2진료실") ? "room2" :
                          row["구분"].includes("3진료실") ? "room3" :
                          row["구분"].includes("4진료실") ? "room4" :
                          row["구분"].includes("5진료실") ? "room5" : "";

        html += `<tr class="${className}">`;
        if (row["구분"] !== prevGroup) {
          html += `<td rowspan="${groupRows[row["구분"]]}">${row["구분"]}</td>`;
          prevGroup = row["구분"];
        }
        html += `<td>${row["연령대"]}</td>` 
      + keys.map(k => `<td>${formatCell(row[k])}</td>`).join('') 
      + '</tr>';

      });

      html += '</tbody></table>';
      document.getElementById('output').innerHTML = html;
    }

    document.getElementById('fileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      const keyword = document.getElementById('keywordInput').value.trim().toLowerCase();
      const reader = new FileReader();
      const isCSV = file.name.endsWith('.csv');

      reader.onload = function(evt) {
        let rawData = [];
        if (isCSV) {
          const csv = evt.target.result;
          const rows = csv.split(/\r?\n/).map(row => row.split(','));
          rawData = rows;
          parseData(rawData, keyword);
        } else {
          const data = new Uint8Array(evt.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          workbook.SheetNames.forEach(sheet => {
            const rows = XLSX.utils.sheet_to_json(workbook.Sheets[sheet], { header: 1, defval: "" });
            rawData = rawData.concat(rows);
          });
          parseData(rawData, keyword);
        }
      };
      if (isCSV) reader.readAsText(file);
      else reader.readAsArrayBuffer(file);
    });

    function parseData(data, keyword) {
      const headerIdx = data.findIndex(row => row.join('').includes("초/재") || row.join('').includes("챠트") || row.join('').includes("진료과"));
      if (headerIdx === -1) {
        document.getElementById('warning').innerText = '❗ 유효한 헤더를 찾을 수 없습니다.';
        return;
      }

      const headers = data[headerIdx];
      const body = data.slice(headerIdx + 1).filter(r => r.length > 1);
      const df = body.map(row => Object.fromEntries(headers.map((h, i) => [h.trim(), row[i] || ""])));

      const result = [];
      const 재진조건 = ["재진", "물리치료내원", "진찰료 산정안함"];

      const col = {};
      headers.forEach(h => {
        const l = h.toLowerCase();
        if (l.includes("초") && l.includes("재")) col['초재'] = h;
        else if (l.includes("차트") || l.includes("챠트") || l.includes("id")) col['차트'] = h;
        else if (l.includes("진료") && l.includes("과") || l.includes("과목")) col['과'] = h;
        else if (l.includes("마취")) col['마취'] = h;
        else if (l.includes("메모")) col['메모'] = h;
        else if (l.includes("나이") || l.includes("연령") || l.includes("생년") || l.includes("s/a")) col['연령'] = h;
      });

      const makeStat = (rows, label, ageGroup = "전체") => {
        const 초진 = rows.filter(r => ["신환", "90일초진"].includes(r[col['초재']]));
        const 초진차트 = [...new Set(초진.map(r => r[col['차트']]))];
        const 재진 = rows.filter(r => 재진조건.includes(r[col['초재']])).length;
        const 총 = rows.length;
        const 주사 = 초진.filter(r => (r[col['마취']] || '').includes('●'));

        const 주사차트 = [...new Set(주사.map(r => r[col['차트']]))];
        const 주사기록 = rows.filter(r => 주사차트.includes(r[col['차트']]));

        const 주사횟수 = {}, 내원횟수 = {};
        주사기록.forEach(r => {
          const id = r[col['차트']];
          if ((r[col['마취']] || '').includes('●')) 주사횟수[id] = (주사횟수[id] || 0) + 1;
          내원횟수[id] = (내원횟수[id] || 0) + 1;
        });

        const 평균주사 = Object.keys(주사횟수).length ? (Object.values(주사횟수).reduce((a,b)=>a+b,0)/Object.keys(주사횟수).length).toFixed(1) : 0;
        const 평균내원 = Object.keys(내원횟수).length ? (Object.values(내원횟수).reduce((a,b)=>a+b,0)/Object.keys(내원횟수).length).toFixed(1) : 0;

        const 초진기록 = rows.filter(r => 초진차트.includes(r[col['차트']]));
        const 초진내원 = {};
        초진기록.forEach(r => {
          const id = r[col['차트']];
          초진내원[id] = (초진내원[id] || 0) + 1;
        });
        const 평균초진내원 = Object.keys(초진내원).length ? (Object.values(초진내원).reduce((a,b)=>a+b,0)/Object.keys(초진내원).length).toFixed(1) : 0;
        const 재내원율 = Object.values(초진내원).filter(v => v >= 2).length;

        const 내원비율 = (n) => Math.round((Object.values(초진내원).filter(v => v === n).length / Object.keys(초진내원).length) * 100);
        const 내원5이상 = Math.round((Object.values(초진내원).filter(v => v >= 5).length / Object.keys(초진내원).length) * 100);

        const 키워드수 = col['메모'] && keyword ? rows.filter(r => (r[col['메모']] || '').toLowerCase().includes(keyword)).length : "";

        result.push({
          "구분": label,
          "연령대": ageGroup,
          "초진환자수": 초진차트.length,
          "재진환자수": 재진,
          "총환자수": 총,
          "초진 주사 처방률": `${초진차트.length ? Math.round((주사.length/초진차트.length)*100) : 0}%`,
          "초진주사 갯수": 주사.length,
          "초진 주사환자 재진율": `${Math.round((Object.values(내원횟수).filter(v => v >= 2).length/Object.keys(내원횟수).length)*100)||0}%`,
          "초진주사환자 평균 주사횟수": 평균주사,
          "초진 주사환자 평균내원횟수": 평균내원,
          "초진평균내원횟수": 평균초진내원,
          "초진 재내원율": `${초진차트.length ? Math.round((재내원율/초진차트.length)*100):0}%`,
          "1회 내원 비율": `${내원비율(1)}%`,
          "2회 내원 비율": `${내원비율(2)}%`,
          "3회 내원 비율": `${내원비율(3)}%`,
          "4회 내원 비율": `${내원비율(4)}%`,
          "5회 내원 비율": `${내원비율(5)}%`,
          "6회 내원 비율": `${내원비율(6)}%`,
          "7회 내원 비율": `${내원비율(7)}%`,
          "8회 이상 내원 비율": `${Math.round((Object.values(초진내원).filter(v => v >= 8).length / Object.keys(초진내원).length) * 100)}%`,

          "특정 키워드 포함 메모 수": 키워드수
        });
      };

      const 연령열존재 = col['연령'];
      const 전체 = df;

      if (연령열존재) {
        AGE_ORDER.slice(0, -1).forEach(a => makeStat(전체.filter(r => getAgeGroup(r[col['연령']]) === a), "전체", a));
      }
      makeStat(전체, "전체", "전체");

      const 진료과들 = [...new Set(df.map(r => r[col['과']] || "기타"))];
      진료과들.forEach(과 => {
        const rows = df.filter(r => (r[col['과']] || "기타") === 과);
        if (연령열존재) {
          AGE_ORDER.slice(0, -1).forEach(a => makeStat(rows.filter(r => getAgeGroup(r[col['연령']]) === a), 과, a));
        }
        makeStat(rows, 과, "전체");
      });

      renderTable(result);
    }
  </script>
</body>
</html>
