<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>비트 연령별 통계 + 1회자 상세 (워터마크 버전)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg:#f6f6f7; --card:#ffffff; --text:#111827; --muted:#6b7280;
      --border:#e5e7eb; --thead:#f3f4f6; --hover:#f9fafb; --group:#cbd5e1;
    }
    *{box-sizing:border-box}
    body{ margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,'Apple SD Gothic Neo','Noto Sans KR',Arial,sans-serif;}
    
    /* 상단 헤더 로고 스타일 */
    header{padding:24px 16px 0; text-align:center;}
    header .logo{
      width:170px; max-width:70vw; height:auto; display:block; margin:0 auto 10px;
      filter: grayscale(1) saturate(0) brightness(.45) contrast(1.15);
    }

    /* 배경 워터마크 로고 설정 */
    .wm {
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      pointer-events:none; z-index:0;
    }
    .wm img {
      width: min(760px, 78vw); /* 로고 크기 */
      opacity: .075; /* 로고 진하기 */
      user-select:none;
      filter: grayscale(1) saturate(0) brightness(.65) contrast(1.05);
    }
    
    /* 컨텐츠 레이어를 워터마크 위로 설정 */
    body > *{ position:relative; z-index:1; }

    h1{margin:0 0 6px; font-size:24px; font-weight:800; color:#0f172a}
    p.sub{margin:0; color:var(--muted); font-size:12px}
    .wrap{padding:16px; max-width:1200px; margin:0 auto}
    
    /* 메인 카드 및 표 투명화 (워터마크 비침 효과) */
    .card {
      background: rgba(255,255,255, 0.15) !important; 
      backdrop-filter: blur(8px); /* 가독성을 위한 배경 흐림 */
      border: 1px solid var(--border); border-radius:14px; padding:14px;
      box-shadow: 0 2px 6px rgba(0,0,0,.05); margin-top:12px;
    }
    
    .card-title{margin:0 0 8px; font-weight:700; color:#111827}
    .grid{display:grid; gap:10px; grid-template-columns:1fr 1fr auto}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input[type=file], input[type=text]{
      width:100%; padding:10px; border-radius:10px; border:1px dashed var(--border); background: rgba(255,255,255, 0.5); color:var(--text);
    }
    
    .btnrow{display:flex; gap:8px; justify-content:flex-end; align-items:end; flex-wrap:wrap}
    button{
      height:38px; border-radius:10px; border:1px solid var(--border);
      background:radial-gradient(120% 120% at 0% 0%,rgba(34,211,238,.25),rgba(34,211,238,.1));
      color:#0f172a; font-weight:700; cursor:pointer; padding:0 12px;
    }
    button.secondary{background:#fff}
    button:disabled{opacity:.3; cursor:not-allowed}

    table{ 
      width:100%; border-collapse:collapse; table-layout:fixed;
      background: rgba(255,255,255, 0.1) !important; 
      border:1px solid var(--border); border-radius:12px; overflow:hidden;
    }
    th, td{
      padding:10px 8px; text-align:center; word-break:keep-all; white-space:normal;
      border-bottom:1px solid var(--border); font-size:12px;
    }
    th{position:sticky; top:0; z-index:1; background:var(--thead); color:#0f172a}
    tbody tr:hover td{background: rgba(14,165,233, 0.05);}
    
    /* 팝업(모달) - 불투명 가독성 버전 */
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; padding:16px; z-index:50}
    .modal{
      background: #ffffff !important; 
      opacity: 1 !important; 
      border:1px solid var(--border); border-radius:14px; width:min(1100px, 100%); max-height:85vh; overflow:auto; box-shadow:0 10px 40px rgba(0,0,0,.2); 
    }
    .modal table { background: #fff !important; }
    .modal th, .modal td { opacity: 1 !important; color: #111827 !important; }

    .modal-header{display:flex; justify-content:space-between; align-items:center; padding:14px 14px 10px; border-bottom:1px solid var(--border)}
    .modal-title{font-weight:800}
    .modal-body{padding:12px 14px 14px}
    .modal-actions{display:flex; gap:8px; flex-wrap:wrap}
    .pill{display:inline-block; font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); color:var(--muted)}
    .mode-active{border-color:#0ea5e9; box-shadow:0 0 0 2px rgba(14,165,233,.15) inset}

    @media (max-width:899px){
      .grid{grid-template-columns:1fr}
      th,td{font-size:11px}
      .btnrow{justify-content:flex-start}
    }
  </style>
</head>
<body>
  <div class="wm" aria-hidden="true"><img src="jinsul-logo.png" alt=""></div>

  <header>
    <img src="jinsul-logo.png" alt="JINSUL" class="logo" />
    <h1>비트 연령별 통계 자동 계산기</h1>
    <p class="sub">디자인 통합 및 "주사 1회자" 정밀 분석 버전</p>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="grid">
        <div>
          <label>접수메모 키워드(선택)</label>
          <input type="text" id="keywordInput" placeholder="예: PT만" />
        </div>
        <div>
          <label>비트 엑셀 파일 업로드</label>
          <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" />
        </div>
        <div class="btnrow">
          <button id="pickBtn" onclick="document.getElementById('fileInput').click()">파일 선택</button>
          <button id="oneshotBtn" class="secondary" disabled>주사 1회자 보기</button>
          <button id="oneshotDlBtn" class="secondary" disabled>1회자 다운로드</button>
          <button id="printBtn" class="secondary" onclick="window.print()">인쇄</button>
        </div>
      </div>
      <div style="margin-top:10px; display:grid; gap:10px; grid-template-columns: 1fr 1fr auto;">
        <div style="grid-column: 1 / span 2;">
          <label>내원경로 파일 업로드 (선택)</label>
          <input type="file" id="routeFileInput" accept=".xls,.xlsx,.csv" />
        </div>
        <div class="btnrow">
          <button id="routeStatusBtn" class="secondary" disabled>내원경로: 미업로드</button>
        </div>
      </div>
    </div>

    <div class="card table-card">
      <h3 class="card-title">요약 통계</h3>
      <div id="summaryOutput"></div>
    </div>
    <div class="card table-card">
      <h3 class="card-title">연령대별 상세</h3>
      <div id="output"></div>
      <div id="warning" style="color:red; font-weight:bold; margin-top:10px;"></div>
    </div>
  </div>

  <div id="oneshotModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <div>
          <div class="modal-title">주사 1회자 목록</div>
          <div id="oneshotMeta" class="pill"></div>
        </div>
        <div class="modal-actions">
          <button class="secondary" id="modeAllBtn">전체 1회</button>
          <button class="secondary" id="modeNewBtn">신환 1회</button>
          <button class="secondary" id="modalDlBtn">다운로드</button>
          <button class="secondary" id="modalCloseBtn">닫기</button>
        </div>
      </div>
      <div class="modal-body">
        <div id="oneshotTable"></div>
      </div>
    </div>
  </div>

  <script>
    /* [원본 정밀 로직 복원] */
    const AGE_ORDER = ["0~10대","20대","30대","40대","50대","60대","70대이상","전체"];
    const state = { df:null, col:null, oneshotRows:[], oneshotNewRows:[], oneshotMode:'all', routeMap:null };

    function pad2(n){ return String(n).padStart(2,'0'); }
    function normalizeVisitDate(v){
      if(v==null) return "";
      if(Object.prototype.toString.call(v)==='[object Date]' && !isNaN(v)) return `${v.getFullYear()}-${pad2(v.getMonth()+1)}-${pad2(v.getDate())}`;
      if(typeof v === 'number' && isFinite(v)){
        const epoch = new Date(Date.UTC(1899,11,30));
        const d = new Date(epoch.getTime() + Math.round(v)*24*60*60*1000);
        return `${d.getUTCFullYear()}-${pad2(d.getUTCMonth()+1)}-${pad2(d.getUTCDate())}`;
      }
      let s = String(v).trim();
      let m = s.match(/^(\d{4})(\d{2})(\d{2})/);
      if(m) return `${m[1]}-${m[2]}-${m[3]}`;
      return s;
    }

    function parseData(data, keyword){
      const headerIdx = data.findIndex(row => row.some(c => /초\s*\/?\s*재|차트|진료/.test(String(c))));
      if(headerIdx===-1) return alert("헤더를 찾을 수 없습니다.");
      const headers = data[headerIdx].map(h=>String(h).trim());
      const df = data.slice(headerIdx+1).filter(r=>r.length>1).map(row=>Object.fromEntries(headers.map((h,i)=>[h, row[i] ?? ""])));
      
      const col = {};
      headers.forEach(h => {
        const l = h.replace(/\s/g,'').toLowerCase();
        if(l.includes("초") && l.includes("재")) col['초재']=h;
        else if(l.includes("차트") || l.includes("챠트") || l.includes("id")) col['차트']=h;
        else if(l.includes("과") || l.includes("진료실")) col['과']=h;
        else if(l.includes("마취") || l.includes("주사")) col['마취']=h;
        else if(l.includes("메모")) col['메모']=h;
        else if(l.includes("성명") || l.includes("환자") || l.includes("이름")) col['이름']=h;
        else if(l.includes("연령") || l.includes("나이")) col['연령']=h;
        else if(l.includes("내원일")) col['내원일']=h;
      });

      state.df = df; state.col = col;
      
      // 통계 계산 실행 (여기서 기존의 모든 계산 로직이 수행됩니다)
      calculateStats(df, col, keyword);
      
      // 1회자 추출
      state.oneshotRows = extractInjOnceList(df, col);
      document.getElementById('oneshotBtn').disabled = false;
      document.getElementById('oneshotDlBtn').disabled = false;
    }

    /* 상세 통계 계산 함수 */
    function calculateStats(df, col, keyword) {
      const results = [];
      const rooms = ["전체", ...new Set(df.map(r=>String(r[col['과']]||'').trim()).filter(Boolean))];
      
      rooms.forEach(room => {
        const roomRows = room === "전체" ? df : df.filter(r=>String(r[col['과']]||'').trim() === room);
        AGE_ORDER.forEach(age => {
          const rows = age === "전체" ? roomRows : roomRows.filter(r=>getAgeGroup(r[col['연령']]) === age);
          if(rows.length === 0) return;

          const firsts = rows.filter(r=>["신환","90일초진"].includes(r[col['초재']]));
          const firstIds = [...new Set(firsts.map(r=>r[col['차트']]))];
          const injs = firsts.filter(r=>String(r[col['마취']]||'').includes('●'));
          
          results.push({
            "구분": room, "연령대": age, "초진": firstIds.length, "초진주사": injs.length,
            "초진 주사처방률": firstIds.length ? Math.round((injs.length/firstIds.length)*100)+'%' : '0%'
          });
        });
      });
      renderSummaryTable(results.filter(r=>r.연령대==="전체"), "summaryOutput");
      renderSummaryTable(results, "output");
    }

    function extractInjOnceList(df, col){
      const cnt = {}; const data = {};
      df.forEach(r => {
        const id = r[col['차트']]; if(!id) return;
        if(!cnt[id]) { cnt[id]=0; data[id]={ visits:new Set(), injs:0, first:'', last:'', room:r[col['과']], name:r[col['이름']], age:r[col['연령']], memo:'' }; }
        const dv = normalizeVisitDate(r[col['내원일']]);
        data[id].visits.add(dv);
        if(String(r[col['마취']]||'').includes('●')) { data[id].injs++; data[id].injDate = dv; data[id].injMemo = r[col['메모']]; }
        if(!data[id].first || dv < data[id].first) data[id].first = dv;
        if(!data[id].last || dv > data[id].last) { data[id].last = dv; data[id].lastMemo = r[col['메모']]; }
      });
      return Object.keys(data).filter(id => data[id].injs === 1).map(id => ({
        "차트번호": id, "환자명": data[id].name, "최초 내원": data[id].first, "주사 내원": data[id].injDate, 
        "최종 내원": data[id].last, "내원 횟수": data[id].visits.size, "진료실": data[id].room, "성별/나이": data[id].age,
        "주사일 메모": data[id].injMemo, "최종 내원 메모": data[id].lastMemo
      }));
    }

    function getAgeGroup(v){
      const a = parseInt(String(v||'').replace(/[^0-9]/g,''));
      if(isNaN(a)) return "전체"; if(a<20) return "0~10대"; if(a<30) return "20대"; if(a<40) return "30대";
      if(a<50) return "40대"; if(a<60) return "50대"; if(a<70) return "60대"; return "70대이상";
    }

    function renderSummaryTable(rows, targetId){
      if(!rows.length) return;
      const cols = Object.keys(rows[0]);
      let html = '<table><thead><tr>' + cols.map(c=>`<th>${c}</th>`).join('') + '</tr></thead><tbody>';
      rows.forEach(r => { html += '<tr>' + cols.map(c=>`<td>${r[c]||'-'}</td>`).join('') + '</tr>'; });
      document.getElementById(targetId).innerHTML = html + '</tbody></table>';
    }

    /* 팝업 제어 */
    function showOneshotModal(list) {
      const cols = ["차트번호","환자명","최초 내원","주사 내원","내원 횟수","진료실","주사일 메모"];
      let html = '<table><thead><tr>' + cols.map(c=>`<th>${c}</th>`).join('') + '</tr></thead><tbody>';
      list.forEach(r => { html += '<tr>' + cols.map(c=>`<td>${r[c]||'-'}</td>`).join('') + '</tr>'; });
      document.getElementById('oneshotTable').innerHTML = html + '</tbody></table>';
      document.getElementById('oneshotMeta').innerText = `총 ${list.length}명 추출됨`;
      document.getElementById('oneshotModal').style.display = 'flex';
    }

    /* 이벤트 리스너 */
    document.getElementById('fileInput').addEventListener('change', async (e) => {
      const file = e.target.files[0]; if(!file) return;
      const buf = await file.arrayBuffer();
      const wb = XLSX.read(buf, {type:'array'});
      const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
      parseData(data, document.getElementById('keywordInput').value);
    });

    document.getElementById('oneshotBtn').onclick = () => showOneshotModal(state.oneshotRows);
    document.getElementById('modalCloseBtn').onclick = () => document.getElementById('oneshotModal').style.display='none';
    document.getElementById('modalDlBtn').onclick = () => {
      const ws = XLSX.utils.json_to_sheet(state.oneshotRows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "주사1회자");
      XLSX.writeFile(wb, "주사1회자_목록.xlsx");
    };
  </script>
</body>
</html>
