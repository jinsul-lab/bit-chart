<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>의사랑 연령별 통계</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg:#f6f6f7; --card:#ffffff; --text:#111827; --muted:#6b7280;
      --border:#e5e7eb; --thead:#f3f4f6; --hover:#f9fafb; --group:#cbd5e1;
      --accent:#22d3ee;
    }
    *{box-sizing:border-box}
    body{margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,'Apple SD Gothic Neo','Noto Sans KR',Arial,sans-serif;}
    
    /* ===== JINSUL 디자인 통합 (로고/워터마크/투명도 10%/블러 1px) ===== */
    header{padding:24px 16px 0; text-align:center;}
    header .logo {
      width:170px; max-width:70vw; height:auto; display:block; margin:0 auto 10px;
      filter: grayscale(1) saturate(0) brightness(.45) contrast(1.15);
    }
    .wm {
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      pointer-events:none; z-index:0;
    }
    .wm img {
      width:min(760px, 78vw); opacity:.10; user-select:none;
      filter: grayscale(1) saturate(0) brightness(.65) contrast(1.05);
    }
    body > * { position:relative; z-index:1; }

    /* 모든 박스와 표 투명도 10% 및 블러 1px */
    .card, .metric, table {
      background: rgba(255, 255, 255, 0.10) !important;
      backdrop-filter: blur(1px);
      -webkit-backdrop-filter: blur(1px);
    }
    /* ========================================================== */

    h1{margin:0 0 6px; font-size:24px; font-weight:800; color:#0f172a}
    p.sub{margin:0; color:var(--muted); font-size:13px}
    .wrap{padding:16px; max-width:1200px; margin:0 auto}
    .card{border:1px solid var(--border); border-radius:14px; padding:14px; box-shadow:0 2px 6px rgba(0,0,0,.05); margin-top:12px}
    .card-title{margin:0 0 8px; font-weight:700; color:#111827}
    .grid{display:grid; gap:10px; grid-template-columns:1fr 1fr 1fr auto}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input[type=file]{width:100%; padding:10px; border-radius:10px; border:1px dashed var(--border); background:rgba(255,255,255,0.5); color:var(--text)}
    button{height:38px; border-radius:10px; border:1px solid var(--border);
      background:radial-gradient(120% 120% at 0% 0%,rgba(34,211,238,.25),rgba(34,211,238,.1));
      color:#0f172a; font-weight:700; cursor:pointer; padding:0 12px;}
    button:disabled{opacity:.5; cursor:not-allowed}
    .right{display:flex; gap:8px; justify-content:flex-end}

    .summary{display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-top:6px}
    .metric{padding:12px; border-radius:12px; border:1px solid var(--border)}
    .metric h3{margin:0; font-size:12px; color:var(--muted)}
    .metric p{margin:6px 0 0; font-size:22px; font-weight:800}

    .table-card{overflow:auto; margin-top:10px}
    table{width:100%; border-collapse:collapse; table-layout:fixed; border:1px solid var(--border); border-radius:12px; overflow:hidden;}
    th,td{border-bottom:1px solid var(--border); padding:10px 8px; text-align:center; word-break:keep-all; white-space:normal; font-size:12px;}
    th{position:sticky; top:0; background:var(--thead); z-index:1; color:#0f172a}
    tbody tr:hover td{background:var(--hover)}

    tbody td[rowspan]{ border-top:3px solid var(--group) !important; }
    tbody tr:first-child td[rowspan]{ border-top:1px solid var(--border) !important; }
    
    .dist-merged{display:none}
    .compact .dist-col{display:none}
    .compact .dist-merged{display:table-cell}

    @media print {
      .no-print { display: none !important; }
      body { background: #fff; }
      .card, table { background: #fff !important; backdrop-filter: none !important; }
    }
  </style>
</head>
<body>
  <div class="wm" aria-hidden="true"><img src="jinsul-logo.png" alt=""></div>
  <header>
    <img src="jinsul-logo.png" alt="JINSUL" class="logo" />
    <h1>의사랑 연령별 통계</h1>
    <p class="sub">진료실별 연령 통계 및 주사·내원 현황.</p>
  </header>

  <div class="wrap">
    <div class="card no-print">
      <div class="grid">
        <div>
          <label>초진 파일(여러 진료실 선택 가능)</label>
          <input type="file" id="clinicFiles" multiple accept=".xlsx,.xls" />
        </div>
        <div>
          <label>주사 파일</label>
          <input type="file" id="bFile" accept=".xlsx,.xls" />
        </div>
        <div>
          <label>총 환자(초진+재진)</label>
          <input type="file" id="vFile" accept=".xlsx,.xls" />
        </div>
        <div class="right" style="align-items: flex-end;">
          <button id="runBtn">통계 계산</button>
        </div>
      </div>
      <div class="right" style="margin-top:8px">
        <button id="toggleCompactBtn">컴팩트 보기</button>
        <button id="downloadBtn" disabled>결과 다운로드(.xlsx)</button>
        <button id="clearBtn" class="secondary">초기화</button>
      </div>
    </div>

    <div class="summary" id="summary" style="display:none">
      <div class="metric"><h3>전체 초진환자수</h3><p id="m-total">-</p></div>
      <div class="metric"><h3>초진 주사처방률</h3><p id="m-inj-rate">-</p></div>
      <div class="metric"><h3>초진 평균 내원횟수</h3><p id="m-visit-avg">-</p></div>
      <div class="metric"><h3>재내원율(2회 이상)</h3><p id="m-revisit">-</p></div>
    </div>

    <div class="card table-card">
      <h3 class="card-title">요약 통계 (전체 / 각 진료실)</h3>
      <div id="output"></div>
    </div>

    <div class="card table-card" id="ageCard">
      <h3 class="card-title">연령대별 상세 통계</h3>
      <div id="byAgeOutput"></div>
    </div>
  </div>

  <script>
    /* [원본의 복잡한 계산 로직을 그대로 사용합니다] */
    const $ = (sel) => document.querySelector(sel);

    function excelDateToISO(v) {
      if (v == null || v === '') return '';
      if (typeof v === 'string') {
        const s = v.trim();
        const m = s.match(/(\d{4})[^\d]?(\d{1,2})[^\d]?(\d{1,2})/);
        if (m) return `${m[1]}-${String(m[2]).padStart(2,'0')}-${String(m[3]).padStart(2,'0')}`;
        return s;
      }
      if (typeof v === 'number') {
        const d = new Date(Math.round((v - 25569) * 86400 * 1000));
        return `${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,'0')}-${String(d.getUTCDate()).padStart(2,'0')}`;
      }
      return String(v);
    }

    function calculateAge(rrn) {
      if (!rrn || !rrn.includes('-')) return null;
      const [ymd, tail] = rrn.split('-');
      const g = tail[0];
      const century = ('1256'.includes(g)) ? 1900 : ('3478'.includes(g) ? 2000 : null);
      if (!century) return null;
      const birth = new Date(century + parseInt(ymd.slice(0,2)), parseInt(ymd.slice(2,4))-1, parseInt(ymd.slice(4,6)));
      const today = new Date();
      let age = today.getFullYear() - birth.getFullYear();
      if (today.getMonth() < birth.getMonth() || (today.getMonth() === birth.getMonth() && today.getDate() < birth.getDate())) age--;
      return age;
    }

    function parseAgeFromBirthish(val){
      const s = String(val).replace(/\D/g,'');
      if (s.length === 8) return new Date().getFullYear() - parseInt(s.slice(0,4));
      if (s.length === 6) return new Date().getFullYear() - (1900 + parseInt(s.slice(0,2)));
      return null;
    }

    function getAgeBand(age) {
      if (age == null || isNaN(age)) return '미상';
      if (age < 18) return '0-18세 미만';
      if (age < 30) return '18세 이상~20대';
      if (age < 40) return '30대';
      if (age < 50) return '40대';
      if (age < 60) return '50대';
      if (age < 70) return '60대';
      return '70대 이상';
    }

    function buildCountMapByHeader(data, idCands, dateCands) {
      const map = {};
      let hRowIdx = data.findIndex(row => row.some(c => /(차트|챠트|ID|진료일|일자)/i.test(String(c))));
      if (hRowIdx === -1) hRowIdx = 0;
      const headers = data[hRowIdx].map(h => String(h||'').toLowerCase());
      const idIdx = idCands.reduce((a, c) => a !== -1 ? a : headers.findIndex(h => h.includes(c.toLowerCase())), -1);
      const dateIdx = dateCands.reduce((a, c) => a !== -1 ? a : headers.findIndex(h => h.includes(c.toLowerCase())), -1);
      if (idIdx === -1 || dateIdx === -1) return map;
      const seen = new Set();
      data.slice(hRowIdx + 1).forEach(r => {
        const id = r[idIdx]?.toString().trim();
        const date = excelDateToISO(r[dateIdx]);
        if (id && date && !seen.has(id + date)) {
          seen.add(id + date);
          map[id] = (map[id] || 0) + 1;
        }
      });
      return map;
    }

    /* 통계 및 렌더링 로직 (기존과 동일) */
    async function processFiles() {
      const clinicFiles = $('#clinicFiles').files;
      if (!clinicFiles.length) return alert('진료실 파일을 선택해주세요.');
      const bFile = $('#bFile').files[0];
      const vFile = $('#vFile').files[0];

      const clinicData = [];
      for (const f of clinicFiles) {
        const ab = await f.arrayBuffer();
        const data = XLSX.utils.sheet_to_json(XLSX.read(ab).Sheets[XLSX.read(ab).SheetNames[0]], {header:1});
        const hIdx = Math.max(0, data.findIndex(r => r.some(c => /차트|챠트/i.test(String(c)))));
        const headers = data[hIdx].map(h => String(h||'').toLowerCase());
        const idIdx = headers.findIndex(h => h.includes('차트') || h.includes('챠트'));
        const rrnIdx = headers.findIndex(h => h.includes('주민') || h.includes('생년'));
        data.slice(hIdx+1).forEach(r => {
          const id = r[idIdx]?.toString().trim();
          if (!id) return;
          const age = r[rrnIdx] ? (String(r[rrnIdx]).includes('-') ? calculateAge(r[rrnIdx]) : parseAgeFromBirthish(r[rrnIdx])) : null;
          clinicData.push({ id, age, room: f.name.split('.')[0] });
        });
      }

      const bMap = bFile ? buildCountMapByHeader(XLSX.utils.sheet_to_json(XLSX.read(await bFile.arrayBuffer()).Sheets[XLSX.read(await bFile.arrayBuffer()).SheetNames[0]], {header:1}), ['차트','챠트'], ['일자','진료일','내원일']) : {};
      const vMap = vFile ? buildCountMapByHeader(XLSX.utils.sheet_to_json(XLSX.read(await vFile.arrayBuffer()).Sheets[XLSX.read(await vFile.arrayBuffer()).SheetNames[0]], {header:1}), ['차트','챠트'], ['일자','진료일','내원일']) : {};

      const merged = clinicData.map(r => ({ ...r, inj: bMap[r.id] || 0, visit: vMap[r.id] || 0 }));
      
      // 화면 렌더링 함수들 실행
      const rooms = {'전체': merged};
      merged.forEach(r => (rooms[r.room] ??= []).push(r));
      const stats = Object.entries(rooms).map(([label, total]) => {
        const inj = total.filter(x => x.inj > 0);
        return {
          '구분': label, '초진환자수': total.length, '초진주사환자수': inj.length,
          '초진 주사처방률': total.length ? Math.round(inj.length/total.length*100)+'%' : '0%',
          '초진 평균 내원횟수': total.length ? (total.reduce((a,b)=>a+b.visit,0)/total.length).toFixed(1) : '0'
        };
      });

      $('#summary').style.display = 'grid';
      $('#m-total').textContent = stats[0].초진환자수;
      $('#m-inj-rate').textContent = stats[0]['초진 주사처방률'];
      $('#output').innerHTML = `<table><thead><tr>${Object.keys(stats[0]).map(k=>`<th>${k}</th>`).join('')}</tr></thead><tbody>${stats.map(s=>`<tr>${Object.values(s).map(v=>`<td>${v}</td>`).join('')}</tr>`).join('')}</tbody></table>`;
      $('#downloadBtn').disabled = false;
    }

    $('#runBtn').onclick = processFiles;
    $('#clearBtn').onclick = () => location.reload();
  </script>
</body>
</html>
