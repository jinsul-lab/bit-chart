<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>/의사랑/ 초진 주사 및 내원 통계</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg:#f6f7fb;         /* 라이트 배경 */
      --card:#ffffff;       /* 카드 바탕 */
      --line:#e6e8ef;       /* 테두리 라인 */
      --muted:#6b7280;      /* 보조 글자 */
      --text:#111827;       /* 본문 글자 */
      --head:#0f172a;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Apple SD Gothic Neo','Noto Sans KR',sans-serif;margin:0;background:var(--bg);color:var(--text)}
    header{padding:28px 16px 0;text-align:center}
    h1{margin:0 0 6px;font-size:28px;font-weight:800;color:var(--head)}
    p.sub{margin:0;color:var(--muted);font-size:13px}

    .wrap{padding:16px;max-width:1200px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-top:12px;box-shadow:0 1px 0 rgba(16,24,40,.02)}

    .grid{display:grid;gap:10px;grid-template-columns:1fr 1fr 1fr auto}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .file{width:100%;height:38px;padding:8px;border-radius:10px;border:1px dashed var(--line);background:#fafbff}
    button{height:38px;border-radius:10px;border:1px solid var(--line);background:#fff;font-weight:600;cursor:pointer;padding:0 12px}
    button:disabled{opacity:.5;cursor:not-allowed}
    .right{display:flex;gap:8px;justify-content:flex-end}

    .summary{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
    .metric{padding:12px;border-radius:12px;background:#fbfcff;border:1px solid var(--line)}
    .metric h3{margin:0 0 6px;font-size:12px;color:var(--muted)}
    .metric p{margin:0;font-size:28px;font-weight:800}

    .table-head{margin:0 0 8px;font-size:14px;color:var(--muted)}
    .table-wrap{overflow:auto}

    table{width:100%;border-collapse:collapse;table-layout:fixed;background:var(--card)}
    th,td{border-bottom:1px solid var(--line);padding:10px 8px;text-align:center;word-break:keep-all;white-space:normal;font-size:12.5px}
    th{position:sticky;top:0;background:#f7f9ff;z-index:1}
    tbody tr:hover td{background:#fbfdff}

    /* 진료실(룸) 구분용 – 첫 행은 두꺼운 상단라인, 룸마다 번갈아 옅은 배경 */
    .room-sep td{border-top:3px solid var(--line)}
    .room-a td{background:#fcfcfe}
    .room-b td{background:#ffffff}

    @media (max-width: 900px){
      .grid{grid-template-columns:1fr}
      .summary{grid-template-columns:1fr}
      th,td{font-size:12px}
    }
  </style>
</head>
<body>
  <header>
    <h1>/의사랑/ 초진 주사 및 내원 통계</h1>
    <p class="sub">진료실(여러 개) + 주사(b) + 내원(v) 통합. 개인정보는 마스킹/집계만 사용.</p>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="grid">
        <div>
          <label>진료실 파일들 (여러 개)</label>
          <input class="file" type="file" id="clinicFiles" multiple accept=".xlsx" />
        </div>
        <div>
          <label>주사 파일 (b)</label>
          <input class="file" type="file" id="bFile" accept=".xlsx" />
        </div>
        <div>
          <label>내원 파일 (v)</label>
          <input class="file" type="file" id="vFile" accept=".xlsx" />
        </div>
        <div class="right">
          <button id="runBtn">통계 계산</button>
        </div>
      </div>
      <p style="color:var(--muted);font-size:12px;margin:8px 0 0">⚠️ 모든 파일은 브라우저 내에서만 처리됩니다.</p>
    </div>

    <div class="summary" id="summary" style="display:none">
      <div class="metric"><h3>전체 초진환자수</h3><p id="m-total">-</p></div>
      <div class="metric"><h3>초진 주사처방률</h3><p id="m-inj-rate">-</p></div>
      <div class="metric"><h3>초진 평균 내원횟수</h3><p id="m-visit-avg">-</p></div>
    </div>

    <div class="card">
      <h3 class="table-head">요약 통계 (전체 / 각 진료실)</h3>
      <div class="table-wrap" id="sumOut"></div>
    </div>

    <div class="card">
      <h3 class="table-head">연령대별 통계 (진료실별)</h3>
      <div class="table-wrap" id="ageOut"></div>
    </div>
  </div>

  <script>
    const $ = (s)=>document.querySelector(s);

    /* ---------- 공통 유틸 ---------- */
    function excelDateToISO(v){
      if(!v) return '';
      if(typeof v==='string') return v.trim();
      if(typeof v==='number'){
        const utcDays = Math.floor(v - 25569), date = new Date(utcDays*86400*1000);
        const y=date.getUTCFullYear(), m=String(date.getUTCMonth()+1).padStart(2,'0'), d=String(date.getUTCDate()).padStart(2,'0');
        return `${y}-${m}-${d}`;
      }
      if(v instanceof Date){
        const y=v.getFullYear(), m=String(v.getMonth()+1).padStart(2,'0'), d=String(v.getDate()).padStart(2,'0');
        return `${y}-${m}-${d}`;
      }
      return String(v);
    }
    function calculateAge(rrn){
      if(!rrn||typeof rrn!=='string'||!rrn.includes('-')) return null;
      const [ymd,tail]=rrn.split('-'); if(!ymd||!tail||ymd.length!==6) return null;
      const s=tail[0]; let c; if('1256'.includes(s)) c=1900; else if('3478'.includes(s)) c=2000; else return null;
      const yy=+ymd.slice(0,2), mm=+ymd.slice(2,4), dd=+ymd.slice(4,6);
      const b=new Date(c+yy,mm-1,dd); if(isNaN(b)) return null;
      const t=new Date(); let a=t.getFullYear()-b.getFullYear(); const m=t.getMonth()-b.getMonth();
      if(m<0||(m===0&&t.getDate()<b.getDate())) a--; return a;
    }
    function getAgeBand(age){
      if(age==null||isNaN(age)) return '미상';
      if(age<18) return '0-18세 미만';
      if(age<30) return '18세 이상~20대';
      if(age<40) return '30대';
      if(age<50) return '40대';
      if(age<60) return '50대';
      if(age<70) return '60대';
      return '70대 이상';
    }
    function buildCountMap(data,keyIdx,dateIdx){
      const seen=new Set(), map={}; const rows=data.length>2?data.slice(2):data;
      rows.forEach(r=>{
        const k=r[keyIdx]?.toString().trim(); const d=excelDateToISO(r[dateIdx]);
        if(k&&d&&!seen.has(k+'_'+d)){ seen.add(k+'_'+d); map[k]=(map[k]||0)+1; }
      });
      return map;
    }
    function average(arr){return arr.length?arr.reduce((a,b)=>a+b,0)/arr.length:0;}
    function pct(a,b){return b?Math.round(a/b*100)+'%':'-';}
    function normalizeRoomName(filename){
      const base=filename.replace(/\.xlsx$/i,'').replace(/진료실/g,'').trim();
      const num=base.match(/\d+/)?.[0]; return (num?num:base)+'진료실';
    }
    async function readXlsx(file){
      const ab=await file.arrayBuffer(); const wb=XLSX.read(ab,{type:'array'});
      return XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1,raw:true});
    }
    // 보기 좋게: 0/0%/NaN%/빈값 → '-'
    function fmt(v){
      if(v===null||v===undefined||v==='') return '-';
      if(typeof v==='number'){ if(!isFinite(v)||v===0) return v===0?'-': '-'; return String(v.toFixed?+v: v); }
      const s=String(v);
      if(s==='0'||s==='0.0'||s==='0.00') return '-';
      if(/^(NaN|Infinity)/i.test(s)) return '-';
      if(/^(0|NaN)(\.\d+)?%$/.test(s)) return '-';
      return s;
    }

    /* ---------- 통계 계산 ---------- */
    function computeStats(merged){
      const byRoom={'전체':[...merged]};
      merged.forEach(r=>{ (byRoom[r.room]??=[]).push(r); });
      const order=['전체','1진료실','2진료실','3진료실','4진료실','5진료실'];
      const rows=[];
      for(const [label,total] of Object.entries(byRoom)){
        const inj=total.filter(r=>r.inj>0);
        const avgInj=average(inj.map(r=>r.inj));
        const avgVisit=average(total.map(r=>r.visit));
        const revisit2p=total.filter(r=>r.visit>=2).length;

        rows.push({
          '구분':label,
          '초진환자수':total.length,
          '초진주사환자수':inj.length,
          '초진 주사처방률':pct(inj.length,total.length),
          '초진 주사환자 평균 주사횟수':avgInj.toFixed(1),
          '초진 평균 내원횟수':avgVisit.toFixed(1),
          '초진 재내원율(2회 이상)':pct(revisit2p,total.length),
          '1회 내원율':pct(total.filter(r=>r.visit===1).length,total.length),
          '2회 내원율':pct(total.filter(r=>r.visit===2).length,total.length),
          '3회 내원율':pct(total.filter(r=>r.visit===3).length,total.length),
          '4회 내원율':pct(total.filter(r=>r.visit===4).length,total.length),
          '5회 이상 내원율':pct(total.filter(r=>r.visit>=5).length,total.length),
        });
      }
      rows.sort((a,b)=>{
        const ai=order.indexOf(a['구분']), bi=order.indexOf(b['구분']);
        return (ai==-1)-(bi==-1) || ai-bi;
      });
      return rows;
    }

    function computeAgeBandStats(merged){
      const byRoomBand={};
      merged.forEach(r=>{
        const band=getAgeBand(r.age);
        (byRoomBand[r.room]??={} )[band]??=[];
        byRoomBand[r.room][band].push(r);
      });
      const orderRooms=['1진료실','2진료실','3진료실','4진료실','5진료실'];
      const orderBands=['전체','0-18세 미만','18세 이상~20대','30대','40대','50대','60대','70대 이상','미상'];
      const rows=[];
      const rooms=Object.keys(byRoomBand).sort((a,b)=>{
        const ai=orderRooms.indexOf(a), bi=orderRooms.indexOf(b);
        if(ai===-1&&bi===-1) return a.localeCompare(b);
        if(ai===-1) return 1; if(bi===-1) return -1; return ai-bi;
      });
      for(const room of rooms){
        const all=Object.values(byRoomBand[room]).flat();
        pushBandRow(rows,room,'전체',all);
        for(const band of orderBands){
          if(band==='전체') continue;
          const arr=byRoomBand[room][band]||[]; if(!arr.length) continue;
          pushBandRow(rows,room,band,arr);
        }
      }
      return rows;

      function pushBandRow(out, room, band, arr){
        const inj=arr.filter(x=>x.inj>0), injN=inj.length;
        const avgInj=injN?average(inj.map(x=>x.inj)):0;
        const avgVisit=average(arr.map(x=>x.visit));
        const revisit2p=arr.filter(x=>x.visit>=2).length;
        const cnt=n=>inj.filter(x=>n===8?x.inj>=8:x.inj===n).length;
        const rate=n=>pct(cnt(n),injN);
        out.push({
          '진료실':room,
          '연령대':band,
          '초진환자수':arr.length,
          '초진주사환자수':injN,
          '초진 주사처방률':pct(injN,arr.length),
          '초진 평균 내원횟수':avgVisit.toFixed(1),
          '초진 재내원율(2회 이상)':pct(revisit2p,arr.length),
          '초진 주사환자 평균 주사횟수':avgInj.toFixed(1),
          '주사 1회(%)':rate(1),'2회(%)':rate(2),'3회(%)':rate(3),'4회(%)':rate(4),
          '5회(%)':rate(5),'6회(%)':rate(6),'7회(%)':rate(7),'8회 이상(%)':rate(8)
        });
      }
    }

    /* ---------- 렌더링 ---------- */
    function renderSummaryTable(stats){
      const cols=['구분','초진환자수','초진주사환자수','초진 주사처방률','초진 주사환자 평균 주사횟수','초진 평균 내원횟수','초진 재내원율(2회 이상)','1회 내원율','2회 내원율','3회 내원율','4회 내원율','5회 이상 내원율'];
      let thead='<tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'</tr>';
      let tbody='';
      stats.forEach((r,i)=>{
        const tr='<tr>'+cols.map((c,idx)=>`<td>${fmt(r[c])}</td>`).join('')+'</tr>';
        tbody+=tr;
      });
      $('#sumOut').innerHTML=`<table><thead>${thead}</thead><tbody>${tbody}</tbody></table>`;
    }

    function renderAgeTable(rows){
      const cols=['진료실','연령대','초진환자수','초진주사환자수','초진 주사처방률','초진 평균 내원횟수','초진 재내원율(2회 이상)','초진 주사환자 평균 주사횟수','주사 1회(%)','2회(%)','3회(%)','4회(%)','5회(%)','6회(%)','7회(%)','8회 이상(%)'];
      let thead='<tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'</tr>';

      // 진료실 구분선/번갈아 배경
      let tbody='', prevRoom=null, alt=false;
      const roomRowCount={};
      rows.forEach(r=> roomRowCount[r['진료실']] = (roomRowCount[r['진료실']]||0)+1);

      rows.forEach(r=>{
        const isNewRoom = r['진료실']!==prevRoom;
        if(isNewRoom){
          alt=!alt; // 룸 바뀔때마다 배경 변경
          prevRoom=r['진료실'];
        }
        const cls = `${isNewRoom?'room-sep ':''}${alt?'room-a':'room-b'}`;
        const tds = cols.map(c=>`<td>${fmt(r[c])}</td>`).join('');
        tbody += `<tr class="${cls}">${tds}</tr>`;
      });

      $('#ageOut').innerHTML=`<table><thead>${thead}</thead><tbody>${tbody}</tbody></table>`;
    }

    /* ---------- 파이프라인 ---------- */
    async function processFiles(){
      const clinicFiles=$('#clinicFiles').files, bFile=$('#bFile').files[0], vFile=$('#vFile').files[0];
      if(!clinicFiles.length){alert('진료실 파일은 반드시 업로드해야 합니다');return;}
      $('#runBtn').disabled=true; $('#runBtn').textContent='계산 중…';
      try{
        const clinic=[];
        for(const f of clinicFiles){ clinic.push({name:normalizeRoomName(f.name), data:await readXlsx(f)}); }
        const b = bFile? await readXlsx(bFile):null;
        const v = vFile? await readXlsx(vFile):null;

        // 진료실 환자(초진) 기본 목록 구성
        const seen=new Set(), clinicRows=[];
        clinic.forEach(room=>{
          const rows = room.data.length>2? room.data.slice(2): room.data;
          rows.forEach(r=>{
            const id=r[0]?.toString().trim(); const rrn=r[2]?.toString().trim();
            if(!id||!rrn||!rrn.includes('-')) return;
            const key=id+'_'+rrn+'_'+room.name; if(seen.has(key)) return; seen.add(key);
            clinicRows.push({ id, age:calculateAge(rrn), room:room.name });
          });
        });

        // 주사/내원 횟수 매핑
        const bMap = b? buildCountMap(b,0,3):{};
        const vMap = v? buildCountMap(v,0,3):{};
        const merged = clinicRows.map(r=>({ id:r.id, age:r.age, room:r.room, inj:bMap[r.id]||0, visit:vMap[r.id]||0 }));

        // 계산
        const stats = computeStats(merged);
        const byAge = computeAgeBandStats(merged);

        // 상단 카드
        const overall = stats.find(s=>s['구분']==='전체');
        if(overall){
          $('#summary').style.display='grid';
          $('#m-total').textContent = fmt(overall['초진환자수']);
          $('#m-inj-rate').textContent = fmt(overall['초진 주사처방률']);
          $('#m-visit-avg').textContent = fmt(overall['초진 평균 내원횟수']);
        }

        renderSummaryTable(stats);
        renderAgeTable(byAge);
      }catch(e){
        console.error(e); alert('파일 처리 중 오류가 발생했습니다.');
      }finally{
        $('#runBtn').disabled=false; $('#runBtn').textContent='통계 계산';
      }
    }

    $('#runBtn').addEventListener('click', processFiles);
  </script>
</body>
</html>
