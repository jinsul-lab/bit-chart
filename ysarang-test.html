<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì˜ì‚¬ë‘ ì—°ë ¹ë³„ í†µê³„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg:#f6f6f7; --card:#ffffff; --text:#111827; --muted:#6b7280;
      --border:#e5e7eb; --thead:#f3f4f6; --hover:#f9fafb; --group:#cbd5e1;
      --accent:#22d3ee;
    }
    *{box-sizing:border-box}
    body{margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,'Apple SD Gothic Neo','Noto Sans KR',Arial,sans-serif;}
    
    /* ===== JINSUL ë””ìì¸ í†µí•© (ìš”ì²­ ì‚¬í•­ ë°˜ì˜) ===== */
    header{padding:24px 16px 0; text-align:center;}
    header .logo {
      width:170px; max-width:70vw; height:auto; display:block; margin:0 auto 10px;
      filter: grayscale(1) saturate(0) brightness(.45) contrast(1.15);
    }

    .wm {
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      pointer-events:none; z-index:0;
    }
    .wm img {
      width:min(760px, 78vw); opacity:.10; user-select:none;
      filter: grayscale(1) saturate(0) brightness(.65) contrast(1.05);
    }
    
    body > * { position:relative; z-index:1; }

    /* í‘œ ë° ì¹´ë“œ íˆ¬ëª…ë„ 10% + ë¸”ëŸ¬ 1px */
    .card, table, .metric {
      background: rgba(255, 255, 255, 0.10) !important;
      backdrop-filter: blur(1px);
      -webkit-backdrop-filter: blur(1px);
    }
    /* =========================================== */

    h1{margin:0 0 6px; font-size:24px; font-weight:800; color:#0f172a}
    p.sub{margin:0; color:var(--muted); font-size:13px}
    .wrap{padding:16px; max-width:1200px; margin:0 auto}
    .card{border:1px solid var(--border); border-radius:14px; padding:14px; box-shadow:0 2px 6px rgba(0,0,0,.05); margin-top:12px}
    .card-title{margin:0 0 8px; font-weight:700; color:#111827}
    .grid{display:grid; gap:10px; grid-template-columns:1fr 1fr 1fr auto}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input[type=file]{width:100%; padding:10px; border-radius:10px; border:1px dashed var(--border); background:rgba(255,255,255,0.4); color:var(--text)}
    button{height:38px; border-radius:10px; border:1px solid var(--border);
      background:radial-gradient(120% 120% at 0% 0%,rgba(34,211,238,.25),rgba(34,211,238,.1));
      color:#0f172a; font-weight:700; cursor:pointer; padding:0 12px;}
    button:disabled{opacity:.5; cursor:not-allowed}
    .right{display:flex; gap:8px; justify-content:flex-end}

    .summary{display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-top:6px}
    .metric{padding:12px; border-radius:12px; border:1px solid var(--border)}
    .metric h3{margin:0; font-size:12px; color:var(--muted)}
    .metric p{margin:6px 0 0; font-size:22px; font-weight:800}

    .table-card{overflow:auto; margin-top:10px}
    table{width:100%; border-collapse:collapse; table-layout:fixed; border:1px solid var(--border); border-radius:12px; overflow:hidden;}
    th,td{border-bottom:1px solid var(--border); padding:10px 8px; text-align:center; word-break:keep-all; white-space:normal; font-size:12px;}
    th{position:sticky; top:0; background:var(--thead) !important; z-index:1; color:#0f172a}
    tbody tr:hover td{background:rgba(0,0,0,0.05)}

    .dist-merged{display:none}
    .compact .dist-col{display:none}
    .compact .dist-merged{display:table-cell}

    @media print {
      .no-print { display: none !important; }
      body { background: #fff; }
      .card, table { background: #fff !important; backdrop-filter: none !important; }
    }
  </style>
</head>
<body>
  <div class="wm" aria-hidden="true"><img src="jinsul-logo.png" alt=""></div>
  <header>
    <img src="jinsul-logo.png" alt="JINSUL" class="logo" />
    <h1>ì˜ì‚¬ë‘ ì—°ë ¹ë³„ í†µê³„</h1>
    <p class="sub">ì§„ë£Œì‹¤ë³„ ì—°ë ¹ í†µê³„ ë° ì£¼ì‚¬Â·ë‚´ì› í˜„í™©.</p>
  </header>

  <div class="wrap">
    <div class="card no-print">
      <div class="grid">
        <div>
          <label>ì´ˆì§„ íŒŒì¼(ì§„ë£Œì‹¤ë³„ ë˜ëŠ” ë‹´ë‹¹ì˜ë³„)</label>
          <label>ì§„ë£Œì‹¤ë³„ ë˜ëŠ” ë‹´ë‹¹ì˜ë³„ë¡œ ì´ˆì§„ íŒŒì¼ì„ ë°›ì•„ì£¼ì„¸ìš”</label>
          <label>ğŸš«ì§„ë£Œì‹¤ì´ ì—¬ëŸ¬ê°œë©´ ê¼­! ì§„ë£Œì‹¤ë³„ ì´ˆì§„ íŒŒì¼ ë°›ì•„ì£¼ì„¸ìš”ğŸš«</label>
          <input type="file" id="clinicFiles" multiple accept=".xlsx,.xls" />
        </div>
        <div>
          <label>ì£¼ì‚¬ íŒŒì¼</label>
          <label>ë¦¬ë„ì¹´ì¸, ì— ì¹´ì¸ ë“± ë³‘ì›ì—ì„œ ì“°ëŠ” ë§ˆì·¨ì œ ë°›ì•„ì£¼ì„¸ìš”</label>
          <label>â¤ï¸ì§„ë£Œì‹¤ë³„ë¡œ ë°›ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤â¤ï¸</label>
          <input type="file" id="bFile" accept=".xlsx,.xls" />
        </div>
        <div>
          <label>ì´ í™˜ì(ì´ˆì§„+ì¬ì§„)</label>
          <label>ì´ˆì§„, ì¬ì§„ ì§„ì°°ë£Œ íŒŒì¼ ê°ê° ë°›ì•„ì„œ 1ê°œë¡œ í•©ì³ë„ ë©ë‹ˆë‹¤â—</label>
          <label>â¤ï¸ì§„ë£Œì‹¤ë³„ë¡œ ë°›ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤â¤ï¸</label>
          <input type="file" id="vFile" accept=".xlsx,.xls" />
        </div>
        <div class="right" style="align-items: flex-end;">
          <button id="runBtn">í†µê³„ ê³„ì‚°</button>
        </div>
      </div>
      <div class="right" style="margin-top:8px">
        <button id="toggleCompactBtn" title="í‘œë¥¼ í•œ í˜ì´ì§€ë¡œ ë³´ê¸°">ì»´íŒ©íŠ¸ ë³´ê¸°</button>
        <button id="downloadBtn" disabled>ê²°ê³¼ ë‹¤ìš´ë¡œë“œ(.xlsx)</button>
        <button id="clearBtn">ì´ˆê¸°í™”</button>
      </div>
      <p style="color:var(--muted);font-size:12px;margin:8px 0 0">âš ï¸ ëª¨ë“  íŒŒì¼ì€ ë¸Œë¼ìš°ì € ë‚´ì—ì„œë§Œ ì²˜ë¦¬ë©ë‹ˆë‹¤.</p>
    </div>

    <div class="summary" id="summary" style="display:none">
      <div class="metric"><h3>ì „ì²´ ì´ˆì§„í™˜ììˆ˜</h3><p id="m-total">-</p></div>
      <div class="metric"><h3>ì´ˆì§„ ì£¼ì‚¬ì²˜ë°©ë¥ </h3><p id="m-inj-rate">-</p></div>
      <div class="metric"><h3>ì´ˆì§„ í‰ê·  ë‚´ì›íšŸìˆ˜</h3><p id="m-visit-avg">-</p></div>
      <div class="metric"><h3>ì¬ë‚´ì›ìœ¨(2íšŒ ì´ìƒ)</h3><p id="m-revisit">-</p></div>
    </div>

    <div class="card table-card">
      <h3 class="card-title">ìš”ì•½ í†µê³„ (ì „ì²´ / ê° ì§„ë£Œì‹¤)</h3>
      <div id="output"></div>
    </div>

    <div class="card table-card" id="ageCard">
      <h3 class="card-title">ì—°ë ¹ëŒ€ë³„ í†µê³„ (ì§„ë£Œì‹¤ë³„)</h3>
      <div id="byAgeOutput"></div>
    </div>
  </div>

  <script>
    /* [ì›ë³¸ ë¡œì§ 100% ìœ ì§€] */
    const $ = (sel) => document.querySelector(sel);

    function excelDateToISO(v) {
      if (v == null || v === '') return '';
      if (typeof v === 'string') {
        const s = v.trim();
        const m = s.match(/(\d{4})[^\d]?(\d{1,2})[^\d]?(\d{1,2})/);
        if (m) {
          const y = m[1], mo = String(m[2]).padStart(2,'0'), d = String(m[3]).padStart(2,'0');
          return `${y}-${mo}-${d}`;
        }
        return s;
      }
      if (typeof v === 'number') {
        const utc_days = Math.floor(v - 25569);
        const utc_value = utc_days * 86400;
        const d = new Date(utc_value * 1000);
        const y=d.getUTCFullYear(), m=String(d.getUTCMonth()+1).padStart(2,'0'), dd=String(d.getUTCDate()).padStart(2,'0');
        return `${y}-${m}-${dd}`;
      }
      return String(v);
    }

    function calculateAge(rrn) {
      if (!rrn || typeof rrn !== 'string') return null;
      const s = rrn.trim();
      if (!s.includes('-')) return null;
      const [ymd, tail] = s.split('-');
      if (ymd.length !== 6 || tail.length < 1) return null;
      const g = tail[0];
      let century = ('1256'.includes(g)) ? 1900 : (('3478'.includes(g)) ? 2000 : null);
      if (!century) return null;
      const yy=parseInt(ymd.slice(0,2),10), mm=parseInt(ymd.slice(2,4),10), dd=parseInt(ymd.slice(4,6),10);
      const birth = new Date(century+yy, mm-1, dd);
      const today=new Date();
      let age=today.getFullYear()-birth.getFullYear();
      if (today.getMonth()<birth.getMonth() || (today.getMonth()===birth.getMonth() && today.getDate()<birth.getDate())) age--;
      return age;
    }

    function parseAgeFromBirthish(val){
      if (!val) return null;
      const s = String(val).replace(/\D/g,'');
      if (s.length === 8) return new Date().getFullYear() - parseInt(s.slice(0,4),10);
      if (s.length === 6) return new Date().getFullYear() - (1900 + parseInt(s.slice(0,2),10));
      return null;
    }

    function getAgeBand(age) {
      if (age == null || isNaN(age)) return 'ë¯¸ìƒ';
      if (age < 18) return '0-18ì„¸ ë¯¸ë§Œ';
      if (age < 30) return '18ì„¸ ì´ìƒ~20ëŒ€';
      if (age < 40) return '30ëŒ€';
      if (age < 50) return '40ëŒ€';
      if (age < 60) return '50ëŒ€';
      if (age < 70) return '60ëŒ€';
      return '70ëŒ€ ì´ìƒ';
    }

    function buildCountMapByHeader(data, idCands, dateCands) {
      const map = {}; if (!data || !data.length) return map;
      let hIdx = data.findIndex(row => row.some(c => /(ì°¨íŠ¸|ID|ì§„ë£Œì¼|ì¼ì)/i.test(String(c))));
      if (hIdx === -1) hIdx = 0;
      const headers = data[hIdx].map(h => String(h||'').toLowerCase());
      const idCol = idCands.reduce((a, c) => a !== -1 ? a : headers.findIndex(h => h.includes(c.toLowerCase())), -1);
      const dtCol = dateCands.reduce((a, c) => a !== -1 ? a : headers.findIndex(h => h.includes(c.toLowerCase())), -1);
      if (idCol === -1 || dtCol === -1) return map;
      const seen = new Set();
      data.slice(hIdx+1).forEach(r => {
        const id = r[idCol]?.toString().trim();
        const date = excelDateToISO(r[dtCol]);
        if (id && date && !seen.has(id+'_'+date)) { seen.add(id+'_'+date); map[id] = (map[id]||0)+1; }
      });
      return map;
    }

    function computeStats(merged){
      const byRoom = { 'ì „ì²´':[...merged] };
      merged.forEach(r=>{ (byRoom[r.room]??=([])).push(r); });
      const res = [];
      const toP = (a,b) => b ? Math.round(a/b*100)+'%' : '0%';
      for(const [label, total] of Object.entries(byRoom)){
        const inj = total.filter(r=>r.inj>0);
        const adult = total.filter(r=>(r.age??0)>=18);
        const adultInj = adult.filter(r=>r.inj>0);
        res.push({
          'êµ¬ë¶„':label, 'ì´ˆì§„í™˜ììˆ˜':total.length, 'ì´ˆì§„ì£¼ì‚¬í™˜ììˆ˜':inj.length, 'ì´ˆì§„ ì£¼ì‚¬ì²˜ë°©ë¥ ':toP(inj.length, total.length),
          'ì´ˆì§„ ì£¼ì‚¬í™˜ì í‰ê·  ì£¼ì‚¬íšŸìˆ˜':inj.length ? (inj.reduce((s,x)=>s+x.inj,0)/inj.length).toFixed(1) : '-',
          'ì´ˆì§„ í‰ê·  ë‚´ì›íšŸìˆ˜':total.length ? (total.reduce((s,x)=>s+x.visit,0)/total.length).toFixed(1) : '-',
          'ì´ˆì§„ ì¬ë‚´ì›ìœ¨':toP(total.filter(r=>r.visit>=2).length, total.length),
          '(18ì„¸â–²)ì´ˆì§„ì£¼ì‚¬ì²˜ë°©ë¥ ':adult.length ? toP(adultInj.length, adult.length) : '-'
        });
      }
      return res;
    }

    function computeAgeBandStats(merged){
      const ORDER = ['0-18ì„¸ ë¯¸ë§Œ','18ì„¸ ì´ìƒ~20ëŒ€','30ëŒ€','40ëŒ€','50ëŒ€','60ëŒ€','70ëŒ€ ì´ìƒ','ë¯¸ìƒ'];
      const byRoom = {}; merged.forEach(r => { (byRoom[r.room] ??= []).push(r); });
      const rows = [];
      const toP = (a,b) => b ? Math.round(a/b*100)+'%' : '0%';
      
      const process = (label, arr) => {
        const byB = {}; arr.forEach(x => { const b = getAgeBand(x.age); (byB[b]??=[]).push(x); });
        ORDER.forEach(band => {
          const a = byB[band] || []; if(!a.length) return;
          const inj = a.filter(x=>x.inj>0);
          rows.push({ 'ì§„ë£Œì‹¤':label, 'ì—°ë ¹ëŒ€':band, 'ì´ˆì§„í™˜ììˆ˜':a.length, 'ì´ˆì§„ì£¼ì‚¬í™˜ììˆ˜':inj.length, 'ì´ˆì§„ ì£¼ì‚¬ì²˜ë°©ë¥ ':toP(inj.length, a.length), 'ì´ˆì§„ í‰ê·  ë‚´ì›íšŸìˆ˜':a.length ? (a.reduce((s,x)=>s+x.visit,0)/a.length).toFixed(1) : '0' });
        });
        rows.push({ 'ì§„ë£Œì‹¤':label, 'ì—°ë ¹ëŒ€':'ì „ì²´', 'ì´ˆì§„í™˜ììˆ˜':arr.length, 'ì´ˆì§„ì£¼ì‚¬í™˜ììˆ˜':arr.filter(x=>x.inj>0).length, 'ì´ˆì§„ ì£¼ì‚¬ì²˜ë°©ë¥ ':toP(arr.filter(x=>x.inj>0).length, arr.length), 'ì´ˆì§„ í‰ê·  ë‚´ì›íšŸìˆ˜':(arr.reduce((s,x)=>s+x.visit,0)/arr.length).toFixed(1) });
      };
      Object.keys(byRoom).sort().forEach(k => process(k, byRoom[k]));
      process('ì „ì²´', merged);
      return rows;
    }

    async function processFiles(){
      const clinicFiles=$('#clinicFiles').files; if(!clinicFiles.length) return;
      const bFile=$('#bFile').files[0]; const vFile=$('#vFile').files[0];
      
      const clinicRows = []; const seen = new Set();
      for(const f of clinicFiles){
        const data = XLSX.utils.sheet_to_json(XLSX.read(await f.arrayBuffer()).Sheets[XLSX.read(await f.arrayBuffer()).SheetNames[0]], {header:1});
        const hIdx = Math.max(0, data.findIndex(row => row.some(c => /ì°¨íŠ¸|ID/i.test(String(c)))));
        const headers = data[hIdx].map(h => String(h||'').toLowerCase());
        const idCol = headers.findIndex(h => h.includes('ì°¨íŠ¸') || h.includes('id'));
        const rrnCol = headers.findIndex(h => h.includes('ì£¼ë¯¼') || h.includes('ìƒë…„'));
        const roomName = f.name.replace(/\.[^/.]+$/, "");

        data.slice(hIdx+1).forEach(r => {
          const id = r[idCol]?.toString().trim(); if(!id) return;
          const age = r[rrnCol] ? (String(r[rrnCol]).includes('-') ? calculateAge(r[rrnCol]) : parseAgeFromBirthish(r[rrnCol])) : null;
          if(!seen.has(id+'_'+roomName)){ seen.add(id+'_'+roomName); clinicRows.push({id, age, room:roomName}); }
        });
      }

      const bMap = bFile ? buildCountMapByHeader(XLSX.utils.sheet_to_json(XLSX.read(await bFile.arrayBuffer()).Sheets[XLSX.read(await bFile.arrayBuffer()).SheetNames[0]], {header:1}), ['ì°¨íŠ¸'], ['ì§„ë£Œì¼','ì¼ì']) : {};
      const vMap = vFile ? buildCountMapByHeader(XLSX.utils.sheet_to_json(XLSX.read(await vFile.arrayBuffer()).Sheets[XLSX.read(await vFile.arrayBuffer()).SheetNames[0]], {header:1}), ['ì°¨íŠ¸'], ['ì§„ë£Œì¼','ì¼ì']) : {};

      const merged = clinicRows.map(r => ({ ...r, inj: bMap[r.id]||0, visit: vMap[r.id]||0 }));
      const stats = computeStats(merged);
      const byAge = computeAgeBandStats(merged);

      $('#summary').style.display = 'grid';
      $('#m-total').textContent = stats.find(s=>s.êµ¬ë¶„==='ì „ì²´').ì´ˆì§„í™˜ììˆ˜;
      $('#m-inj-rate').textContent = stats.find(s=>s.êµ¬ë¶„==='ì „ì²´')['ì´ˆì§„ ì£¼ì‚¬ì²˜ë°©ë¥ '];
      
      const renderTable = (data, target) => {
        const headers = Object.keys(data[0]);
        let html = '<table><thead><tr>'+headers.map(h=>`<th>${h}</th>`).join('')+'</tr></thead><tbody>';
        data.forEach(r => { html += '<tr>'+headers.map(h=>`<td>${r[h]||'-'}</td>`).join('')+'</tr>'; });
        $(target).innerHTML = html+'</tbody></table>';
      };

      renderTable(stats, '#output');
      renderTable(byAge, '#byAgeOutput');
      $('#downloadBtn').disabled = false;
    }

    $('#runBtn').onclick = processFiles;
    $('#clearBtn').onclick = () => location.reload();
  </script>
</body>
</html>
