<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì˜ì‚¬ë‘ 1íšŒë§Œ ë‚´ì›</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- xlsx: xls/xlsx ëª¨ë‘ ì§€ì› ê°€ëŠ¥í•œ 0.18.5 ì‚¬ìš© -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg:#f6f6f7; --card:#ffffff; --text:#111827; --muted:#6b7280;
      --border:#e5e7eb; --thead:#f3f4f6; --hover:#f9fafb; --group:#cbd5e1;
      --accent:#22d3ee;
    }
    *{box-sizing:border-box}
    body{margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,'Apple SD Gothic Neo','Noto Sans KR',Arial,sans-serif;}
    header{padding:24px 16px 0; text-align:center;}
    h1{margin:0 0 6px; font-size:24px; font-weight:800; color:#0f172a}
    p.sub{margin:0; color:var(--muted); font-size:13px}
    .wrap{padding:16px; max-width:1200px; margin:0 auto}
    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; box-shadow:0 2px 6px rgba(0,0,0,.05); margin-top:12px}
    .card-title{margin:0 0 8px; font-weight:700; color:#111827}
    .grid{display:grid; gap:10px; grid-template-columns:1fr 1fr 1fr 1fr}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input[type=file]{width:100%; padding:10px; border-radius:10px; border:1px dashed var(--border); background:#fff; color:var(--text)}
    button{height:38px; border-radius:10px; border:1px solid var(--border);
      background:radial-gradient(120% 120% at 0% 0%,rgba(34,211,238,.25),rgba(34,211,238,.1));
      color:#0f172a; font-weight:700; cursor:pointer; padding:0 12px;}
    button:disabled{opacity:.5; cursor:not-allowed}
    .right{display:flex; gap:8px; justify-content:flex-end}

    .summary{display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-top:6px}
    .metric{padding:12px; border-radius:12px; background:#fff; border:1px solid var(--border)}
    .metric h3{margin:0; font-size:12px; color:var(--muted)}
    .metric p{margin:6px 0 0; font-size:22px; font-weight:800}

    .table-card{overflow:auto; margin-top:10px}
    table{width:100%; border-collapse:collapse; table-layout:fixed;
      background:#fff; border:1px solid var(--border); border-radius:12px; overflow:hidden;}
    th,td{border-bottom:1px solid var(--border); padding:10px 8px; text-align:center; word-break:keep-all; white-space:normal; font-size:12px;}
    th{position:sticky; top:0; background:var(--thead); z-index:1; color:#0f172a}
    tbody tr:hover td{background:var(--hover)}

    tbody tr.whole, tbody tr.room1, tbody tr.room2, tbody tr.room3, tbody tr.room4, tbody tr.room5{ background:transparent !important; }
    tbody td[rowspan]{ border-top:3px solid var(--group) !important; }
    tbody tr:first-child td[rowspan]{ border-top:1px solid var(--border) !important; }
    @supports(selector(tbody tr:has(td[rowspan]))){
      tbody tr:has(td[rowspan]) td{ border-top:3px solid var(--group) !important; }
      tbody tr:first-child:has(td[rowspan]) td{ border-top:1px solid var(--border) !important; }
    }

    .compact table thead .dist-col{display:none}
    .compact table tbody .dist-col{display:none}
    .compact table thead .dist-merged{display:table-cell}
    .compact table tbody .dist-merged{display:table-cell}
    .dist-merged{display:none}

    @media (max-width:899px){
      .grid{grid-template-columns:1fr}
      th,td{font-size:11px}
    }

    /* âœ… ì¸ì‡„ìš© */
    @media print {
      body { background: #fff; }
      .no-print { display: none !important; }
      .card { box-shadow: none; border-color: #ddd; }
      .table-card { break-inside: avoid; page-break-inside: avoid; }
      table { page-break-inside: auto; }
    }
  
/* ===== JINSUL ê³µí†µ ìŠ¤íƒ€ì¼(ë¡œê³ /ì›Œí„°ë§ˆí¬/í‘œ íˆ¬ëª…ë„ í†µì¼) ===== */
header .logo{
  width:170px;
  max-width:70vw;
  height:auto;
  display:block;
  margin:0 auto 10px;
  filter: grayscale(1) saturate(0) brightness(.45) contrast(1.15);
}
.wm{
  position:fixed;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  pointer-events:none;
  z-index:0;
}
.wm img{
  width:min(760px, 78vw);
  opacity:.10;
  user-select:none;
  filter: grayscale(1) saturate(0) brightness(.65) contrast(1.05);
}
body > *{ position:relative; z-index:1; }

table{ background: rgba(255,255,255,.50) !important; }
th{ background: rgba(243,244,246,.70) !important; }
td{ background: rgba(255,255,255,.50) !important; }
.table-card, .card, .panel, .result, .results, .output, .box, .section{
  background: rgba(255,255,255,.50) !important;
}

.wm{ z-index:0 !important; }
header, .wrap, main, footer{ z-index:1; }

</style>
<style id="jinsul-unify-v3">
:root{
  --jinsul-logo-width:170px;
  --jinsul-wm-opacity:0.075; /* ì›Œí„°ë§ˆí¬ ë¹„ì¹¨(ì „ì²´ ê³µí†µ) */
  --jinsul-panel-alpha:0.86; /* ì¹´ë“œ/ì„¹ì…˜ ë°°ê²½ */
  --jinsul-th-alpha:0.90;    /* í…Œì´ë¸” í—¤ë” */
  --jinsul-td-alpha:0.82;    /* í…Œì´ë¸” ì…€(ë°ì´í„°) */
}

/* ì›Œí„°ë§ˆí¬(ë°°ê²½) */
.wm{
  position:fixed !important;
  inset:0 !important;
  display:flex !important;
  align-items:center !important;
  justify-content:center !important;
  pointer-events:none !important;
  z-index:0 !important;
}
.wm img{
  width:min(760px, 86vw) !important;
  height:auto !important;
  opacity:var(--jinsul-wm-opacity) !important;
  filter:grayscale(1) saturate(0) brightness(.55) contrast(1.15) !important;
  user-select:none !important;
}

/* ë³¸ë¬¸ì€ ì›Œí„°ë§ˆí¬ ìœ„ë¡œ */
body > *{ position:relative; z-index:1; }

/* ìƒë‹¨ ë¡œê³  í†µì¼(íšŒìƒ‰/ë™ì¼í¬ê¸°) */
header, .jinsul-topbrand{
  text-align:center !important;
}
header img.logo,
header .logo,
.jinsul-topbrand img,
img[src*="jinsul-logo"]{
  width:var(--jinsul-logo-width) !important;
  max-width:70vw !important;
  height:auto !important;
  display:block !important;
  margin:0 auto 10px !important;
  filter:grayscale(1) saturate(0) brightness(.45) contrast(1.15) !important;
}

/* ì¹´ë“œ/ì„¹ì…˜ ë°°ê²½ì„ ë„ˆë¬´ íˆ¬ëª…í•˜ê²Œ ë§Œë“¤ì§€ ì•Šê¸°(í‘œ ì•ˆì—ì„œë„ "ì ë‹¹íˆ ë¹„ì¹¨") */
.section, .card, .panel, .box, .container, .wrap, main section{
  background: rgba(255,255,255,var(--jinsul-panel-alpha)) !important;
}

/* í…Œì´ë¸”ì€ ì…€ ë‹¨ìœ„ë¡œ í°ìƒ‰ ë°˜íˆ¬ëª…(ìˆ«ì ê°€ë…ì„± í™•ë³´ + ì›Œí„°ë§ˆí¬ ì€ì€) */
table{
  background: rgba(255,255,255,var(--jinsul-panel-alpha)) !important;
}
th{
  background: rgba(255,255,255,var(--jinsul-th-alpha)) !important;
}
td{
  background: rgba(255,255,255,var(--jinsul-td-alpha)) !important;
}

/* í…Œì´ë¸” ì•ˆ ê¸€ì ê°€ë…ì„±(ì‚´ì§) */
table, th, td{ color: inherit; }
</style>

<style>
.watermark{
  position:fixed;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  pointer-events:none;
  z-index:0;
}
.watermark img{
  width:520px;
  opacity:0.10;
  filter:grayscale(100%);
}
header, main, section, table, .card, .container{
  position:relative;
  z-index:1;
}
table th{
  background: rgba(255,255,255,0.95) !important;
}
table td{
  background: rgba(255,255,255,0.90) !important;
}
</style>

</head>
<body>

<div class="watermark">
  <img src="jinsul-logo.png" alt="JINSUL">
</div>

  <div class="wm" aria-hidden="true"><img src="jinsul-logo.png" alt=""></div>
<header>
    <img src="jinsul-logo.png" alt="JINSUL" class="logo" />
    <h1>ì˜ì‚¬ë‘ ì—°ë ¹ë³„ í†µê³„</h1>
    <p class="sub">ì§„ë£Œì‹¤ë³„ ì—°ë ¹ í†µê³„ ë° ì£¼ì‚¬Â·ë‚´ì› í˜„í™©.</p>
  </header>

  <div class="wrap">
    <div class="card no-print">
      <div class="grid">
        <div>
          <label>ì´ˆì§„ íŒŒì¼(ì§„ë£Œì‹¤ë³„ ë˜ëŠ” ë‹´ë‹¹ì˜ë³„)</label>
          <label>ì§„ë£Œì‹¤ë³„ ë˜ëŠ” ë‹´ë‹¹ì˜ë³„ë¡œ ì´ˆì§„ íŒŒì¼ì„ ë°›ì•„ì£¼ì„¸ìš”</label>
          <label>ğŸš«ì§„ë£Œì‹¤ì´ ì—¬ëŸ¬ê°œë©´ ê¼­! ì§„ë£Œì‹¤ë³„ ì´ˆì§„ íŒŒì¼ ë°›ì•„ì£¼ì„¸ìš”ğŸš«</label>
          <input type="file" id="clinicFiles" multiple accept=".xlsx,.xls" />
        </div>
        <div>
          <label>ì£¼ì‚¬ íŒŒì¼</label>
          <label>ë¦¬ë„ì¹´ì¸, ì— ì¹´ì¸ ë“± ë³‘ì›ì—ì„œ ì“°ëŠ” ë§ˆì·¨ì œ ë°›ì•„ì£¼ì„¸ìš”</label>
          <label>â¤ï¸ì§„ë£Œì‹¤ë³„ë¡œ ë°›ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤â¤ï¸</label>     
          <input type="file" id="bFile" accept=".xlsx,.xls" />
        </div>
        <div>
          <label>ì´ í™˜ì(ì´ˆì§„+ì¬ì§„)</label>
          <label>ì´ˆì§„, ì¬ì§„ ì§„ì°°ë£Œ íŒŒì¼ ê°ê° ë°›ì•„ì„œ 1ê°œë¡œ í•©ì³ë„ ë©ë‹ˆë‹¤â—</label>
          <label>â¤ï¸ì§„ë£Œì‹¤ë³„ë¡œ ë°›ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤â¤ï¸</label>
          <input type="file" id="vFile" accept=".xlsx,.xls" />
        </div>
        <div>
          <label>ì—°ë½ì²˜ íŒŒì¼ (ì°¨íŠ¸ë²ˆí˜¸ + ì „í™”ë²ˆí˜¸)</label>
          <label>CSV / XLSX / XLS ì§€ì›</label>
          <input type="file" id="contactFile" accept=".csv,.xlsx,.xls" />
        </div>
      </div>
      <div class="right" style="margin-top:8px">
        <button id="runBtn">í†µê³„ ê³„ì‚°</button>
        <button id="toggleCompactBtn" title="í‘œë¥¼ í•œ í˜ì´ì§€ë¡œ ë³´ê¸°">ì»´íŒ©íŠ¸ ë³´ê¸°</button>
        <button id="downloadBtn" disabled>ê²°ê³¼ ë‹¤ìš´ë¡œë“œ(.xlsx)</button>
        <button id="clearBtn">ì´ˆê¸°í™”</button>
      </div>
      <p style="color:var(--muted);font-size:12px;margin:8px 0 0">âš ï¸ ëª¨ë“  íŒŒì¼ì€ ë¸Œë¼ìš°ì € ë‚´ì—ì„œë§Œ ì²˜ë¦¬ë©ë‹ˆë‹¤.</p>
    </div>

    <!-- ìƒë‹¨ ìš”ì•½ ì§€í‘œ -->
    <div class="summary" id="summary" style="display:none">
      <div class="metric"><h3>ì „ì²´ ì´ˆì§„í™˜ììˆ˜</h3><p id="m-total">-</p></div>
      <div class="metric"><h3>ì´ˆì§„ ì£¼ì‚¬ì²˜ë°©ë¥ </h3><p id="m-inj-rate">-</p></div>
      <div class="metric"><h3>ì´ˆì§„ í‰ê·  ë‚´ì›íšŸìˆ˜</h3><p id="m-visit-avg">-</p></div>
      <div class="metric"><h3>ì¬ë‚´ì›ìœ¨(2íšŒ ì´ìƒ)</h3><p id="m-revisit">-</p></div>
    </div>

    <!-- ì£¼ì‚¬ 1íšŒ ëŒ€ìƒ ì „í™”ë²ˆí˜¸ ë‹¤ìš´ë¡œë“œ -->
    <div style="margin-top:8px; display:none" id="exportSingleInjWrap">
      <button id="exportSingleInjBtn">ì´ˆì§„Â·ì£¼ì‚¬ 1íšŒ ëŒ€ìƒ ì „í™”ë²ˆí˜¸ ë‹¤ìš´ë¡œë“œ (CSV)</button>
      <span id="exportSingleInjCount" style="margin-left:8px; color:#6b7280; font-size:12px"></span>
    </div>

    <div class="card table-card">
      <h3 class="card-title">ìš”ì•½ í†µê³„ (ì „ì²´ / ê° ì§„ë£Œì‹¤)</h3>
      <div id="output"></div>
    </div>

    <div class="card table-card" id="ageCard">
      <h3 class="card-title">ì—°ë ¹ëŒ€ë³„ í†µê³„ (ì§„ë£Œì‹¤ë³„)</h3>
      <div id="byAgeOutput"></div>
    </div>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);

    /* ===== ìœ í‹¸ ===== */
    function excelDateToISO(v) {
      if (v == null || v === '') return '';
      if (typeof v === 'string') {
        const s = v.trim();
        if (!s) return '';
        const m = s.match(/(\\d{4})[^\\d]?(\\d{1,2})[^\\d]?(\\d{1,2})/);
        if (m) {
          const y = m[1], mo = String(m[2]).padStart(2,'0'), d = String(m[3]).padStart(2,'0');
          return \`\${y}-\${mo}-\${d}\`;
        }
        return s;
      }
      if (typeof v === 'number') {
        const utc_days = Math.floor(v - 25569);
        const utc_value = utc_days * 86400;
        const d = new Date(utc_value * 1000);
        const y=d.getUTCFullYear(), m=String(d.getUTCMonth()+1).padStart(2,'0'), dd=String(d.getUTCDate()).padStart(2,'0');
        return \`\${y}-\${m}-\${dd}\`;
      }
      if (v instanceof Date) {
        const y=v.getFullYear(), m=String(v.getMonth()+1).padStart(2,'0'), d=String(v.getDate()).padStart(2,'0');
        return \`\${y}-\${m}-\${d}\`;
      }
      return String(v);
    }

    function calculateAge(rrn) {
      if (!rrn || typeof rrn !== 'string') return null;
      const s = rrn.trim();
      if (!s.includes('-')) return null;
      const [ymd, tail] = s.split('-');
      if (!ymd || !tail || ymd.length !== 6 || tail.length < 1) return null;
      const g = tail[0];
      let century;
      if ('1256'.includes(g)) century=1900;
      else if ('3478'.includes(g)) century=2000;
      else return null;
      const yy=parseInt(ymd.slice(0,2),10), mm=parseInt(ymd.slice(2,4),10), dd=parseInt(ymd.slice(4,6),10);
      const birth = new Date(century+yy, mm-1, dd); if (isNaN(birth)) return null;
      const today=new Date();
      let age=today.getFullYear()-birth.getFullYear();
      const m=today.getMonth()-birth.getMonth();
      if (m<0 || (m===0 && today.getDate()<birth.getDate())) age--;
      return age;
    }

    function parseAgeFromBirthish(val){
      if (!val) return null;
      const s = String(val).replace(/\\D/g,'');
      if (s.length === 8) { // YYYYMMDD
        const y = parseInt(s.slice(0,4),10);
        if (!y) return null;
        const today = new Date();
        return today.getFullYear()-y;
      }
      if (s.length === 6) { // YYMMDD -> 1900s ê°€ì •
        const yy = parseInt(s.slice(0,2),10);
        const y = 1900 + yy;
        const today = new Date();
        return today.getFullYear()-y;
      }
      return null;
    }

    function getAgeBand(age) {
      if (age == null || isNaN(age)) return 'ë¯¸ìƒ';
      if (age < 18) return '0-18ì„¸ ë¯¸ë§Œ';
      if (age < 30) return '18ì„¸ ì´ìƒ~20ëŒ€';
      if (age < 40) return '30ëŒ€';
      if (age < 50) return '40ëŒ€';
      if (age < 60) return '50ëŒ€';
      if (age < 70) return '60ëŒ€';
      return '70ëŒ€ ì´ìƒ';
    }

    function buildCountMapByHeader(data, idHeaderCandidates, dateHeaderCandidates) {
      const countMap = {};
      if (!data || !data.length) return countMap;

      let headerRow = null, headerIdx = -1;
      for (let i=0;i<Math.min(15, data.length);i++){
        const row = data[i] || [];
        const joined = row.map(x=>String(x||'')).join('');
        if (/(ì°¨íŠ¸|ì± íŠ¸|ID|ì•„ì´ë””)/i.test(joined) || /(ì§„ë£Œì¼|ë‚´ì›ì¼|ë°©ë¬¸ì¼|ì¼ì)/.test(joined)) {
          headerRow = row; headerIdx = i; break;
        }
      }
      if (!headerRow) headerRow = data[0], headerIdx = 0;

      const headersLower = headerRow.map(h => String(h||'').toLowerCase());
      const findIdx = (cands) => {
        for (const c of cands) {
          const idx = headersLower.findIndex(h => h.includes(c));
          if (idx !== -1) return idx;
        }
        return -1;
      };

      const idIdx   = findIdx(idHeaderCandidates.map(s=>s.toLowerCase()));
      const dateIdx = findIdx(dateHeaderCandidates.map(s=>s.toLowerCase()));
      if (idIdx === -1 || dateIdx === -1) return countMap;

      const seen = new Set();
      const rows = data.slice(headerIdx+1);
      rows.forEach(r=>{
        const id = r[idIdx]?.toString().trim();
        const date = excelDateToISO(r[dateIdx]);
        if (!id || !date) return;
        const u = id + '_' + date;
        if (seen.has(u)) return;
        seen.add(u);
        countMap[id] = (countMap[id]||0)+1;
      });
      return countMap;
    }

    const toPercent = (a,b) => b ? Math.round(a/b*100)+'%' : '0%';
    const average = (arr) => arr.length ? arr.reduce((x,y)=>x+y,0)/arr.length : 0;
    function fmt(v){
      if (v===null || v===undefined) return '-';
      const s=String(v).trim();
      if (s==='' || /^nan/i.test(s) || /^nan%$/i.test(s)) return '-';
      if (!isNaN(Number(s)) && Number(s)===0) return '-';
      if (s==='0%') return '-';
      return s;
    }

    /* ===== ê³„ì‚° ===== */
    function computeStats(merged){
      const byRoom = { 'ì „ì²´':[...merged] };
      merged.forEach(r=>{ (byRoom[r.room]??=([])).push(r); });
      const result=[];
      for(const [label, total] of Object.entries(byRoom)){
        const inj = total.filter(r=>r.inj>0);
        const adult = total.filter(r=>(r.age??0)>=18);
        const adultInj = adult.filter(r=>r.inj>0);
        const avgInj = average(inj.map(r=>r.inj));
        const avgVisitAmongInj = average(inj.map(r=>r.visit));
        const visitAvgAll = average(total.map(r=>r.visit));
        const cnt1 = total.filter(r=>r.visit===1).length;
        const cnt2 = total.filter(r=>r.visit===2).length;
        const cnt3 = total.filter(r=>r.visit===3).length;
        const cnt4 = total.filter(r=>r.visit===4).length;
        const cnt5 = total.filter(r=>r.visit===5).length;
        const cnt6 = total.filter(r=>r.visit===6).length;
        const cnt7 = total.filter(r=>r.visit===7).length;
        const cnt8p= total.filter(r=>r.visit>=8).length;
        const revisit2pAll = total.filter(r=>r.visit>=2).length;
        const revisit2pInj = inj.filter(r=>r.visit>=2).length;
        result.push({
          'êµ¬ë¶„':label,
          'ì´ˆì§„í™˜ììˆ˜':total.length,
          'ì´ˆì§„ì£¼ì‚¬í™˜ììˆ˜':inj.length,
          'ì´ˆì§„ ì£¼ì‚¬ì²˜ë°©ë¥ ':toPercent(inj.length,total.length),
          'ì´ˆì§„ ì£¼ì‚¬í™˜ì í‰ê·  ì£¼ì‚¬íšŸìˆ˜':inj.length?avgInj.toFixed(1):'-',
          'ì´ˆì§„ ì£¼ì‚¬í™˜ì í‰ê· ë‚´ì›íšŸìˆ˜':inj.length?avgVisitAmongInj.toFixed(1):'-',
          'ì´ˆì§„ ì£¼ì‚¬í™˜ì ì¬ì§„ë¥ (2íšŒ ì´ìƒ)':inj.length?toPercent(revisit2pInj,inj.length):'-',
          '(18ì„¸â–²)ì´ˆì§„í™˜ììˆ˜':adult.length,
          '(18ì„¸â–²)ì´ˆì§„ì£¼ì‚¬ìˆ˜':adultInj.length,
          '(18ì„¸â–²)ì´ˆì§„ì£¼ì‚¬ì²˜ë°©ë¥ ':adult.length?toPercent(adultInj.length,adult.length):'-',
          'ì´ˆì§„ í‰ê·  ë‚´ì›íšŸìˆ˜':total.length?visitAvgAll.toFixed(1):'-',
          'ì´ˆì§„ ì¬ë‚´ì›ìœ¨':toPercent(revisit2pAll,total.length),
          '1íšŒ ë‚´ì›ìœ¨':toPercent(cnt1,total.length),
          '2íšŒ ë‚´ì›ìœ¨':toPercent(cnt2,total.length),
          '3íšŒ ë‚´ì›ìœ¨':toPercent(cnt3,total.length),
          '4íšŒ ë‚´ì›ìœ¨':toPercent(cnt4,total.length),
          '5íšŒ ë‚´ì›ìœ¨':toPercent(cnt5,total.length),
          '6íšŒ ë‚´ì›ìœ¨':toPercent(cnt6,total.length),
          '7íšŒ ë‚´ì›ìœ¨':toPercent(cnt7,total.length),
          '8íšŒ ì´ìƒ ë‚´ì›ìœ¨':toPercent(cnt8p,total.length)
        });
      }
      const order=['ì „ì²´','1ì§„ë£Œì‹¤','2ì§„ë£Œì‹¤','3ì§„ë£Œì‹¤','4ì§„ë£Œì‹¤','5ì§„ë£Œì‹¤','6ì§„ë£Œì‹¤','7ì§„ë£Œì‹¤','8ì§„ë£Œì‹¤','9ì§„ë£Œì‹¤','10ì§„ë£Œì‹¤'];
      result.sort((a,b)=>{const ai=order.indexOf(a['êµ¬ë¶„']),bi=order.indexOf(b['êµ¬ë¶„']);return (ai==-1)-(bi==-1)||ai-bi||a['êµ¬ë¶„'].localeCompare(b['êµ¬ë¶„'])});
      return result;
    }

    function computeAgeBandStats(merged){
      const byRoom = {};
      merged.forEach(r => {
        (byRoom[r.room] ??= []).push(r);
      });

      const roomKeys = Object.keys(byRoom).sort((a,b)=>{
        const na = parseInt(a,10), nb = parseInt(b,10);
        const an = !isNaN(na), bn = !isNaN(nb);
        if (an && bn) return na - nb;
        if (an) return -1;
        if (bn) return 1;
        return a.localeCompare(b);
      });

      const ORDER_BANDS = ['0-18ì„¸ ë¯¸ë§Œ','18ì„¸ ì´ìƒ~20ëŒ€','30ëŒ€','40ëŒ€','50ëŒ€','60ëŒ€','70ëŒ€ ì´ìƒ','ë¯¸ìƒ'];
      const rows = [];

      const toPercent = (num, den) => den ? Math.round((num/den)*100)+'%' : '0%';
      const average = (arr) => arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0;

      function pushBandRows(label, arr){
        const byBand = {};
        arr.forEach(x=>{
          const band = getAgeBand(x.age);
          (byBand[band] ??= []).push(x);
        });

        for (const band of ORDER_BANDS){
          const a = byBand[band] || [];
          if (!a.length) continue;
          const inj = a.filter(x=>x.inj>0);
          const injN = inj.length;
          const avgInj = injN ? average(inj.map(x=>x.inj)) : 0;
          const avgVisit = average(a.map(x=>x.visit));
          const revisit2p = a.filter(x=>x.visit>=2).length;

          const cnt = (n)=>inj.filter(x=> n===8 ? x.inj>=8 : x.inj===n).length;
          const rate = (n)=>toPercent(cnt(n), injN);

          rows.push({
            'ì§„ë£Œì‹¤': label,
            'ì—°ë ¹ëŒ€': band,
            'ì´ˆì§„í™˜ììˆ˜': a.length,
            'ì´ˆì§„ì£¼ì‚¬í™˜ììˆ˜': injN,
            'ì´ˆì§„ ì£¼ì‚¬ì²˜ë°©ë¥ ': toPercent(injN, a.length),
            'ì´ˆì§„ í‰ê·  ë‚´ì›íšŸìˆ˜': avgVisit.toFixed(1),
            'ì´ˆì§„ ì¬ë‚´ì›ìœ¨(2íšŒ ì´ìƒ)': toPercent(revisit2p, a.length),
            'ì´ˆì§„ ì£¼ì‚¬í™˜ì í‰ê·  ì£¼ì‚¬íšŸìˆ˜': avgInj.toFixed(1),
            'ì£¼ì‚¬ 1íšŒ(%)': rate(1),
            '2íšŒ(%)': rate(2),
            '3íšŒ(%)': rate(3),
            '4íšŒ(%)': rate(4),
            '5íšŒ(%)': rate(5),
            '6íšŒ(%)': rate(6),
            '7íšŒ(%)': rate(7),
            '8íšŒ ì´ìƒ(%)': rate(8)
          });
        }

        if (arr.length){
          const injAll = arr.filter(x=>x.inj>0);
          const injAllN = injAll.length;
          const avgInjAll = injAllN ? average(injAll.map(x=>x.inj)) : 0;
          const avgVisitAll = average(arr.map(x=>x.visit));
          const revisit2pAll = arr.filter(x=>x.visit>=2).length;

          const cntA = (n)=>injAll.filter(x=> n===8 ? x.inj>=8 : x.inj===n).length;
          const rateA = (n)=>toPercent(cntA(n), injAllN);

          rows.push({
            'ì§„ë£Œì‹¤': label,
            'ì—°ë ¹ëŒ€': 'ì „ì²´',
            'ì´ˆì§„í™˜ììˆ˜': arr.length,
            'ì´ˆì§„ì£¼ì‚¬í™˜ììˆ˜': injAllN,
            'ì´ˆì§„ ì£¼ì‚¬ì²˜ë°©ë¥ ': toPercent(injAllN, arr.length),
            'ì´ˆì§„ í‰ê·  ë‚´ì›íšŸìˆ˜': avgVisitAll.toFixed(1),
            'ì´ˆì§„ ì¬ë‚´ì›ìœ¨(2íšŒ ì´ìƒ)': toPercent(revisit2pAll, arr.length),
            'ì´ˆì§„ ì£¼ì‚¬í™˜ì í‰ê·  ì£¼ì‚¬íšŸìˆ˜': avgInjAll.toFixed(1),
            'ì£¼ì‚¬ 1íšŒ(%)': rateA(1),
            '2íšŒ(%)': rateA(2),
            '3íšŒ(%)': rateA(3),
            '4íšŒ(%)': rateA(4),
            '5íšŒ(%)': rateA(5),
            '6íšŒ(%)': rateA(6),
            '7íšŒ(%)': rateA(7),
            '8íšŒ ì´ìƒ(%)': rateA(8)
          });
        }
      }

      for (const room of roomKeys){
        pushBandRows(room, byRoom[room]);
      }

      if (merged.length){
        pushBandRows('ì „ì²´', merged);
      }

      return rows;
    }

    /* ===== ë Œë” ===== */
    function renderTableSimple(data){
      if (!data.length) return '';
      const headers = Object.keys(data[0]);
      let thead = '<tr>' + headers.map(h=>\`<th>\${h}</th>\`).join('') + '</tr>';
      let tbody = data.map(row=>(
        '<tr>' + headers.map(h=>\`<td>\${fmt(row[h])}</td>\`).join('') + '</tr>'
      )).join('');
      return \`<table><thead>\${thead}</thead><tbody>\${tbody}</tbody></table>\`;
    }

    function renderTableGrouped(data, opts={}){
      if (!data.length) return '';
      const headers = Object.keys(data[0]);
      const isCompact = !!opts.compact;
      const distCols = ['ì£¼ì‚¬ 1íšŒ(%)','2íšŒ(%)','3íšŒ(%)','4íšŒ(%)','5íšŒ(%)','6íšŒ(%)','7íšŒ(%)','8íšŒ ì´ìƒ(%)'];

      let thead = '<tr><th>ì§„ë£Œì‹¤</th>';
      headers.slice(1).forEach(h=>{
        const cls = distCols.includes(h) ? 'dist-col' : '';
        thead += \`<th class="\${cls}">\${h}</th>\`;
      });
      if (isCompact) thead += '<th class="dist-merged">ì£¼ì‚¬ íšŒì°¨ ë¶„í¬</th>';
      thead += '</tr>';

      const counts = {};
      data.forEach(r => { counts[r['ì§„ë£Œì‹¤']] = (counts[r['ì§„ë£Œì‹¤']] || 0) + 1; });

      let prev = null, tbody = '';
      data.forEach(row=>{
        let tr = '<tr>';
        if (row['ì§„ë£Œì‹¤'] !== prev){
          tr += \`<td rowspan="\${counts[row['ì§„ë£Œì‹¤']]}">\${row['ì§„ë£Œì‹¤']}</td>\`;
          prev = row['ì§„ë£Œì‹¤'];
        }
        headers.slice(1).forEach(h=>{
          const cls = distCols.includes(h) ? 'dist-col' : '';
          tr += \`<td class="\${cls}">\${fmt(row[h])}</td>\`;
        });
        if (isCompact){
          const merged = distCols.map(k=>\`\${k.replace('(%)','')}:\${fmt(row[k])}\`).join(' Â· ');
          tr += \`<td class="dist-merged">\${merged}</td>\`;
        }
        tr += '</tr>';
        tbody += tr;
      });

      return \`<table><thead>\${thead}</thead><tbody>\${tbody}</tbody></table>\`;
    }

    /* ===== íŒŒì¼ ì²˜ë¦¬ & ì‹¤í–‰ ===== */
    async function readXlsx(file){
      const ab = await file.arrayBuffer();
      const wb = XLSX.read(ab, { type:'array' });
      const sheet = wb.Sheets[wb.SheetNames[0]];
      return XLSX.utils.sheet_to_json(sheet, { header:1, raw:true, defval:'' });
    }

    function normalizeRoomName(filename){
      const base = filename.replace(/\\.(xlsx|xls)$/i, '').replace(/ì§„ë£Œì‹¤/g, '').trim();
      const onlyNum = base.match(/\\d+/)?.[0] ?? base;
      return \`\${onlyNum}ì§„ë£Œì‹¤\`;
    }

    function exportXlsx(sheets, filename='ì´ˆì§„_ì£¼ì‚¬_ë‚´ì›_í†µê³„.xlsx'){
      const wb = XLSX.utils.book_new();
      for(const {name,rows} of sheets){
        const ws = XLSX.utils.json_to_sheet(rows);
        XLSX.utils.book_append_sheet(wb, ws, name);
      }
      XLSX.writeFile(wb, filename);
    }

    async function processFiles(){
      const clinicFiles=$('#clinicFiles').files;
      const bFile=$('#bFile').files[0];
      const vFile=$('#vFile').files[0];
      const cFile=$('#contactFile').files[0];

      if(!clinicFiles.length){ alert('ì§„ë£Œì‹¤ íŒŒì¼ì€ ë°˜ë“œì‹œ ì—…ë¡œë“œí•´ì•¼ í•©ë‹ˆë‹¤'); return; }
      $('#runBtn').disabled=true; $('#runBtn').textContent='ê³„ì‚° ì¤‘â€¦';
      try{
        const clinic=[]; for(const f of clinicFiles){ clinic.push({name:normalizeRoomName(f.name), data:await readXlsx(f)}); }
        const b = bFile? await readXlsx(bFile):null;
        const v = vFile? await readXlsx(vFile):null;

        let phoneMap = {};
        if (cFile){
          const contGrid = await readAnyGrid(cFile);
          phoneMap = buildPhoneMapFromGrid(contGrid);
        }

        runAnalysis({clinic,b,v, phoneMap});
      }catch(e){ console.error(e); alert('íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
      finally{ $('#runBtn').disabled=false; $('#runBtn').textContent='í†µê³„ ê³„ì‚°'; }
    }

    function runAnalysis(fileMap){
      const seen=new Set(); const clinicRows=[];

      fileMap.clinic.forEach(room=>{
        let headerIndex = fileMapHeaderIndex(room.data, /(ì°¨íŠ¸|ì± íŠ¸).*ë²ˆí˜¸|ì°¨íŠ¸ë²ˆí˜¸|ì± íŠ¸ë²ˆí˜¸/i);
        if (headerIndex < 0) headerIndex = 0;
        const header = room.data[headerIndex] || [];
        const headersLower = header.map(h=>String(h||'').toLowerCase());

        const idIdx   = findHeaderIndex(headersLower, ['ì°¨íŠ¸','ì± íŠ¸','id','ì•„ì´ë””']);
        const rrnIdx  = findHeaderIndex(headersLower, ['ì£¼ë¯¼','ìƒë…„','ìƒì¼','ìƒë…„ì›”ì¼','ìƒë…„ì›”','rrn','ë“±ë¡ë²ˆí˜¸']);

        const rows = room.data.slice(headerIndex+1).filter(r => Array.isArray(r) && r.length > 0);

        rows.forEach(r=>{
          const id = idIdx>=0 ? r[idIdx]?.toString().trim() : r[0]?.toString().trim();
          if (!id) return;

          const rrnRaw = rrnIdx>=0 ? (r[rrnIdx]?.toString().trim()||'') : '';
          let age = null;
          if (rrnRaw && rrnRaw.includes('-')) age = calculateAge(rrnRaw);
          else if (rrnRaw) age = parseAgeFromBirthish(rrnRaw);

          if (age===null || isNaN(age) || age<0 || age>120) return;

          const key = id + '_' + room.name;
          if (seen.has(key)) return;
          seen.add(key);

          clinicRows.push({ id, age, room: room.name });
        });
      });

      const bMap = fileMap.b
        ? buildCountMapByHeader(fileMap.b,
            ['ì°¨íŠ¸','ì± íŠ¸','id','ì•„ì´ë””'],
            ['ì§„ë£Œì¼','ë‚´ì›ì¼','ë°©ë¬¸ì¼','ì¼ì','ìˆ˜ë‚©ì¼'])
        : {};
      const vMap = fileMap.v
        ? buildCountMapByHeader(fileMap.v,
            ['ì°¨íŠ¸','ì± íŠ¸','id','ì•„ì´ë””'],
            ['ì§„ë£Œì¼','ë‚´ì›ì¼','ë°©ë¬¸ì¼','ì¼ì','ìˆ˜ë‚©ì¼'])
        : {};

      const merged = clinicRows.map(r=>({
        id:r.id, age:r.age, room:r.room,
        inj:bMap[r.id]||0, visit:vMap[r.id]||0
      }));

      const stats = computeStats(merged);
      const byAge = computeAgeBandStats(merged);

      const singleInj = merged.filter(r => r.inj === 1);

      (function setupSingleInjExport(){
        const $wrap = document.getElementById('exportSingleInjWrap');
        const $btn  = document.getElementById('exportSingleInjBtn');
        const $cnt  = document.getElementById('exportSingleInjCount');
        if (!$wrap || !$btn) return;

        const phoneMap = fileMap.phoneMap || {};
        const uniq = Array.from(new Set(singleInj.map(x=>x.id)))
                          .map(id => ({ id, phone: phoneMap[id] }))
                          .filter(x => x.phone && x.phone.replace(/\\D+/g,'').length>=10);

        $cnt.textContent = uniq.length ? \`ëŒ€ìƒ \${uniq.length}ê±´\` : '';
        $wrap.style.display = uniq.length ? 'block' : 'none';

        $btn.onclick = ()=>{
          if (!uniq.length) return;
          let csv = 'chart_id,phone\\n' + uniq.map(x => \`\${x.id},\${x.phone}\`).join('\\n');
          const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
          const url  = URL.createObjectURL(blob);
          const a = document.createElement('a');
          const yymm = new Date().toISOString().slice(0,7);
          a.href = url; a.download = \`single-injection-phones_\${yymm}.csv\`;
          document.body.appendChild(a); a.click(); a.remove();
          URL.revokeObjectURL(url);
        };
      })();

      const overall = stats.find(s=>s['êµ¬ë¶„']==='ì „ì²´');
      if (overall){
        $('#summary').style.display='grid';
        $('#m-total').textContent=fmt(overall['ì´ˆì§„í™˜ììˆ˜']);
        $('#m-inj-rate').textContent=fmt(overall['ì´ˆì§„ ì£¼ì‚¬ì²˜ë°©ë¥ ']);
        $('#m-visit-avg').textContent=fmt(overall['ì´ˆì§„ í‰ê·  ë‚´ì›íšŸìˆ˜']);
        $('#m-revisit').textContent=fmt(overall['ì´ˆì§„ ì¬ë‚´ì›ìœ¨']);
      }

      $('#output').innerHTML = renderTableSimple(stats);
      const isCompact = $('#ageCard').classList.contains('compact');
      $('#byAgeOutput').innerHTML = renderTableGrouped(byAge, { compact: isCompact });

      const downloadBtn=$('#downloadBtn');
      downloadBtn.disabled=false;
      downloadBtn.onclick=()=>exportXlsx([
        { name:'ìš”ì•½_ì§„ë£Œì‹¤', rows: stats },
        { name:'ì—°ë ¹ëŒ€ë³„_ì§„ë£Œì‹¤', rows: byAge }
      ]);
    }

    function fileMapHeaderIndex(data, regex){
      for (let i=0;i<Math.min(15, data.length);i++){
        const row = data[i]||[];
        const joined = row.map(x=>String(x||'')).join('');
        if (regex.test(joined)) return i;
      }
      return Math.min(4, data.length-1);
    }

    function findHeaderIndex(headersLower, keywords){
      for (const kw of keywords){
        const idx = headersLower.findIndex(h => h.includes(kw));
        if (idx !== -1) return idx;
      }
      return -1;
    }

    /* ===== ì—°ë½ì²˜ CSV/XLSX/XLS ì½ê¸° & ì—´ ê°ì§€ ===== */
    function detectChartCol(headers){
      const keys = ['ì°¨íŠ¸','ì± íŠ¸','id','í™˜ì','ë“±ë¡'];
      for (const h of headers){
        const s = String(h||'').toLowerCase();
        if (keys.some(k => s.includes(k))) return h;
      }
      return null;
    }

    function detectPhoneCol(headers){
      const keys = ['ì „í™”','ì—°ë½','íœ´ëŒ€','í•¸ë“œ','í•¸ë“œí°','mobile','phone','tel'];
      for (const h of headers){
        const s = String(h||'').toLowerCase();
        if (keys.some(k => s.includes(k))) return h;
      }
      return null;
    }

    function normalizeKRPhone(raw){
      if (!raw) return '';
      let d = String(raw).replace(/\\D+/g,'');
      if (/^82/.test(d)) d = '0' + d.slice(2);
      if (d.length === 11) return d.replace(/(\\d{3})(\\d{4})(\\d{4})/, '$1-$2-$3');
      if (d.length === 10) return d.replace(/(\\d{2,3})(\\d{3,4})(\\d{4})/, '$1-$2-$3');
      return d;
    }

    async function readAnyGrid(file){
      const name = file.name.toLowerCase();
      const buf = await file.arrayBuffer();
      const isCSV = name.endsWith('.csv');
      const wb = isCSV
        ? XLSX.read(new TextDecoder('utf-8').decode(new Uint8Array(buf)), { type:'string' })
        : XLSX.read(buf, { type:'array' });
      const all = [];
      wb.SheetNames.forEach(s=>{
        const ws = wb.Sheets[s];
        const arr = XLSX.utils.sheet_to_json(ws, { header:1, defval:"" });
        all.push(...arr);
      });
      return all;
    }

    function findContactHeaderIndex(rows){
      return rows.findIndex(row=>{
        const cells = row.map(c => String(c||'').toLowerCase());
        const hasChart = cells.some(c => /ì°¨íŠ¸|ì± íŠ¸|í™˜ì|ë“±ë¡|id/.test(c));
        const hasPhone = cells.some(c => /ì „í™”|ì—°ë½|íœ´ëŒ€|í•¸ë“œ|mobile|phone|tel/.test(c));
        return hasChart && hasPhone;
      });
    }

    function buildPhoneMapFromGrid(rows){
      const hi = findContactHeaderIndex(rows);
      if (hi === -1) return {};
      const headers = rows[hi].map(h => String(h).trim());
      const body = rows.slice(hi+1).filter(r => r.length>1);
      const chartCol = detectChartCol(headers);
      const phoneCol = detectPhoneCol(headers);
      if (!chartCol || !phoneCol) return {};
      const map = {};
      body.forEach(r=>{
        const obj = Object.fromEntries(headers.map((h,i)=>[h, r[i] ?? '']));
        const id = String(obj[chartCol] ?? '').trim();
        let ph = normalizeKRPhone(obj[phoneCol]);
        const d = ph.replace(/\\D+/g,'');
        if (!id) return;
        if (d.length>=10 && d.length<=11) map[id]=ph;
      });
      return map;
    }

    // ì´ë²¤íŠ¸
    document.getElementById('runBtn').addEventListener('click', processFiles);
    document.getElementById('clearBtn').addEventListener('click', ()=>{
      $('#clinicFiles').value=''; $('#bFile').value=''; $('#vFile').value=''; $('#contactFile').value='';
      $('#output').innerHTML=''; $('#byAgeOutput').innerHTML='';
      $('#summary').style.display='none'; $('#downloadBtn').disabled=true;
      $('#exportSingleInjWrap').style.display='none'; $('#exportSingleInjCount').textContent='';
    });
    document.getElementById('toggleCompactBtn').addEventListener('click', ()=>{
      const card = $('#ageCard');
      card.classList.toggle('compact');
      const isCompact = card.classList.contains('compact');
      $('#toggleCompactBtn').textContent = isCompact ? 'ìƒì„¸ ì—´ ë³´ê¸°' : 'ì»´íŒ©íŠ¸ ë³´ê¸°';
    });
  </script>
</body>
</html>
