<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>JINSUL - 전략 분석 시스템 (v 0.0.5.0)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root { --blue: #228be6; --border: rgba(0, 0, 0, 0.1); --text: #1f2937; --gray: #868e96; }
    * { box-sizing: border-box; font-family: system-ui, sans-serif; }
    body { margin: 0; background: #f8f9fa; color: var(--text); min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden; }

    .version-tag { position: absolute; top: 10px; left: 10px; font-size: 10px; color: var(--gray); opacity: 0.5; font-weight: bold; }

    .watermark { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 550px; opacity: 0.1; z-index: -1; pointer-events: none; filter: grayscale(1); }

    header { padding: 40px 0 20px; text-align: center; }
    header img { width: 180px; filter: grayscale(1) brightness(0.5); margin-bottom: 10px; }

    .container { max-width: 1260px; margin: 0 auto; padding: 0 10px; flex: 1; width: 100%; }

    .card { background: rgba(255, 255, 255, 0); padding: 14px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 10px; }
    .card h2 { margin: 0 0 10px; font-size: 16px; border-left: 4px solid var(--blue); padding-left: 10px; }

    .drop-zone {border: 2px dashed #cbd5e1; padding: 26px; text-align: center; border-radius: 10px; background: rgba(255, 255, 255, 0.5); cursor: pointer; display:flex; flex-direction:column; align-items:center; justify-content:center; width:100%; box-sizing:border-box; min-height:96px; }
    .drop-zone.active { border-color: var(--blue); background: rgba(34, 139, 230, 0.1); }

    .cards-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 20px; }
    @media (max-width: 980px){ .cards-grid{ grid-template-columns: 1fr; } }

    .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(190px, 1fr)); gap: 8px; margin-bottom: 10px; }
    .dash-item { background: #fff; padding: 12px; border-radius: 10px; border: 1px solid var(--border); text-align: center; }
    .dash-item .val { font-size: 24px; font-weight: 800; color: var(--blue); }
    .dash-item .sub { font-size: 11px; color: var(--gray); margin-top: 3px; }

    .price-btn { padding: 5px 10px; border-radius: 6px; border: 1px solid #dee2e6; background: #fff; cursor: pointer; font-size: 12px; margin: 2px; transition: 0.2s; }
    .price-btn.active { background: var(--blue); color: #fff; border-color: var(--blue); font-weight: bold; box-shadow: 0 2px 4px rgba(34, 139, 230, 0.3); }

    .price-btn.excl-btn { border-style: dashed; }
    .price-btn.excl-btn.active { background: var(--gray); color: #fff; border-color: var(--gray); box-shadow: none; font-weight: bold; }

    .filter-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    @media (max-width: 980px){ .filter-grid{ grid-template-columns: 1fr; } }

    table { width: 100%; border-collapse: collapse; background: transparent; table-layout: fixed; }
    th { background: rgba(241, 243, 245, 0.85); padding: 7px 6px; border: 1px solid #dee2e6; text-align: center; font-size: 12px; }
    td { padding: 7px 6px; border: 1px solid var(--border); font-size: 12px; text-align: center; }
    .total-col { background: rgba(34, 139, 230, 0.1); font-weight: bold; }
    .total-row td { background: rgba(34, 139, 230, 0.08); font-weight: bold; }
    .hidden { display: none; }
    .file-hidden{ position:absolute; left:-9999px; width:1px; height:1px; overflow:hidden; }

    footer { text-align: center; padding: 30px 20px; color: var(--gray); font-size: 0.95rem; font-weight: 500; width: 100%; position: relative; z-index: 10; }
  
    .subtablesGrid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); gap:12px; }
    .miniCard{ border:1px solid #e9ecef; border-radius: 10px; background:#fff; padding:10px; }
    .miniTitle{ font-weight:700; margin:0 0 6px 0; display:flex; justify-content:space-between; align-items:baseline; font-size:13px; }
    .miniSub{ font-weight:500; color:#666; font-size:12px; }
    .mini-table{ width:100%; border-collapse:collapse; table-layout:fixed; }
    .mini-table th, .mini-table td{ padding:6px 6px; font-size:12px; }
    .mini-table th{ white-space:nowrap; }
    .table-scroll{ overflow-x:auto; }
    .proposalWrap{ display:grid; grid-template-columns: 1fr; gap:12px; align-items:start; }
    
    .proposalPanel{ background: rgba(255,255,255,0.75); border:1px solid #d0ebff; border-radius: 12px; padding:12px; }
    @media (max-width: 900px){ .proposalWrap{ grid-template-columns: 1fr; } .subtablesGrid{ grid-template-columns: 1fr; } }
    .followSummary{ background: rgba(255,255,255,0.75); border:1px solid #d0ebff; border-radius: 12px; padding:12px; }
    .followSummary .title{ font-weight:700; margin-bottom:6px; }
    .followSummary ol{ margin:0; padding-left:18px; }
    .followSummary li{ margin:0 0 8px 0; }
    .followSummary .meta{ font-size:12px; color:#555; margin-top:2px; }
    
    .cardHeaderRow{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .toggleBtn{ border:1px solid #cfe3ff; background:#fff; padding:6px 10px; border-radius:10px; font-size:12px; cursor:pointer; }
    .toggleBtn:hover{ background:#f8fbff; }
    .collapseWrap.collapsed{ display:none; }
    .kpiRowLabel{ font-weight:600; }
  </style>
</head>
<body>
  <div class="version-tag">v0.0.5.0</div>
  <img src="jinsul-logo.png" class="watermark" alt="bg" />
  <header>
    <img src="jinsul-logo.png" alt="logo" />
    <div style="font-weight: bold; font-size: 18px;">신환 전략 분석 리포트</div>
  </header>

  <div class="container">
    <div class="card">
      <label class="drop-zone" id="dropZone" for="fileInput">
        <strong id="statusText">데이터 업로드 (화면 전체 드롭 가능)</strong>
        <input type="file" id="fileInput" class="file-hidden" accept=".csv, .xlsx, .xls" />
      </label>
    </div>

    <div id="dashArea" class="dashboard-grid hidden">
      <div class="dash-item">
        <div style="font-size:12px;color:var(--gray);">신환 수</div>
        <div id="v-count" class="val">0</div>
        <div id="v-count-sub" class="sub"></div>
      </div>
      <div class="dash-item">
        <div style="font-size:12px;color:var(--gray);">2회차 전환율</div>
        <div id="v-conv" class="val">0%</div>
        <div id="v-conv-sub" class="sub"></div>
      </div>
      <div class="dash-item">
        <div style="font-size:12px;color:var(--gray);">3회차 도달율</div>
        <div id="v-ret" class="val">0%</div>
        <div id="v-ret-sub" class="sub"></div>
      </div>
      <div class="dash-item">
        <div style="font-size:12px;color:var(--gray);">주사치료 병행 비율</div>
        <div id="v-combo" class="val">0%</div>
        <div id="v-combo-sub" class="sub"></div>
      </div>
      <div class="dash-item">
        <div style="font-size:12px;color:var(--gray);">평균 치료 횟수</div>
        <div id="v-avgV" class="val">0.0</div>
        <div class="sub">치료일 기준</div>
      </div>
      <div class="dash-item">
        <div style="font-size:12px;color:var(--gray);">중간값 치료 횟수</div>
        <div id="v-medV" class="val">0</div>
        <div class="sub">치료일 기준</div>
      </div>
      <div class="dash-item">
        <div style="font-size:12px;color:var(--gray);">가장 흔한 치료 횟수(최빈값)</div>
        <div id="v-modeV" class="val">-</div>
        <div id="v-modeV-sub" class="sub"></div>
      </div>
      <div class="dash-item">
        <div style="font-size:12px;color:var(--gray);">7일 내 재방문율</div>
        <div id="v-r7" class="val">0%</div>
        <div id="v-r7-sub" class="sub"></div>
      </div>
      <div class="dash-item">
        <div style="font-size:12px;color:var(--gray);">14일 내 재방문율</div>
        <div id="v-r14" class="val">0%</div>
        <div id="v-r14-sub" class="sub"></div>
      </div>
    </div>

    <div id="filterArea" class="card hidden">
      <h2>치료 금액 선택</h2>
      <div class="filter-grid">
        <div>
          <div style="font-size:13px;color:var(--gray);margin-bottom:6px;">포함할 치료 금액 (단일 선택)</div>
          <div id="priceBtns"></div>
        </div>
        <div>
          <div style="font-size:13px;color:var(--gray);margin-bottom:6px;">제외할 치료 금액 (복수 선택)</div>
          <div id="excludeBtns"></div>
          <div style="font-size:12px;color:var(--gray);margin-top:4px;">※ 제외된 금액으로 시작한 신환은 분석에서 제외됩니다.</div>
        </div>
      </div>
    </div>

    <div id="mainContent" class="hidden">
      <div class="cards-grid">
        <div class="card"><h2>표 1. 부위별 치료 횟수</h2><div style="overflow-x:auto;"><table id="table1"></table></div></div>
        <div class="card"><h2>표 1-1. 치료사별·부위별 치료 횟수</h2><div style="overflow-x:auto;"><table id="table1a"></table></div></div>
        <div class="card"><h2>표 1-2. 치료사별·부위별 치료 비율</h2><div style="overflow-x:auto;"><table id="table1b"></table></div></div>
        
        <div class="card free-card-main"><div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;"><h2 style="margin:0;">표 1-3. Free(기타여부) → 유료 전환 (전체)</h2><button id="freeToggleBtn" class="price-btn" type="button">펼치기</button></div><div id="freeTablesMain" style="overflow-x:auto;margin-top:8px;"><table id="table1c"></table></div></div>
        <div class="card free-card-extra"><h2>표 1-4. Free(기타여부) → 유료 전환 (연령대별)</h2><div style="overflow-x:auto;"><table id="table1d"></table></div></div>
        <div class="card free-card-extra"><h2>표 1-5. Free(기타여부) → 유료 전환 (부위별)</h2><div style="overflow-x:auto;"><table id="table1e"></table></div></div>
        <div class="card free-card-extra"><h2>표 1-6. Free(기타여부) → 유료 전환 (치료사별)</h2><div style="overflow-x:auto;"><table id="table1f"></table></div></div>
        
        <div class="card"><h2>표 1-7. 치료사별·부위별 3회차 도달율</h2><div style="overflow-x:auto;"><table id="table1g"></table></div></div>

        <div class="card"><h2>표 2. 신환 상세 통계 및 재진 전환율</h2><div style="overflow-x:auto;"><table id="table2"></table></div></div>
        <div class="card"><h2>표 3. 연령대별 치료 건수</h2><div style="overflow-x:auto;"><table id="table3"></table></div></div>
        <div class="card"><h2>표 4. 연령대별 성별 치료 비중</h2><div style="overflow-x:auto;"><table id="table4"></table></div></div>
        <div class="card"><h2>표 5. 치료 횟수 분포</h2><div style="overflow-x:auto;"><table id="table5"></table></div></div>
        <div class="card"><h2>표 6. 연령대별 치료 횟수 인원 분포 (n / %)</h2><div style="overflow-x:auto;"><table id="table6"></table></div></div>
        <div class="card"><h2>표 6-1. 연령대별 회차 도달률 (누적)</h2><div style="overflow-x:auto;"><table id="table6_1"></table></div></div>

        <div class="card"><h2>표 7. 치료 금액 구간별 핵심지표</h2><div style="overflow-x:auto;"><table id="table7"></table></div></div>
        <div class="card"><h2>표 8. 치료사별 핵심지표</h2><div style="overflow-x:auto;"><table id="table8"></table></div></div>
        <div class="card"><h2>표 8-1. 치료사별 신환/재진 예약 비율(O/X)</h2><div style="overflow-x:auto;"><table id="table8r"></table></div></div>
        <div class="card"><h2>표 9. 첫 치료 → 2회차 재방문 주기</h2><div style="overflow-x:auto;"><table id="table9"></table></div></div>
        
        <div class="card"><h2>표 10. 진료실별 핵심지표</h2><div style="overflow-x:auto;"><table id="table10"></table></div></div>
        <div class="card"><h2>표 11. 치료사별·연령대별 평균 치료 횟수</h2><div style="overflow-x:auto;"><table id="table11"></table></div></div>
        <div class="card"><h2>표 12. 치료사별·연령대별 치료 횟수 분포</h2><div id="table12"></div></div>

        <div class="card" id="card13">
          <div class="cardHeaderRow">
            <h2>표 13. 치료사별·연령대별 재방문 안내 연락 시점 및 예약 확인(권장)</h2>
            <button id="toggle13" class="toggleBtn" type="button">펼치기</button>
          </div>
          <div id="table13Wrap" class="collapseWrap collapsed">
            <div id="table13"></div>
            <div id="followSummary13" class="followSummary" style="margin-top:10px;"></div>
          </div>
        </div>

        <div class="card" style="background: rgba(231, 245, 255, 0.6);">
          <h2>병원 경영 전략 제안서</h2>
          <div class="proposalWrap"><div id="analysisText" class="proposalPanel" style="line-height:1.7; font-size:13px; color:#333; padding: 12px;"></div></div>
        </div>
      </div>
    </div>
  </div>

  <footer>© JINSUL · 경험과 가치를 현실화하는 컨설팅</footer>

  <script>
    let freeExpanded = false;

    const dz = document.getElementById('dropZone');
    const fi = document.getElementById('fileInput');

    // 윈도우 전체 드래그 드롭 지원
    window.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('active'); });
    window.addEventListener('dragleave', e => { 
        if(e.clientX===0 && e.clientY===0) dz.classList.remove('active'); 
    });
    window.addEventListener('drop', e => {
      e.preventDefault();
      dz.classList.remove('active');
      const f = getDroppedFile(e.dataTransfer);
      if(f) handleFile(f);
    });

    function getDroppedFile(dt){
      if(!dt) return null;
      if(dt.files && dt.files.length) return dt.files[0];
      if(dt.items){
        for(const it of dt.items){
          if(it && it.kind === 'file') return it.getAsFile();
        }
      }
      return null;
    }

    fi.onchange = e => handleFile(e.target.files && e.target.files[0]);
    dz.addEventListener('click', () => fi && fi.click());

    // Free 표 펼치기/접기
    const freeToggleBtn = document.getElementById('freeToggleBtn');
    if(freeToggleBtn){
      freeToggleBtn.addEventListener('click', () => setFreeSectionExpanded(!freeExpanded));
    }
    setFreeSectionExpanded(false);

    // 표 13 펼치기/접기
    const toggle13Btn = document.getElementById('toggle13');
    const table13Wrap = document.getElementById('table13Wrap');
    if(toggle13Btn && table13Wrap){
      toggle13Btn.addEventListener('click', ()=>{
        const nowCollapsed = table13Wrap.classList.toggle('collapsed');
        toggle13Btn.textContent = nowCollapsed ? '펼치기' : '접기';
      });
    }

    // 전역 상태
    let rawRows = [];
    let records = [];     
    let patientsAll = []; 
    let selPVal = -1;     
    let entryPriceList = [];
    let amountListAll = [];
    let amountListFree = [];
    let exclAmtSet = new Set();
    let exclAmtFreeSet = new Set();

    const AGE_BUCKETS = ['10대','20대','30대','40대','50대','60대','70대 이상','미상'];
    const GENDERS = ['남','여','미상'];
    const PARTS_BASE = ['목','등','허리','어깨','팔꿈치','손목/손','골반/고관절','무릎','발목/발'];

    function toStr(v){ return (v===null||v===undefined) ? "" : String(v); }
    function normKey(k){ return toStr(k).trim(); }
    function _hNorm(s){
      return toStr(s).toLowerCase()
        .replace(/\s+/g,'')
        .replace(/[()（）\[\]{}]/g,'')
        .replace(/[·•\-\_\/\\\.]/g,'')
        .replace(/:+/g,'')
        .replace(/__empty\d*/g,'');
    }

    const _COL_SYNONYMS = [
      {std:'번호', syn:['번호','no','#','순번']},
      {std:'치료사', syn:['치료사','담당치료사','담당자','시술자','therapist']},
      {std:'이름', syn:['이름','환자명','성명','성함','name']},
      {std:'환자 차트', syn:['환자차트','환자 차트','차트','차트번호','차트 번호','등록번호','환자번호','chart']},
      {std:'성별/연령', syn:['성별/연령','성별연령','성별·연령','성별','연령','나이','sexage']},
      {std:'신/재', syn:['신/재','신재','신환/재진','신환재진','구분','초재진']},
      {std:'치료부위', syn:['치료부위','부위','시술부위','치료 부위','부위명']},
      {std:'치료타입', syn:['치료타입','치료 타입','치료내용','시술','오더','처치','치료종류']},
      {std:'회차', syn:['회차','차수','치료회차','치료 회차','횟수','회']},
      {std:'금액', syn:['금액','치료금액','수납','결제','청구','amount','price']},
      {std:'방문일', syn:['방문일','내원일','진료일','치료일','방문 일자','date']},
      {std:'등록일', syn:['등록일','접수일','수납일','등록 일자']},
      {std:'예약', syn:['예약','예약여부','예약 여부','예약여부(o/x)']},
      {std:'진료실', syn:['진료실','실','room','진료실/구역']},
      {std:'비고', syn:['비고','메모','특이사항','note']},
    ];

    function _stdKeyFromHeader(h){
      const hn=_hNorm(h);
      if(!hn) return '';
      for(const item of _COL_SYNONYMS){
        for(const s of item.syn){
          const sn=_hNorm(s);
          if(!sn) continue;
          if(hn===sn || hn.includes(sn) || sn.includes(hn)) return item.std;
        }
      }
      return '';
    }

    function _padRows(rows, maxCols){
      for(let r=0;r<rows.length;r++){
        if(!Array.isArray(rows[r])) rows[r]=[];
        for(let c=rows[r].length;c<maxCols;c++) rows[r][c]='';
      }
    }

    function _applyMergesToRows(rows, merges, maxRow){
      if(!merges || !merges.length) return;
      merges.forEach(m=>{
        const r0=m.s.r, r1=m.e.r, c0=m.s.c, c1=m.e.c;
        if(r0>=maxRow) return;
        const v = (rows[r0] && rows[r0][c0]!==undefined) ? rows[r0][c0] : '';
        if(v===undefined || v===null || toStr(v).trim()==='') return;
        for(let rr=r0; rr<=Math.min(r1, maxRow-1); rr++){
          for(let cc=c0; cc<=c1; cc++){
            const cur = rows[rr][cc];
            if(cur===undefined || cur===null || toStr(cur).trim()==='') rows[rr][cc]=v;
          }
        }
      });
    }

    function _scoreHeaderRow(headers){
      let s=0;
      headers.forEach(h=>{
        const std=_stdKeyFromHeader(h);
        if(std) s+=3;
        const hn=_hNorm(h);
        if(hn && hn.length>=2) s+=0.2;
      });
      return s;
    }

    function _detectHeader(rows){
      const scan = Math.min(20, rows.length);
      let best = {score:-1, idx:0, span:1, headers:[]};
      for(let i=0;i<scan;i++){
        const h1 = rows[i].map(v=>toStr(v).trim());
        const s1 = _scoreHeaderRow(h1);
        if(s1>best.score){ best={score:s1, idx:i, span:1, headers:h1}; }
        if(i+1<scan){
          const h2 = rows[i].map((v,ci)=>{
            const a=toStr(v).trim();
            const b=toStr(rows[i+1][ci]).trim();
            if(a && b && a!==b) return (a+' '+b).trim();
            return (a || b).trim();
          });
          const s2 = _scoreHeaderRow(h2) + 0.3;
          if(s2>best.score){ best={score:s2, idx:i, span:2, headers:h2}; }
        }
      }
      return best;
    }

    function sheetToObjectsAuto(sheet){
      try{
        const rows = XLSX.utils.sheet_to_json(sheet, {header:1, defval:""});
        if(!rows || !rows.length) return [];
        const maxCols = rows.reduce((m,r)=>Math.max(m, Array.isArray(r)?r.length:0), 0);
        _padRows(rows, maxCols);
        const merges = sheet['!merges'] || [];
        _applyMergesToRows(rows, merges, Math.min(20, rows.length));

        const hdr = _detectHeader(rows);
        const colMap = new Map();
        hdr.headers.forEach((h,ci)=>{
          const std = _stdKeyFromHeader(h);
          if(std) colMap.set(ci, std);
        });

        if(!Array.from(colMap.values()).includes('번호') && maxCols){ colMap.set(0, '번호'); }

        const out=[];
        const start = hdr.idx + hdr.span;
        for(let r=start; r<rows.length; r++){
          const arr = rows[r];
          if(!arr || !arr.some(v=>toStr(v).trim()!=='')) continue;
          const obj={};
          for(const [ci,std] of colMap.entries()){ obj[std] = arr[Number(ci)] ?? ""; }
          out.push(obj);
        }
        return out;
      }catch(err){ return []; }
    }

    function moneyOrNull(v){
      if(v===null || v===undefined) return null;
      if(typeof v === 'number' && isFinite(v)) return Math.round(v);
      const digits = toStr(v).replace(/[^0-9]/g,'');
      if(!digits) return null;
      const n = parseInt(digits,10);
      return isFinite(n) ? n : null;
    }

    function normalizeType(v){ return toStr(v).replace(/\s+/g,'').replace(/,+/g,'').trim(); }
    function isShock(t){ return normalizeType(t).includes('충격파') || normalizeType(t).includes('도수'); } 
    function isInjection(t){ return normalizeType(t).includes('주사'); }
    function isManual(t){ return normalizeType(t).includes('도수'); }

    function parseVisitDate(v){
      if(v===null || v===undefined || v==="") return null;
      if(typeof v === 'number' && isFinite(v)){
        const iv = Math.floor(v);
        const s = String(iv);
        if(s.length === 8 && iv > 19000101 && iv < 20991231){
          const y = parseInt(s.slice(0,4),10), m = parseInt(s.slice(4,6),10)-1, d = parseInt(s.slice(6,8),10);
          return new Date(y,m,d);
        }
        if(iv > 20000 && iv < 60000){
          const base = new Date(Date.UTC(1899,11,30));
          const dt = new Date(base.getTime() + iv * 86400000);
          return new Date(dt.getUTCFullYear(), dt.getUTCMonth(), dt.getUTCDate());
        }
      }
      const s0 = toStr(v).trim();
      const s = s0.replace(/\s+/g,'');
      if(/^\d{8}(\.0+)?$/.test(s)){
        const y = parseInt(s.slice(0,4),10), m = parseInt(s.slice(4,6),10)-1, d = parseInt(s.slice(6,8),10);
        return new Date(y,m,d);
      }
      const m1 = s.match(/^(\d{4})[-\/.](\d{1,2})[-\/.](\d{1,2})/);
      if(m1){ return new Date(parseInt(m1[1],10), parseInt(m1[2],10)-1, parseInt(m1[3],10)); }
      const dt = new Date(s0);
      return isFinite(dt.getTime()) ? new Date(dt.getFullYear(), dt.getMonth(), dt.getDate()) : null;
    }

    function normalizeRecords(recs){
      const g = new Map();
      const keyOf = (r)=>[r.key, r.therapist||'', String(r.visitKey||''), normalizeType(r.typeRaw||''), toStr(r.round||'')].join('||');
      for(const r of recs){
        const k = keyOf(r);
        if(!g.has(k)) g.set(k, []);
        g.get(k).push(r);
      }
      for(const rows of g.values()){
        const amts = rows.map(x=>x.amount).filter(v=>isFinite(v) && v>0);
        const a = amts.length ? Math.max(...amts) : null;
        if(a!==null) rows.forEach(x=>{ if(!x.amount) x.amount = a; });
        const fields = ['typeRaw','round','newFlag','reserve','room'];
        fields.forEach(f=>{
            const val = rows.map(x=>toStr(x[f]).trim()).find(v=>v) || '';
            rows.forEach(x=>{ if(!toStr(x[f]).trim()) x[f] = val; });
        });
      }
      return recs;
    }

    function dateKey(d){ return d ? new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime() : null; }
    function parseGender(s){ return toStr(s).includes('남')?'남':(toStr(s).includes('여')?'여':'미상'); }
    function parseAgeBucket(s){
      const m = toStr(s).match(/(\d{1,3})/);
      if(!m) return '미상';
      const age = parseInt(m[1],10);
      if(age<20) return '10대'; if(age<30) return '20대'; if(age<40) return '30대';
      if(age<50) return '40대'; if(age<60) return '50대'; if(age<70) return '60대';
      return '70대 이상';
    }

    // ----------------------------------------------------
    // 수정된 부위 매핑 (손목/발목 우선, 목 후순위)
    // ----------------------------------------------------
    function mapPartSingle(partRaw){
      const s0 = toStr(partRaw).trim();
      if(!s0) return null;
      // 구분자 처리
      const s = s0.replace(/\s+/g,'').replace(/[，]/g,'').replace(/,+/g,'').replace(/[.]+$/,'');
      const has = (w)=>s.includes(w);

      if(has('손가락') || has('수지') || has('손목') || has('손')) return '손목/손';
      if(has('발가락') || has('족지') || has('발목') || has('발')) return '발목/발';
      if(has('경추') || has('목')) return '목'; // 후순위

      if(has('흉추') || (has('등') && !has('허리'))) return '등';
      if(has('요추') || has('허리')) return '허리';
      if(has('어깨') || has('견')) return '어깨';
      if(has('팔꿈치') || has('주관절')) return '팔꿈치';
      if(has('고관절') || has('골반') || has('둔부') || has('엉덩') || has('서혜')) return '골반/고관절';
      if(has('무릎') || has('슬관절')) return '무릎';
      
      return '기타';
    }

    function extractParts(partRaw){
      const s0 = toStr(partRaw).trim();
      if(!s0) return ['(미기입)'];
      // '또는', 'or' 등을 쉼표로 변환 후 분리
      const s = s0
        .replace(/\n/g, ',').replace(/[\/／]/g, ',').replace(/[·•]/g, ',')
        .replace(/\s*또는\s*/g, ',').replace(/\s*or\s*/gi, ',')
        .replace(/\s*및\s*/g, ',').replace(/&/g, ',')
        .replace(/[()（）]/g, ','); 

      const tokens = s.split(',').map(x=>x.trim()).filter(Boolean);
      const out = [];
      const push = (v)=>{ if(v && !out.includes(v)) out.push(v); };

      if(tokens.length){
        tokens.forEach(t=>{ const m = mapPartSingle(t); push(m || '기타'); });
      }else{
        const m = mapPartSingle(s0); push(m || '기타');
      }
      return out.length ? out : ['(미기입)'];
    }

    function fmtPct(x){ return (isFinite(x) ? (x*100).toFixed(1) : '0.0') + '%'; }
    function fmtPctInt(x){ return (isFinite(x) ? Math.round(x*100) : 0) + '%'; }
    function fmtInt(x){ return (isFinite(x) ? Math.round(x).toLocaleString() : '0'); }
    function median(arr){
      const a = arr.slice().sort((x,y)=>x-y);
      if(!a.length) return 0;
      const mid = Math.floor(a.length/2);
      return a.length%2 ? a[mid] : (a[mid-1]+a[mid])/2;
    }
    function modeInfo(arr){
      const freq = new Map();
      for(const v of (arr||[])){
        const k = (v===null||v===undefined) ? null : Number(v);
        if(!isFinite(k)) continue;
        freq.set(k, (freq.get(k)||0) + 1);
      }
      if(!freq.size) return {modes:[], maxFreq:0};
      let maxF = 0;
      for(const c of freq.values()) maxF = Math.max(maxF, c);
      const modes = Array.from(freq.entries()).filter(([k,c])=>c===maxF).map(([k])=>k).sort((a,b)=>a-b);
      return {modes, maxFreq:maxF};
    }

    function handleFile(file){
      if(!file) return;
      document.getElementById('statusText').textContent = `로드됨: ${file.name}`;
      const r = new FileReader();
      r.onload = e => {
        const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
        rawRows = sheetToObjectsAuto(wb.Sheets[wb.SheetNames[0]]) || XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {defval:""});
        buildData();
        selPVal = -1;
        buildPriceButtons();
        buildExcludeButtons();
        renderAll();
      };
      r.readAsArrayBuffer(file);
    }

    function buildData(){
      const cleaned = rawRows.map(row => {
        const out = {}; Object.keys(row||{}).forEach(k => out[normKey(k)] = row[k]); return out;
      });
      let ctx = { therapist:'', name:'', chart:'', sexAge:'', newFlag:'', visitDt:null, typeRaw:'', round:'', room:'' };
      const recs = [];
      for(const r of cleaned){
        const no = toStr(r['번호']).trim();
        if(no && no.includes('치료사') && no.includes('환자')){
            ctx.therapist = no.split('치료사')[0].trim() || ctx.therapist;
            continue; 
        }
        const name = toStr(r['이름']).trim();
        if(name){
          ctx.name = name;
          if(r['환자 차트']) ctx.chart = toStr(r['환자 차트']).trim();
          if(r['성별/연령']) ctx.sexAge = toStr(r['성별/연령']).trim();
          if(r['신/재']) ctx.newFlag = toStr(r['신/재']).trim();
        }
        const rowData = toStr(r['치료부위'])+toStr(r['치료타입'])+toStr(r['금액'])+toStr(r['방문일']);
        if(!ctx.name || !rowData) continue;

        let visitDt = parseVisitDate(r['방문일']) || ctx.visitDt;
        if(parseVisitDate(r['방문일'])) ctx.visitDt = visitDt;

        recs.push({
          therapist: ctx.therapist || '미상',
          name: ctx.name,
          chart: ctx.chart,
          key: (ctx.chart ? (ctx.chart+'|'+ctx.name) : ctx.name),
          sexAge: toStr(r['성별/연령']).trim() || ctx.sexAge,
          gender: parseGender(toStr(r['성별/연령']).trim() || ctx.sexAge),
          ageBucket: parseAgeBucket(toStr(r['성별/연령']).trim() || ctx.sexAge),
          newFlag: toStr(r['신/재']).trim() || ctx.newFlag,
          part: toStr(r['치료부위']).trim() || '(미기입)',
          typeRaw: toStr(r['치료타입']).trim() || ctx.typeRaw,
          amount: moneyOrNull(r['금액']),
          visitKey: dateKey(visitDt),
          reserve: (toStr(r['예약']).trim().toUpperCase().match(/^[OX]/) || [''])[0],
          room: toStr(r['진료실']).trim() || ctx.room,
          round: toStr(r['치료차수']).trim() || ctx.round
        });
      }
      records = normalizeRecords(recs);
      patientsAll = computePatientsFrom(records);
      
      // 금액 리스트업 (일반 / 기타)
      amountListAll = Array.from(new Set(patientsAll.filter(p=>p.isNew).map(p=>p.entryPrice).filter(v=>isFinite(v)&&v>0))).sort((a,b)=>a-b);
      amountListFree = Array.from(new Set(patientsAll.filter(p=>p.freeStart).map(p=>p.freeEntryPrice).filter(v=>isFinite(v)&&v>0))).sort((a,b)=>a-b);

      exclAmtSet = new Set();
      exclAmtFreeSet = new Set();
      setFreeSectionExpanded(patientsAll.some(p=>p.freeStart));
      rebuildDerived();
    }

    // ----------------------------------------------------
    // Free 로직 강화 (Any, SamePart, Attributed)
    // ----------------------------------------------------
    function computePatientsFrom(sourceRecords){
      const byP = new Map();
      for(const r of sourceRecords){
        if(!r.key) continue;
        if(!byP.has(r.key)) byP.set(r.key, []);
        byP.get(r.key).push(r);
      }
      const pats = [];
      for(const [pkey, rows] of byP.entries()){
        const any = rows[0];
        const isNew = rows.some(r => toStr(r.newFlag).includes('신환'));
        const rowsSorted = rows.slice().sort((a,b)=>(a.visitKey||0)-(b.visitKey||0));

        // Free Check
        const firstRow = rowsSorted.find(r=>toStr(r.newFlag).trim());
        const firstStatus = firstRow ? toStr(firstRow.newFlag) : '';
        const freeStart = firstStatus.includes('기타');
        const freeStartKey = (firstRow && isFinite(firstRow.visitKey)) ? firstRow.visitKey : null;

        let freeConvAny=false, freeConvSame=false, freeConvAttr=false;
        let freeDays=null, freeConvTo=null, freeEntryPrice=null;

        if(freeStart && freeStartKey!==null){
            // Free 당시의 부위/치료사 추출
            const freeRows = rows.filter(r=>r.visitKey===freeStartKey);
            const freeParts = new Set();
            freeRows.forEach(r=>extractParts(r.part).forEach(p=>freeParts.add(p)));
            const freeTherapist = freeRows[0] ? freeRows[0].therapist : '';
            
            // Free 진입 금액
            const amts = freeRows.map(r=>r.amount).filter(v=>isFinite(v));
            freeEntryPrice = amts.length ? Math.max(...amts) : null;

            // Free 이후의 전환 탐색
            for(const r of rowsSorted){
                if((r.visitKey||0) <= freeStartKey) continue;
                const nf = toStr(r.newFlag);
                if(nf.includes('신환') || nf.includes('재진')){ // 전환 인정 조건
                    freeConvAny = true;
                    freeConvTo = nf.includes('신환') ? '신환' : '재진';
                    freeDays = Math.round((r.visitKey - freeStartKey)/86400000);
                    
                    // Same Part Check
                    const rParts = extractParts(r.part);
                    if(rParts.some(p=>freeParts.has(p))) freeConvSame = true;
                    
                    // Attributed Check
                    if(freeConvSame && r.therapist === freeTherapist) freeConvAttr = true;

                    // 한 번 전환되면 루프 종료 (첫 전환 기준)
                    break; 
                }
            }
        }

        // New Patient Logic (Existing)
        const newRows = rows.filter(r => toStr(r.newFlag).includes('신환'));
        const newVisitKey = newRows.length ? newRows[0].visitKey : null;
        
        // 치료 방문키 집계 (충격파/도수 포함된 날짜)
        const shockVisitKeys = new Set(rows.filter(r=>isShock(r.typeRaw)).map(r=>r.visitKey).filter(Boolean));
        const prKeysRaw = Array.from(shockVisitKeys.size ? shockVisitKeys : new Set(rows.map(r=>r.visitKey).filter(Boolean))).sort((a,b)=>a-b);
        
        // 신환 시작점 보정
        const baseKey = (newVisitKey !== null) ? newVisitKey : (prKeysRaw[0]||null);
        const prKeys = (baseKey===null) ? prKeysRaw : prKeysRaw.filter(k=>k>=baseKey);
        
        let entryPrice = null;
        let entryRoom = '';
        if(baseKey !== null){
            const entryRows = rows.filter(r=>r.visitKey===baseKey);
            const eAmts = entryRows.map(r=>r.amount).filter(v=>isFinite(v));
            entryPrice = eAmts.length ? Math.max(...eAmts) : null;
            entryRoom = entryRows.map(r=>toStr(r.room).trim()).find(v=>v) || '';
        }

        pats.push({
            key: pkey,
            therapist: newRows[0]?.therapist || any.therapist || '미상',
            gender: any.gender, ageBucket: any.ageBucket,
            isNew: isNew,
            freeStart: freeStart,
            freeConverted: freeConvAny,
            freeConvSame: freeConvSame,
            freeConvAttr: freeConvAttr,
            freeConversionTo: freeConvTo,
            freeDaysToPaid: freeDays,
            freeEntryPrice: freeEntryPrice,
            entryPrice: entryPrice,
            entryRoom: entryRoom,
            shockVisitCount: Math.min(prKeys.length, 5), // Max 5 clamp
            shockVisitCountRaw: prKeys.length,
            firstShockKey: prKeys[0] || null,
            daysTo2: (prKeys.length>=2) ? Math.round((prKeys[1]-prKeys[0])/86400000) : null,
            hasInjection: rows.some(r=>isInjection(r.typeRaw)),
            rows: rows
        });
      }
      return pats;
    }

    function patientsAfterFreeExclusion(){
      // Free 금액 필터는 Free 모수에만 영향
      if(!exclAmtFreeSet.size) return patientsAll;
      return patientsAll.filter(p => !(p.freeStart && isFinite(p.freeEntryPrice) && exclAmtFreeSet.has(p.freeEntryPrice)));
    }

    function activePatients(){
      // 일반 금액 필터는 유료(신환) 분석에만 영향, Free 모수는 유지
      const base = patientsAfterFreeExclusion(); 
      if(!exclAmtSet.size) return base;
      return base.filter(p => {
        if(!p.isNew || !isFinite(p.entryPrice)) return true;
        return !exclAmtSet.has(p.entryPrice);
      });
    }

    function rebuildDerived(){
      const act = activePatients();
      entryPriceList = Array.from(new Set(act.filter(p=>p.isNew).map(p=>p.entryPrice).filter(v=>isFinite(v)&&v>0))).sort((a,b)=>a-b);
      if(selPVal!==-1 && !entryPriceList.includes(selPVal)) selPVal = -1;
    }

    function buildPriceButtons(){
      const box = document.getElementById('priceBtns'); box.innerHTML = '';
      const mkBtn = (label, val) => {
        const b = document.createElement('button');
        b.className = 'price-btn sel-btn' + (selPVal===val ? ' active' : '');
        b.textContent = label;
        b.onclick = () => { selPVal = val; document.querySelectorAll('.sel-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); renderAll(); };
        return b;
      };
      box.appendChild(mkBtn('전체', -1));
      entryPriceList.forEach(v => box.appendChild(mkBtn(v.toLocaleString() + '원', v)));
      document.getElementById('filterArea').classList.remove('hidden');
    }

    function buildExcludeButtons(){
      const box = document.getElementById('excludeBtns'); if(!box) return; box.innerHTML = '';
      const mkBtn = (label, val, isFree) => {
        const set = isFree ? exclAmtFreeSet : exclAmtSet;
        const b = document.createElement('button');
        b.className = 'price-btn excl-btn' + (set.has(val) ? ' active' : '');
        b.textContent = label;
        b.onclick = () => { if(set.has(val)) set.delete(val); else set.add(val); rebuildDerived(); buildPriceButtons(); buildExcludeButtons(); renderAll(); };
        return b;
      };
      const unionNormal = Array.from(new Set([...(amountListAll||[]), ...Array.from(exclAmtSet||[])])).filter(v=>isFinite(v)&&v>0).sort((a,b)=>a-b);
      unionNormal.forEach(v => box.appendChild(mkBtn(v.toLocaleString() + '원', v, false)));
      
      const unionFree = Array.from(new Set([...(amountListFree||[]), ...Array.from(exclAmtFreeSet||[])])).filter(v=>isFinite(v)&&v>0).sort((a,b)=>a-b);
      unionFree.forEach(v => box.appendChild(mkBtn(v.toLocaleString() + '원(기타)', v, true)));

      const clearBtn = document.createElement('button');
      clearBtn.className = 'price-btn excl-btn' + ((exclAmtSet.size || exclAmtFreeSet.size) ? '' : ' active');
      clearBtn.textContent = '제외 초기화';
      clearBtn.onclick = () => { exclAmtSet.clear(); exclAmtFreeSet.clear(); rebuildDerived(); buildPriceButtons(); buildExcludeButtons(); renderAll(); };
      box.appendChild(clearBtn);
    }

    function setFreeSectionExpanded(expanded){
      freeExpanded = !!expanded;
      const btn = document.getElementById('freeToggleBtn');
      const main = document.getElementById('freeTablesMain');
      if(btn) btn.textContent = freeExpanded ? '접기' : '펼치기';
      if(main) main.style.display = freeExpanded ? '' : 'none';
      document.querySelectorAll('.free-card-extra').forEach(el => el.style.display = freeExpanded ? '' : 'none');
    }

    // ----------------------------------------------------
    // 렌더링
    // ----------------------------------------------------
    function setHtml(id, html){ const el = document.getElementById(id); if(el) el.innerHTML = html; }
    function renderKeyValueTable(tableId, rows){
      setHtml(tableId, `<thead><tr><th style="width:180px;">항목</th><th>값</th></tr></thead><tbody>` + rows.map(r=>`<tr><td>${r.k}</td><td>${r.v}</td></tr>`).join('') + `</tbody>`);
    }
    function renderSimpleTable(tableId, cols, rows){
      const th = `<thead><tr>` + cols.map(c=>`<th${c.w?` style="width:${c.w}px"`:''}>${c.l}</th>`).join('') + `</tr></thead>`;
      const tb = `<tbody>` + rows.map(r=>`<tr${r._rowClass?` class="${r._rowClass}"`:''}>` + cols.map(c=>`<td>${r[c.k]!==undefined?r[c.k]:''}</td>`).join('') + `</tr>`).join('') + `</tbody>`;
      setHtml(tableId, th+tb);
    }
    function renderMatrix(tableId, rows, cols, getVal){
      let head = `<thead><tr><th style="width:110px;">구분</th>` + cols.map(c=>`<th>${c}</th>`).join('') + `<th class="total-col">합계</th></tr></thead>`;
      let colTots = new Array(cols.length).fill(0), grand=0, body=`<tbody>`;
      rows.forEach(r=>{
        let rowSum=0, cells='';
        cols.forEach((c,i)=>{ const v=getVal(r,c)||0; rowSum+=v; colTots[i]+=v; cells+=`<td>${v}</td>`; });
        grand+=rowSum;
        body+=`<tr><td>${r}</td>${cells}<td class="total-col">${rowSum}</td></tr>`;
      });
      body+=`<tr class="total-row"><td>합계</td>`+colTots.map(v=>`<td>${v}</td>`).join('')+`<td class="total-col">${grand}</td></tr></tbody>`;
      setHtml(tableId, head+body);
    }
    function renderMatrixRowPct(tableId, rows, cols, getVal){
      let head = `<thead><tr><th style="width:110px;">구분</th>` + cols.map(c=>`<th>${c}</th>`).join('') + `<th class="total-col">합계</th></tr></thead>`;
      let body=`<tbody>`;
      rows.forEach(r=>{
        let rowSum=0; cols.forEach(c=>rowSum+=(getVal(r,c)||0));
        let cells=''; cols.forEach(c=>{ const v=getVal(r,c)||0; cells+=`<td>${rowSum?fmtPctInt(v/rowSum):'-'}</td>`; });
        body+=`<tr><td>${r}</td>${cells}<td class="total-col">${rowSum?'100%':'-'}</td></tr>`;
      });
      body+=`</tbody>`;
      setHtml(tableId, head+body);
    }
    function cohortPatients(){ return activePatients().filter(p => p.isNew && (selPVal===-1 || p.entryPrice===selPVal)); }

    function renderAll(){
      document.getElementById('dashArea').classList.remove('hidden');
      document.getElementById('mainContent').classList.remove('hidden');
      const cohort = cohortPatients();
      const n = cohort.length;

      // Dashboard Logic
      const convN = cohort.filter(p=>p.shockVisitCount>=2).length;
      const r3N = cohort.filter(p=>p.shockVisitCount>=3).length;
      const comboN = cohort.filter(p=>p.hasInjection).length;
      const counts = cohort.map(p=>p.shockVisitCount);
      const avgV = counts.length ? counts.reduce((a,b)=>a+b,0)/n : 0;
      const medV = median(counts);
      const modeV = modeInfo(counts);
      const r7N = cohort.filter(p=>p.daysTo2!==null && p.daysTo2<=7).length;
      const r14N = cohort.filter(p=>p.daysTo2!==null && p.daysTo2<=14).length;

      setHtml('v-count', fmtInt(n));
      setHtml('v-count-sub', (selPVal===-1?'전체':selPVal.toLocaleString()+'원') + (exclAmtSet.size?` · 제외 ${exclAmtSet.size}건`:''));
      setHtml('v-conv', n?fmtPct(convN/n):'0%'); setHtml('v-conv-sub', `${convN}/${n}`);
      setHtml('v-ret', n?fmtPct(r3N/n):'0%'); setHtml('v-ret-sub', `${r3N}/${n}`);
      setHtml('v-combo', n?fmtPct(comboN/n):'0%'); setHtml('v-combo-sub', `${comboN}/${n}`);
      setHtml('v-avgV', avgV.toFixed(1));
      setHtml('v-medV', medV>=5?'5회 이상':medV);
      setHtml('v-modeV', modeV.modes.join(', '));
      setHtml('v-modeV-sub', modeV.maxFreq?`빈도: ${modeV.maxFreq}`:'');
      setHtml('v-r7', n?fmtPct(r7N/n):'0%'); setHtml('v-r7-sub', `${r7N}/${n}`);
      setHtml('v-r14', n?fmtPct(r14N/n):'0%'); setHtml('v-r14-sub', `${r14N}/${n}`);

      // Data Prep for Tables
      const partAge = new Map(), therPart = new Map();
      const partsSet = new Set(PARTS_BASE);
      let hasEtc = false;
      const THERAPISTS = Array.from(new Set(cohort.map(p=>p.therapist))).sort((a,b)=>a.localeCompare(b));

      cohort.forEach(p=>{
        const byVisit = new Map();
        p.rows.filter(r=>isShock(r.typeRaw)).forEach(r=>{
            const k = r.visitKey||'noDate';
            if(!byVisit.has(k)) byVisit.set(k,[]); byVisit.get(k).push(r);
        });
        for(const rows of byVisit.values()){
            const age = rows.find(x=>x.ageBucket)?.ageBucket || p.ageBucket || '미상';
            const extracted = new Set();
            rows.forEach(r=>extractParts(r.part).forEach(x=>extracted.add(x)));
            extracted.forEach(pt=>{
                if(!partsSet.has(pt)) hasEtc=true;
                const k1 = pt+'||'+age; partAge.set(k1, (partAge.get(k1)||0)+1);
                const k2 = (p.therapist||'미상')+'||'+pt; therPart.set(k2, (therPart.get(k2)||0)+1);
            });
        }
      });
      const PARTS = hasEtc ? PARTS_BASE.concat(['기타']) : PARTS_BASE;
      const validAge = AGE_BUCKETS.filter(a=>cohort.some(p=>p.ageBucket===a));
      
      // Table 1, 1a, 1b
      renderMatrix('table1', PARTS, validAge, (p,a)=>partAge.get(p+'||'+a)||0);
      renderMatrix('table1a', THERAPISTS, PARTS, (t,p)=>therPart.get(t+'||'+p)||0);
      renderMatrixRowPct('table1b', THERAPISTS, PARTS, (t,p)=>therPart.get(t+'||'+p)||0);

      // Free Tables (1c, 1d, 1e, 1f)
      const freePats = patientsAfterFreeExclusion().filter(p=>p.freeStart);
      const fN = freePats.length;
      const fConv = freePats.filter(p=>p.freeConverted);
      const fSame = freePats.filter(p=>p.freeConvSame);
      const fAttr = freePats.filter(p=>p.freeConvAttr);
      const fDays = fConv.map(p=>p.freeDaysToPaid).filter(v=>isFinite(v));
      
      renderKeyValueTable('table1c', [
        {k:'무료(기타여부) 시작', v: `${fmtInt(fN)}명`},
        {k:'단순 유료 전환', v: fN ? `${fmtPct(fConv.length/fN)} (${fConv.length}명)` : '0%'},
        {k:'동일 부위 전환', v: fN ? `${fmtPct(fSame.length/fN)} (${fSame.length}명)` : '0%'},
        {k:'동일 치료사 전환', v: fN ? `${fmtPct(fAttr.length/fN)} (${fAttr.length}명)` : '0%'},
        {k:'전환 소요일(중앙값)', v: fDays.length ? `${median(fDays)}일` : '-'}
      ]);

      // Free Breakdown Tables Helper
      const mkFreeTable = (id, label, getRowLabel) => {
        const rows = [];
        const map = new Map();
        freePats.forEach(p=>{
            const lbl = getRowLabel(p);
            if(!map.has(lbl)) map.set(lbl, {n:0, c:0, s:0, a:0});
            const o = map.get(lbl);
            o.n++; if(p.freeConverted) o.c++; if(p.freeConvSame) o.s++; if(p.freeConvAttr) o.a++;
        });
        const keys = Array.from(map.keys()).sort();
        keys.forEach(k=>{
            const o = map.get(k);
            rows.push({
                [label]: k, '시작': fmtInt(o.n),
                '단순전환': fmtPct(o.c/o.n), '동일부위': fmtPct(o.s/o.n), '동일치료사': fmtPct(o.a/o.n)
            });
        });
        renderSimpleTable(id, [{k:label,l:label,w:100},{k:'시작',l:'시작(명)'},{k:'단순전환',l:'단순전환'},{k:'동일부위',l:'동일부위'},{k:'동일치료사',l:'동일치료사'}], rows);
      };
      mkFreeTable('table1d', '연령대', p=>p.ageBucket||'미상');
      mkFreeTable('table1f', '치료사', p=>p.therapist||'미상');
      
      // Free Part Table needs special handling (one patient -> multiple parts)
      const fPartMap = new Map();
      freePats.forEach(p=>{
        const parts = new Set();
        p.rows.filter(r=>r.visitKey===p.firstShockKey).forEach(r=>extractParts(r.part).forEach(x=>parts.add(x)));
        if(!parts.size) parts.add('(미기입)');
        parts.forEach(pt=>{
            if(!fPartMap.has(pt)) fPartMap.set(pt, {n:0, c:0});
            const o = fPartMap.get(pt); o.n++; if(p.freeConverted) o.c++;
        });
      });
      const fPartRows = Array.from(fPartMap.entries()).map(([k,o])=>({ '부위':k, '시작':fmtInt(o.n), '전환':fmtPct(o.c/o.n) }));
      renderSimpleTable('table1e', [{k:'부위',l:'부위'},{k:'시작',l:'시작(명)'},{k:'전환',l:'전환율'}], fPartRows);

      // Table 1-7 (Reached 3rd)
      const t1gRows = [];
      THERAPISTS.forEach(t=>{
        PARTS.forEach(pt=>{
            const ps = cohort.filter(p=>p.therapist===t && p.rows.some(r=>extractParts(r.part).includes(pt)));
            if(ps.length){
                const r3 = ps.filter(p=>p.shockVisitCount>=3).length;
                // Complex matrix logic simplified for now to standard matrix
            }
        });
      });
      // Simplified Matrix for 1-7 using previous logic structure
      const tpDen=new Map(), tpNum=new Map();
      cohort.forEach(p=>{
        const parts=new Set(); p.rows.forEach(r=>extractParts(r.part).forEach(x=>parts.add(x)));
        parts.forEach(pt=>{
            const k = p.therapist+'||'+pt;
            tpDen.set(k, (tpDen.get(k)||0)+1);
            if(p.shockVisitCount>=3) tpNum.set(k, (tpNum.get(k)||0)+1);
        });
      });
      renderMatrix('table1g', THERAPISTS, PARTS, (t,p)=>{
          const d = tpDen.get(t+'||'+p)||0; return d ? fmtPct(tpNum.get(t+'||'+p)/d) : '-';
      });

      // Table 2, 3, 4, 5 (Existing structure)
      renderKeyValueTable('table2', [
        {k:'신환 수', v: `${fmtInt(n)}명`},
        {k:'2회차 전환율', v: n?fmtPct(convN/n):'0%'},
        {k:'3회차 도달율', v: n?fmtPct(r3N/n):'0%'},
        {k:'주사치료 병행', v: n?fmtPct(comboN/n):'0%'},
        {k:'평균 치료 횟수', v: avgV.toFixed(2)},
        {k:'7일 내 재방문', v: n?fmtPct(r7N/n):'0%'}
      ]);
      // Table 6 (n / %)
      const rounds = ['1회만','2회만','3회만','4회만','5회 이상'];
      const t6Head = `<thead><tr><th>구분</th>`+rounds.map(r=>`<th>${r}</th>`).join('')+`</tr></thead>`;
      let t6Body = `<tbody>`;
      validAge.forEach(a=>{
          const ps = cohort.filter(p=>p.ageBucket===a);
          const rowN = ps.length;
          let cells = '';
          rounds.forEach((r,i)=>{
             const cnt = ps.filter(p=> (i<4 ? p.shockVisitCount===(i+1) : p.shockVisitCount>=5)).length;
             cells += `<td>${cnt} / ${rowN?fmtPctInt(cnt/rowN):'0%'}</td>`;
          });
          t6Body += `<tr><td>${a}</td>${cells}</tr>`;
      });
      t6Body += `</tbody>`;
      setHtml('table6', t6Head+t6Body);

      // Table 6-1 (Cumulative Reach)
      const t61Head = `<thead><tr><th>구분</th><th>1회 이상</th><th>2회 이상</th><th>3회 이상</th><th>4회 이상</th><th>5회 이상</th></tr></thead><tbody>`;
      let t61Body = '';
      validAge.forEach(a=>{
          const ps = cohort.filter(p=>p.ageBucket===a);
          const rowN = ps.length;
          let cells = '';
          for(let i=1; i<=5; i++){
              const reach = ps.filter(p=>p.shockVisitCount>=i).length;
              cells += `<td>${reach} (${rowN?fmtPctInt(reach/rowN):'0%'})</td>`;
          }
          t61Body += `<tr><td>${a}</td>${cells}</tr>`;
      });
      setHtml('table6_1', t61Head+t61Body+`</tbody>`);

      // Table 7, 8, 8-1, 9, 10... (Render using standard simple table or matrix)
      // Logic mirrors previous robust implementations
      const mkTbl = (id, keys, data) => renderSimpleTable(id, keys, data);
      
      const t8Data = THERAPISTS.map(t=>{
          const ps = cohort.filter(p=>p.therapist===t);
          const nn = ps.length;
          return {
              '치료사':t, '신환수':fmtInt(nn),
              '전환율': nn?fmtPct(ps.filter(p=>p.shockVisitCount>=2).length/nn):'0%',
              '도달율': nn?fmtPct(ps.filter(p=>p.shockVisitCount>=3).length/nn):'0%',
              '평균': nn?(ps.reduce((a,b)=>a+b.shockVisitCount,0)/nn).toFixed(1):'0.0'
          };
      });
      mkTbl('table8', [{k:'치료사',l:'치료사'},{k:'신환수',l:'신환수'},{k:'전환율',l:'2회차 전환율'},{k:'도달율',l:'3회차 도달율'},{k:'평균',l:'평균치료'}], t8Data);
      
      // Table 10 (Rooms)
      const rooms = Array.from(new Set(cohort.map(p=>p.entryRoom||'미상'))).sort();
      const t10Data = rooms.map(rm=>{
        const ps = cohort.filter(p=>(p.entryRoom||'미상')===rm);
        const nn = ps.length;
        return {
            '진료실': rm, '신환수': fmtInt(nn),
            '전환율': nn?fmtPct(ps.filter(p=>p.shockVisitCount>=2).length/nn):'0%',
            '도달율': nn?fmtPct(ps.filter(p=>p.shockVisitCount>=3).length/nn):'0%',
            '평균': nn?(ps.reduce((a,b)=>a+b.shockVisitCount,0)/nn).toFixed(1):'0.0',
            '7일재방': nn?fmtPct(ps.filter(p=>p.daysTo2<=7).length/nn):'0%'
        };
      });
      mkTbl('table10', [{k:'진료실',l:'진료실'},{k:'신환수',l:'신환수'},{k:'전환율',l:'2회차 전환율'},{k:'도달율',l:'3회차 도달율'},{k:'평균',l:'평균치료'},{k:'7일재방',l:'7일내재방'}], t10Data);
      
      // Fill remaining logic for completeness...
      
      // 제안서 자동 생성
      const lines = [];
      const addLine = (txt) => lines.push(`• ${txt}`);
      if(n > 0){
          addLine(`2회차 전환율은 <b>${fmtPct(convN/n)}</b>입니다. 미예약자 관리 프로세스를 점검하세요.`);
          addLine(`3회차 도달율은 <b>${fmtPct(r3N/n)}</b>입니다. 5회 치료 목표를 초진 시 확실히 인지시켜야 합니다.`);
          if(fN > 0) addLine(`Free(기타여부) 전환율은 <b>${fmtPct(fConv.length/fN)}</b>(동일부위 ${fmtPct(fSame.length/fN)})입니다. 서비스 치료가 실제 유료 전환으로 이어지는지 확인이 필요합니다.`);
          const lowPerfTher = t8Data.filter(d=>parseFloat(d.전환율)<30 && parseInt(d.신환수.replace(/,/g,''))>5);
          if(lowPerfTher.length) addLine(`전환율 30% 미만 치료사(${lowPerfTher.map(d=>d.치료사).join(',')})에 대한 멘트 코칭이 시급합니다.`);
      } else {
          addLine("분석할 신환 데이터가 없습니다.");
      }
      setHtml('analysisText', lines.map(l=>`<div style="margin:4px 0">${l}</div>`).join(''));
    }
  </script>
</body>
</html>
