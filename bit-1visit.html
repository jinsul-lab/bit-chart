<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>비트 연령별 통계</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- SheetJS (CSV/XLSX/XLS 모두 처리) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg:#f6f6f7; --card:#ffffff; --text:#111827; --muted:#6b7280;
      --border:#e5e7eb; --thead:#f3f4f6; --hover:#f9fafb; --group:#cbd5e1;
      --primary:#0ea5e9;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,'Apple SD Gothic Neo','Noto Sans KR',Arial,sans-serif;
    }
    header{padding:24px 16px 0; text-align:center;}
    h1{margin:0 0 6px; font-size:24px; font-weight:800; color:#0f172a}
    p.sub{margin:0; color:var(--muted); font-size:12px}
    .wrap{padding:16px; max-width:1200px; margin:0 auto}
    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; box-shadow:0 2px 6px rgba(0,0,0,.05); margin-top:12px}
    .card-title{margin:0 0 8px; font-weight:700; color:#111827}
    .grid{display:grid; gap:10px; grid-template-columns:1fr 1fr auto}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input[type=file], input[type=text]{
      width:100%; padding:10px; border-radius:10px; border:1px dashed var(--border); background:#fff; color:var(--text);
    }
    button{
      height:38px; border-radius:10px; border:1px solid var(--border);
      background:radial-gradient(120% 120% at 0% 0%,rgba(34,211,238,.25),rgba(34,211,238,.1));
      color:#0f172a; font-weight:700; cursor:pointer; padding:0 12px;
    }
    button.ghost{background:#fff}
    button.primary{background:linear-gradient(135deg, rgba(14,165,233,.15), rgba(14,165,233,.05)); border-color:#bae6fd}
    button:disabled{opacity:.5; cursor:not-allowed}
    .warn{color:#b91c1c; font-weight:700; margin-top:10px}

    table{
      width:100%; border-collapse:collapse; table-layout:fixed;
      background:#fff; border:1px solid var(--border); border-radius:12px; overflow:hidden;
    }
    th, td{
      padding:10px 8px; text-align:center; word-break:keep-all; white-space:normal;
      border-bottom:1px solid var(--border); font-size:12px;
    }
    th{position:sticky; top:0; z-index:1; background:var(--thead); color:#0f172a}
    tbody tr:hover td{background:var(--hover)}

    tbody tr.whole, tbody tr.room1, tbody tr.room2, tbody tr.room3, tbody tr.room4, tbody tr.room5{ background:transparent !important; }
    tbody td[rowspan]{ border-top:3px solid var(--group) !important; }
    tbody tr:first-child td[rowspan]{ border-top:1px solid var(--border) !important; }
    @supports(selector(tbody tr:has(td[rowspan]))){
      tbody tr:has(td[rowspan]) td{ border-top:3px solid var(--group) !important; }
      tbody tr:first-child:has(td[rowspan]) td{ border-top:1px solid var(--border) !important; }
    }
    @media (max-width:899px){
      .grid{grid-template-columns:1fr}
      th,td{font-size:11px}
    }

    /* print: 업로드 UI 숨기기 */
    @media print{
      .no-print{display:none !important}
      body{background:#fff}
      header{padding:0 0 8px}
    }
  </style>
</head>
<body>
  <header>
    <h1>비트 연령별 통계 자동 계산기</h1>
    <p class="sub">진료실별 연령 통계 및 주사·내원 현황 자동 계산</p>
  </header>

  <div class="wrap">
    <!-- 입력 카드 -->
    <div class="card no-print">
      <div class="grid">
        <div>
          <label>접수메모에 적힌 키워드 특정 값을 원할 때 입력</label>
          <label>PT만, 충격파, 주사경과, 1진료실, 독감, 드레싱 등 특정 키워드</label>
          <input type="text" id="keywordInput" placeholder="예: PT만" />
        </div>
        <div>
          <label>외래진료실➡️외래환자➡️기간설정➡️검색➡️Excel내려받기</label>
          <label>※ CSV / XLSX / XLS 모두 지원 (CSV는 UTF-8·EUC-KR 자동 인식)</label>
          <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" />
        </div>
        <div style="display:flex;gap:8px;align-items:end;justify-content:flex-end;">
          <button id="runBtn" class="ghost" onclick="document.getElementById('fileInput').click()">파일 선택</button>
          <button id="oneBtn" class="primary" disabled>1회 주사자 보기</button>
          <button id="oneDlBtn" class="ghost" disabled>다운로드(xlsx)</button>
          <button onclick="window.print()" class="ghost">인쇄</button>
        </div>
      </div>
      <p style="color:var(--muted);font-size:12px;margin:8px 0 0">⚠️ 모든 데이터는 브라우저 내에서만 처리됩니다.</p>
    </div>

    <!-- 요약 통계 -->
    <div class="card table-card">
      <h3 class="card-title">요약 통계 (전체 / 각 진료실)</h3>
      <div id="summaryOutput"></div>
    </div>

    <!-- 연령대별 통계 -->
    <div class="card table-card">
      <h3 class="card-title">연령대별 통계 (진료실별)</h3>
      <div id="output"></div>
      <div id="warning" class="warn"></div>
    </div>

    <!-- 1회 주사자 -->
    <div class="card" id="oneShotCard" style="display:none;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
        <h3 class="card-title" style="margin:0">1회만 주사한 사람 리스트</h3>
        <div style="display:flex;gap:8px">
          <button id="oneTopDl" class="ghost">다운로드(xlsx)</button>
        </div>
      </div>
      <div id="oneShotTable" style="margin-top:8px"></div>
    </div>
  </div>

  <script>
    /* ================= 공통 유틸 ================= */
    const AGE_ORDER = ["0~10대", "20대", "30대", "40대", "50대", "60대", "70대이상", "전체"];

    // CSV 호환 헬퍼
    function stripBOM(s){ return s && s.charCodeAt(0) === 0xFEFF ? s.slice(1) : s; }
    function detectDelimiter(sampleText){
      const line = (sampleText.split(/\\r?\\n/).find(l => l.trim().length) || '');
      const cands = [',',';','\\t','|']; let best=',', max=-1;
      for(const c of cands){ const n=(line.match(new RegExp('\\\\'+c,'g'))||[]).length; if(n>max){max=n;best=c;} }
      return best;
    }
    function smartCSVtoRows(csvText){
      const txt = stripBOM(csvText); const FS = detectDelimiter(txt);
      const wb = XLSX.read(txt, { type:'string', FS }); const ws = wb.Sheets[wb.SheetNames[0]];
      return XLSX.utils.sheet_to_json(ws, { header:1, defval:'' });
    }

    function findHeaderIndex(rows){
      return rows.findIndex(row => {
        const cells = row.map(c => String(c||'').toLowerCase());
        const hasFirstRevisit = cells.some(c => /초\\s*\\/?\\s*재|신환|재진|90일초진/.test(c));
        const hasChart = cells.some(c => /차트|챠트|차트.?번호|환자.?번호|등록번호|id/.test(c));
        const hasDept = cells.some(c => /진료.?과|과목|외래.?진료.?실/.test(c));
        return hasFirstRevisit && (hasChart || hasDept);
      });
    }

    // 파일 로드
    document.getElementById('fileInput').addEventListener('change', function(e){
      const file = e.target.files[0];
      const keyword = document.getElementById('keywordInput').value.trim().toLowerCase();
      if(!file) return;
      const isCSV = /\\.csv$/i.test(file.name);
      const reader = new FileReader();
      reader.onload = function(evt){
        let rawData = [];
        if(isCSV){
          rawData = smartCSVtoRows(evt.target.result);
          parseData(rawData, keyword);
        }else{
          const data = new Uint8Array(evt.target.result);
          const workbook = XLSX.read(data, { type:'array' });
          workbook.SheetNames.forEach(sheet => {
            const rows = XLSX.utils.sheet_to_json(workbook.Sheets[sheet], { header:1, defval:'' });
            rawData = rawData.concat(rows);
          });
          parseData(rawData, keyword);
        }
      };
      if(isCSV) reader.readAsText(file); else reader.readAsArrayBuffer(file);
    });

    function getAgeGroup(raw){
      if(!raw || typeof raw !== 'string') return '전체';
      const match = raw.match(/(\\d{1,3})세/); const age = match ? parseInt(match[1]) : NaN;
      if(isNaN(age)) return '전체';
      if(age <= 19) return '0~10대';
      if(age <= 29) return '20대';
      if(age <= 39) return '30대';
      if(age <= 49) return '40대';
      if(age <= 59) return '50대';
      if(age <= 69) return '60대';
      return '70대이상';
    }
    function parseAge(val){
      if(val===null||val===undefined) return null;
      const s=String(val).trim(); const m=s.match(/(\\d{1,3})/);
      return m ? Math.min(150, parseInt(m[1],10)) : null;
    }
    function formatCell(v){
      if(v===null||v===undefined) return '-';
      const s=String(v).trim();
      if(s===''||s==='0'||s==='0.0'||s==='0%'||/^nan/i.test(s)||/^nan%$/i.test(s)) return '-';
      if(!isNaN(Number(s))&&Number(s)===0) return '-';
      return s;
    }

    /* ================= 표 렌더: 요약 ================= */
    function renderSummaryTable(allRows){
      const rows = allRows.filter(r => r['연령대']==='전체');
      if(!rows.length){ document.getElementById('summaryOutput').innerHTML=''; return; }
      const orderRooms = ['1진료실','2진료실','3진료실','4진료실','5진료실','6진료실','7진료실','8진료실','9진료실','10진료실','전체'];
      rows.sort((a,b)=>{
        const ai=orderRooms.indexOf(a['구분']); const bi=orderRooms.indexOf(b['구분']);
        return (ai===-1)-(bi===-1) || ai-bi || a['구분'].localeCompare(b['구분']);
      });
      const cols = [
        '구분','초진','초진주사','초진 주사처방률',
        '초진 주사 평균 횟수','초진 주사 평균 내원 횟수',
        '초진 주사 재진율',
        '(18세▲)초진','(18세▲)초진주사','(18세▲)초진주사처방률',
        '초진 평균 내원횟수','초진 재내원율',
        '1회 내원 비율','2회 내원 비율','3회 내원 비율','4회 내원 비율',
        '5회 내원 비율','6회 내원 비율','7회 내원 비율','8회 이상 내원 비율',
        '특정 키워드 포함 메모 수'
      ].filter(c => c in rows[0]);
      let thead = '<tr>'+cols.map(h=>`<th>${h}</th>`).join('')+'</tr>';
      let tbody = rows.map(r=>('<tr>'+cols.map(c=>`<td>${formatCell(r[c])}</td>`).join('')+'</tr>')).join('');
      document.getElementById('summaryOutput').innerHTML = `<table><thead>${thead}</thead><tbody>${tbody}</tbody></table>`;
    }

    /* ================= 표 렌더: 연령대 ================= */
    function renderAgeTable(result){
      result.sort((a,b)=>{
        if(a['구분']!==b['구분']) return a['구분'].localeCompare(b['구분']);
        const ORDER = ['0~10대','20대','30대','40대','50대','60대','70대이상','전체'];
        return ORDER.indexOf(a['연령대']) - ORDER.indexOf(b['연령대']);
      });
      if(!result.length){ document.getElementById('output').innerHTML=''; return; }
      const desired = [
        '초진','초진주사','초진 주사처방률',
        '초진 주사 평균 횟수','초진 주사 평균 내원 횟수',
        '초진 주사 재진율',
        '(18세▲)초진','(18세▲)초진주사','(18세▲)초진주사처방률',
        '1회 주사 비율','2회 주사 비율','3회 주사 비율','4회 주사 비율',
        '5회 주사 비율','6회 주사 비율','7회 주사 비율','8회 이상 주사 비율',
        '특정 키워드 포함 메모 수'
      ];
      const cols = desired.filter(col => result.some(r => col in r));
      if(!cols.length){ document.getElementById('output').innerHTML=''; return; }
      const groupRows = {}; result.forEach(r => { groupRows[r['구분']] = (groupRows[r['구분']]||0)+1; });
      let html = '<table><thead><tr><th>진료실</th><th>연령대</th>'+cols.map(c=>`<th>${c}</th>`).join('')+'</tr></thead><tbody>';
      let prev=null;
      result.forEach(row=>{
        html+='<tr>';
        if(row['구분']!==prev){ html+=`<td rowspan="${groupRows[row['구분']]}">${row['구분']}</td>`; prev=row['구분']; }
        html+=`<td>${row['연령대']}</td>`;
        html+=cols.map(k=>`<td>${formatCell(row[k])}</td>`).join('');
        html+='</tr>';
      });
      html+='</tbody></table>';
      document.getElementById('output').innerHTML = html;
    }

    /* ================== 1회 주사자 리스트 계산/표시 ================== */
    let ONE_SHOT_LIST = []; // [{차트, 이름?, 전화, 진료실, 연령?, 성별?, 메모?}...]

    function detectPhoneColumn(headers){
      const lc = headers.map(h => String(h||'').toLowerCase());
      let idx = lc.findIndex(h => /(전화|휴대|핸드|연락|tel|phone)/.test(h));
      return idx >= 0 ? headers[idx] : null;
    }
    function detectNameColumn(headers){
      const lc = headers.map(h => String(h||'').toLowerCase());
      let idx = lc.findIndex(h => /(성명|이름|환자.?명|name)/.test(h));
      return idx >= 0 ? headers[idx] : null;
    }
    function cleanPhone(s){
      const t = String(s||'').replace(/[^0-9]/g,'');
      if(t.length===11) return t.replace(/(\\d{3})(\\d{4})(\\d{4})/,'$1-$2-$3');
      if(t.length===10) return t.replace(/(\\d{3})(\\d{3,4})(\\d{4})/,'$1-$2-$3');
      if(!t) return '';
      return t;
    }

    function buildOneShotList(df, col, roomValue){
      const firsts = df.filter(r => ['신환','90일초진'].includes(r[col['초재']]));
      const injFirsts = firsts.filter(r => (r[col['마취']]||'').includes('●'));
      const injCharts = [...new Set(injFirsts.map(r => r[col['차트']]))];
      const injRecords = df.filter(r => injCharts.includes(r[col['차트']]));
      const injCount = {};
      injRecords.forEach(r => {
        const id = r[col['차트']];
        if((r[col['마취']]||'').includes('●')) injCount[id] = (injCount[id]||0)+1;
      });

      const headers = Object.keys(df[0]||{});
      const phoneCol = detectPhoneColumn(headers);
      const nameCol = detectNameColumn(headers);

      const list = [];
      injCharts.forEach(id => {
        if((injCount[id]||0)===1){
          const row = injRecords.find(r => r[col['차트']]===(id)) || {};
          list.push({
            '차트번호': id,
            '이름': nameCol ? (row[nameCol]||'') : '',
            '전화': cleanPhone(phoneCol ? row[phoneCol] : ''),
            '진료실': roomValue || (row[col['과']]||''),
            '메모': (col['메모']? (row[col['메모']]||'') : '')
          });
        }
      });
      return list;
    }

    function renderOneShotTable(list){
      const card = document.getElementById('oneShotCard');
      const box = document.getElementById('oneShotTable');
      if(!list.length){ card.style.display='block'; box.innerHTML='<div class="warn">1회 주사만 한 차트를 찾지 못했습니다.</div>'; return; }
      const cols = ['차트번호','이름','전화','진료실','메모'];
      let thead = '<tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'</tr>';
      let tbody = list.map(r => '<tr>'+cols.map(c=>`<td style="text-align:center">${formatCell(r[c])}</td>`).join('')+'</tr>').join('');
      box.innerHTML = `<table><thead>${thead}</thead><tbody>${tbody}</tbody></table>`;
      card.style.display='block';
    }

    function downloadOneShotXlsx(){
      if(!ONE_SHOT_LIST.length){ alert('내려받을 데이터가 없습니다. 먼저 "1회 주사자 보기"를 눌러주세요.'); return; }
      const ws = XLSX.utils.json_to_sheet(ONE_SHOT_LIST);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, '1회주사자');
      XLSX.writeFile(wb, '비트_1회주사자_전화목록.xlsx');
    }

    document.getElementById('oneBtn').addEventListener('click', () => renderOneShotTable(ONE_SHOT_LIST));
    document.getElementById('oneDlBtn').addEventListener('click', downloadOneShotXlsx);
    document.getElementById('oneTopDl').addEventListener('click', downloadOneShotXlsx);

    /* ================= 본 계산 ================= */
    function parseData(data, keyword){
      document.getElementById('warning').innerText='';
      const headerIdx = findHeaderIndex(data);
      if(headerIdx===-1){ document.getElementById('warning').innerText='❗ 유효한 헤더를 찾을 수 없습니다.'; return; }

      const headers = data[headerIdx].map(h => String(h).trim());
      const body = data.slice(headerIdx+1).filter(r => r.length>1);
      const df = body.map(row => Object.fromEntries(headers.map((h,i)=>[h, row[i] ?? ''])));

      const result = [];
      const col = {};
      headers.forEach(h => {
        const l = h.toLowerCase();
        if (l.includes('초') && l.includes('재')) col['초재'] = h;
        else if (l.includes('차트') || l.includes('챠트') || l.includes('id')) col['차트'] = h;
        else if ((l.includes('진료') && l.includes('과')) || l.includes('과목')) col['과'] = h;
        else if (l.includes('마취')) col['마취'] = h;
        else if (l.includes('메모')) col['메모'] = h;
        else if (l.includes('나이') || l.includes('연령') || l.includes('생년') || l.includes('s/a')) col['연령'] = h;
      });

      function makeStat(rows, label, ageGroup='전체'){
        const 초진 = rows.filter(r => ['신환','90일초진'].includes(r[col['초재']]));
        const 초진차트 = [...new Set(초진.map(r => r[col['차트']]))];
        const 주사 = 초진.filter(r => (r[col['마취']]||'').includes('●'));
        const 주사차트 = [...new Set(주사.map(r => r[col['차트']]))];
        const 주사기록 = rows.filter(r => 주사차트.includes(r[col['차트']]));

        const 주사횟수={}, 내원횟수={};
        주사기록.forEach(r=>{
          const id=r[col['차트']];
          if((r[col['마취']]||'').includes('●')) 주사횟수[id]=(주사횟수[id]||0)+1;
          내원횟수[id]=(내원횟수[id]||0)+1;
        });
        const 평균주사 = Object.keys(주사횟수).length ? (Object.values(주사횟수).reduce((a,b)=>a+b,0)/Object.keys(주사횟수).length).toFixed(1) : 0;
        const 평균내원 = Object.keys(내원횟수).length ? (Object.values(내원횟수).reduce((a,b)=>a+b,0)/Object.keys(내원횟수).length).toFixed(1) : 0;
        const injRevisitRate = Object.keys(내원횟수).length ? Math.round((Object.values(내원횟수).filter(v=>v>=2).length/Object.keys(내원횟수).length)*100)+'%' : '-';

        const 초진기록 = rows.filter(r => 초진차트.includes(r[col['차트']]));
        const 초진내원={}; 초진기록.forEach(r=>{ const id=r[col['차트']]; 초진내원[id]=(초진내원[id]||0)+1; });
        const 평균초진내원 = Object.keys(초진내원).length ? (Object.values(초진내원).reduce((a,b)=>a+b,0)/Object.keys(초진내원).length).toFixed(1) : 0;
        const 재내원수 = Object.values(초진내원).filter(v=>v>=2).length;
        const visitRatio=(n,op='eq')=>{ const d=Object.keys(초진내원).length; if(!d) return 0; const arr=Object.values(초진내원); const num=op==='ge'?arr.filter(v=>v>=n).length:arr.filter(v=>v===n).length; return Math.round((num/d)*100); };
        const injRatio=(n,op='eq')=>{ const d=Object.keys(주사횟수).length; if(!d) return 0; const arr=Object.values(주사횟수); const num=op==='ge'?arr.filter(v=>v>=n).length:arr.filter(v=>v===n).length; return Math.round((num/d)*100); };

        let adultRows=[];
        if(col['연령']){
          adultRows = rows.filter(r=>{ const a=parseAge(r[col['연령']]); return a!==null && a>=18; });
        }
        const adultFirst = adultRows.filter(r => ['신환','90일초진'].includes(r[col['초재']]));
        const adultFirstCharts = [...new Set(adultFirst.map(r=>r[col['차트']]))];
        const adultInj = adultFirst.filter(r => (r[col['마취']]||'').includes('●'));
        const adultRate = adultFirstCharts.length ? Math.round((adultInj.length/adultFirstCharts.length)*100)+'%' : '-';

        const 키워드수 = col['메모'] && keyword ? rows.filter(r => (r[col['메모']]||'').toLowerCase().includes(keyword)).length : '';

        result.push({
          '구분':label,'연령대':ageGroup,
          '초진':초진차트.length,'초진주사':주사.length,
          '초진 주사 재진율':injRevisitRate,
          '초진 주사 평균 횟수':평균주사,'초진 주사 평균 내원 횟수':평균내원,
          '초진 주사처방률':`${초진차트.length ? Math.round((주사.length/초진차트.length)*100) : 0}%`,
          '(18세▲)초진':adultFirstCharts.length,'(18세▲)초진주사':adultInj.length,'(18세▲)초진주사처방률':adultRate,
          '초진 평균 내원횟수':평균초진내원,'초진 재내원율':`${초진차트.length?Math.round((재내원수/초진차트.length)*100):0}%`,
          '1회 내원 비율':`${visitRatio(1)}%`,'2회 내원 비율':`${visitRatio(2)}%`,'3회 내원 비율':`${visitRatio(3)}%`,'4회 내원 비율':`${visitRatio(4)}%`,
          '5회 내원 비율':`${visitRatio(5)}%`,'6회 내원 비율':`${visitRatio(6)}%`,'7회 내원 비율':`${visitRatio(7)}%`,'8회 이상 내원 비율':`${visitRatio(8,'ge')}%`,
          '1회 주사 비율':`${injRatio(1)}%`,'2회 주사 비율':`${injRatio(2)}%`,'3회 주사 비율':`${injRatio(3)}%`,'4회 주사 비율':`${injRatio(4)}%`,
          '5회 주사 비율':`${injRatio(5)}%`,'6회 주사 비율':`${injRatio(6)}%`,'7회 주사 비율':`${injRatio(7)}%`,'8회 이상 주사 비율':`${injRatio(8,'ge')}%`,
          '특정 키워드 포함 메모 수':키워드수
        });
      }

      const hasAge = !!col['연령'];
      const 전체 = df;
      if(hasAge){ AGE_ORDER.slice(0,-1).forEach(a=>makeStat(전체.filter(r=>getAgeGroup(r[col['연령']])===a),'전체',a)); }
      makeStat(전체,'전체','전체');

      const 진료과들 = [...new Set(df.map(r=> (r[col['과']]??'').toString().trim()).filter(Boolean))];
      ONE_SHOT_LIST = [];

      진료과들.forEach(과 => {
        const rows = df.filter(r => (r[col['과']]||'') === 과);
        if(hasAge){ AGE_ORDER.slice(0,-1).forEach(a=>makeStat(rows.filter(r=>getAgeGroup(r[col['연령']])===a), 과, a)); }
        makeStat(rows, 과, '전체');
        ONE_SHOT_LIST = ONE_SHOT_LIST.concat(buildOneShotList(rows, col, 과));
      });

      renderSummaryTable(result);
      renderAgeTable(result);

      const hasOne = ONE_SHOT_LIST.length > 0;
      document.getElementById('oneBtn').disabled = !hasOne;
      document.getElementById('oneDlBtn').disabled = !hasOne;
    }
  </script>
</body>
</html>
